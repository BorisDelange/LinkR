<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Aggregated data plugins • cdwtools</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Aggregated data plugins">
<meta property="og:description" content="cdwtools">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">cdwtools</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.0.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/cdwtools.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li class="divider">
    </li>
<li class="dropdown-header">FR - Aide</li>
    <li>
      <a href="../articles/FR_user_help.html">Aide aux utilisateurs</a>
    </li>
    <li>
      <a href="../articles/FR_developper_help.html">Aide aux développeurs</a>
    </li>
    <li>
      <a href="../articles/FR_use_case_mimic_iv.html">Application avec la MIMIC-IV</a>
    </li>
    <li>
      <a href="../articles/FR_deploy_shiny_proxy.html">Déployer avec ShinyProxy</a>
    </li>
    <li class="divider">
    </li>
<li class="dropdown-header">EN - Help</li>
    <li>
      <a href="../articles/EN_user_help.html">User help</a>
    </li>
    <li>
      <a href="../articles/EN_developper_help.html">Developper help</a>
    </li>
    <li>
      <a href="../articles/EN_use_case_mimic_iv.html">Use case with MIMIC-IV</a>
    </li>
    <li>
      <a href="../articles/EN_deploy_shiny_proxy.html">Deploy with ShinyProxy</a>
    </li>
    <li class="divider">
    </li>
<li class="dropdown-header">Plugins</li>
    <li>
      <a href="../articles/patient_lvl_data_plugins.html">Patient-level data plugins</a>
    </li>
    <li>
      <a href="../articles/aggregated_data_plugins.html">Aggregated data plugins</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/BorisDelange/cdwtools/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Aggregated data plugins</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/BorisDelange/cdwtools/blob/HEAD/vignettes/aggregated_data_plugins.Rmd" class="external-link"><code>vignettes/aggregated_data_plugins.Rmd</code></a></small>
      <div class="hidden name"><code>aggregated_data_plugins.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="exclusion-criteria-manager">Exclusion criteria manager<a class="anchor" aria-label="anchor" href="#exclusion-criteria-manager"></a>
</h2>
<div class="section level3">
<h3 id="description">Description<a class="anchor" aria-label="anchor" href="#description"></a>
</h3>
<ul>
<li>
<strong>Version</strong> : 0.0.1</li>
<li>
<strong>Libraries</strong> : none</li>
</ul>
</div>
<div class="section level3">
<h3 id="ui-code">UI code<a class="anchor" aria-label="anchor" href="#ui-code"></a>
</h3>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">temp</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span><span class="op">{</span>

    <span class="co"># Create our dictionnary</span>
    <span class="va">new_words</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html" class="external-link">tribble</a></span><span class="op">(</span><span class="op">~</span><span class="va">language</span>, <span class="op">~</span><span class="va">reference_word</span>, <span class="op">~</span><span class="va">translated_word</span>,
        <span class="st">"EN"</span>, <span class="st">"add_exclusion_criterion"</span>, <span class="st">"Add an exclusion criterion"</span>,
        <span class="st">"FR"</span>, <span class="st">"add_exclusion_criterion"</span>, <span class="st">"Ajouter un critère d'exclusion"</span>,
        <span class="st">"EN"</span>, <span class="st">"exclusion_criteria_management"</span>, <span class="st">"Exclusion criteria management"</span>,
        <span class="st">"FR"</span>, <span class="st">"exclusion_criteria_management"</span>, <span class="st">"Gestion des critères d'exclusion"</span>
    <span class="op">)</span>
    
    <span class="co"># Render UI</span>
    <span class="fu">div</span><span class="op">(</span>
        <span class="fu">shiny.fluent</span><span class="fu">::</span><span class="fu"><a href="https://appsilon.github.io/shiny.fluent/reference/Text.html" class="external-link">Text</a></span><span class="op">(</span>variant <span class="op">=</span> <span class="st">"large"</span>, <span class="fu"><a href="../reference/translate.html">translate</a></span><span class="op">(</span><span class="va">language</span>, <span class="st">"add_exclusion_criterion"</span>, <span class="va">new_words</span><span class="op">)</span>, block <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, <span class="fu">br</span><span class="op">(</span><span class="op">)</span>,
        <span class="fu">shiny.fluent</span><span class="fu">::</span><span class="fu"><a href="https://appsilon.github.io/shiny.fluent/reference/Stack.html" class="external-link">Stack</a></span><span class="op">(</span>horizontal <span class="op">=</span> <span class="cn">TRUE</span>, tokens <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>childrenGap <span class="op">=</span> <span class="fl">20</span><span class="op">)</span>,
            <span class="fu"><a href="../reference/make_textfield.html">make_textfield</a></span><span class="op">(</span>language <span class="op">=</span> <span class="va">language</span>, ns <span class="op">=</span> <span class="va">ns</span>, label <span class="op">=</span> <span class="st">"name"</span>, id <span class="op">=</span> <span class="st">"name_%group_id%_%study_id%"</span>, width <span class="op">=</span> <span class="st">"300px"</span><span class="op">)</span>,
            <span class="fu">div</span><span class="op">(</span><span class="fu">shiny.fluent</span><span class="fu">::</span><span class="fu"><a href="https://appsilon.github.io/shiny.fluent/reference/Button.html" class="external-link">PrimaryButton.shinyInput</a></span><span class="op">(</span><span class="fu">ns</span><span class="op">(</span><span class="st">"add_%group_id%_%study_id%"</span><span class="op">)</span>, <span class="fu"><a href="../reference/translate.html">translate</a></span><span class="op">(</span><span class="va">language</span>, <span class="st">"add"</span>, <span class="va">r</span><span class="op">$</span><span class="va">words</span><span class="op">)</span><span class="op">)</span>, style <span class="op">=</span> <span class="st">"margin-top:38px;"</span><span class="op">)</span>
        <span class="op">)</span>,
        <span class="fu">br</span><span class="op">(</span><span class="op">)</span>, <span class="fu">hr</span><span class="op">(</span><span class="op">)</span>,
        <span class="fu">shiny.fluent</span><span class="fu">::</span><span class="fu"><a href="https://appsilon.github.io/shiny.fluent/reference/Text.html" class="external-link">Text</a></span><span class="op">(</span>variant <span class="op">=</span> <span class="st">"large"</span>, <span class="fu"><a href="../reference/translate.html">translate</a></span><span class="op">(</span><span class="va">language</span>, <span class="st">"exclusion_criteria_management"</span>, <span class="va">new_words</span><span class="op">)</span>, block <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
        <span class="fu">div</span><span class="op">(</span>
            <span class="fu">DT</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/DT/man/dataTableOutput.html" class="external-link">DTOutput</a></span><span class="op">(</span><span class="fu">ns</span><span class="op">(</span><span class="st">"datatable_%group_id%_%study_id%"</span><span class="op">)</span><span class="op">)</span>,
            <span class="fu">shiny.fluent</span><span class="fu">::</span><span class="fu"><a href="https://appsilon.github.io/shiny.fluent/reference/Button.html" class="external-link">PrimaryButton.shinyInput</a></span><span class="op">(</span><span class="fu">ns</span><span class="op">(</span><span class="st">"save_%group_id%_%study_id%"</span><span class="op">)</span>, <span class="fu"><a href="../reference/translate.html">translate</a></span><span class="op">(</span><span class="va">language</span>, <span class="st">"save"</span>, <span class="va">r</span><span class="op">$</span><span class="va">words</span><span class="op">)</span><span class="op">)</span>
        <span class="op">)</span>
    <span class="op">)</span> <span class="op">-&gt;</span> <span class="va">result</span>
    
    <span class="va">result</span>
<span class="op">}</span>

<span class="fu">temp</span><span class="op">(</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="server-code">Server code<a class="anchor" aria-label="anchor" href="#server-code"></a>
</h3>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="do">##########################################</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Translations                           #</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="do">##########################################</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Create our dictionnary</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>new_words <span class="ot">&lt;-</span> tibble<span class="sc">::</span><span class="fu">tribble</span>(<span class="sc">~</span>language, <span class="sc">~</span>reference_word, <span class="sc">~</span>translated_word,</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"EN"</span>, <span class="st">"exclusion_criterion_added"</span>, <span class="st">"New exclusion criterion added"</span>,</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"FR"</span>, <span class="st">"exclusion_criterion_added"</span>, <span class="st">"Nouveau critère d'exclusion ajouté"</span>,</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"EN"</span>, <span class="st">"delete_exclusion_criterion"</span>, <span class="st">"Delete an exclusion criterion"</span>,</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"FR"</span>, <span class="st">"delete_exclusion_criterion"</span>, <span class="st">"Supprimer un critère d'exclusion"</span>,</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"EN"</span>, <span class="st">"delete_exclusion_criterion_subtext"</span>, <span class="st">"Are you sure you want to delete this exclusion criterion ?"</span>,</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"FR"</span>, <span class="st">"delete_exclusion_criterion_subtext"</span>, <span class="st">"Etes-vous sûr de vouloir supprimer ce critère d'exclusion ?"</span>,</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"EN"</span>, <span class="st">"exclusion_criterion_deleted"</span>, <span class="st">"Exclusion criterion deleted"</span>,</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"FR"</span>, <span class="st">"exclusion_criterion_deleted"</span>, <span class="st">"Critère d'exclusion supprimé"</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="do">##########################################</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Load current exclusion criteria        #</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a><span class="do">##########################################</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>plugins_load_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span> <span class="er">&lt;</span><span class="sc">-</span> <span class="cf">function</span>(r){</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load exclusion criteria</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>    sql <span class="ot">&lt;-</span> <span class="st">"SELECT id, value, creator_id, datetime FROM modules_elements_options WHERE deleted IS FALSE AND group_id = %group_id% AND study_id = %study_id% AND category = 'aggregated' AND name = 'exclusion_reason_name'"</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>    exclusion_criteria <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbGetQuery</span>(r<span class="sc">$</span>db, sql)</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load display orders</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>    sql <span class="ot">&lt;-</span> <span class="st">"SELECT link_id, value_num FROM modules_elements_options WHERE deleted IS FALSE AND group_id = %group_id% AND study_id = %study_id% AND category = 'aggregated' AND name = 'display_order'"</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>    display_orders <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbGetQuery</span>(r<span class="sc">$</span>db, sql) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="at">id =</span> link_id, <span class="at">display_order =</span> value_num)</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Merge the two tables</span></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Reset display_order column (if we have display orders 1, 2 &amp; 4 in database - if on criterion has been deleted - we will have 1, 2 &amp; 3)</span></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>    exclusion_criteria <span class="ot">&lt;-</span> exclusion_criteria <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">left_join</span>(display_orders, <span class="at">by =</span> <span class="st">"id"</span>) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">relocate</span>(display_order, <span class="at">.after =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">arrange</span>(display_order)</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get creator name</span></span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>    exclusion_criteria <span class="ot">&lt;-</span> </span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>        exclusion_criteria <span class="sc">%&gt;%</span> </span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>            <span class="fu">isolate</span>(r<span class="sc">$</span>users) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">transmute</span>(<span class="at">creator_id =</span> id, <span class="at">creator_name =</span> <span class="fu">paste0</span>(firstname, <span class="st">" "</span>, lastname)),</span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="st">"creator_id"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">relocate</span>(creator_name, <span class="at">.after =</span> <span class="st">"display_order"</span>) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>creator_id)</span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>    r<span class="sc">$</span>plugins_data_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span> <span class="er">&lt;</span><span class="sc">-</span> exclusion_criteria</span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>plugins_load_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span>(r)</span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a><span class="co"># Dropdowns observers already created</span></span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>r<span class="sc">$</span>plugins_dropdowns_observers_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span> <span class="er">&lt;</span><span class="sc">-</span> <span class="fu">integer</span>()</span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a><span class="do">##########################################</span></span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a><span class="co"># Add a new exclusion criterion          #</span></span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a><span class="do">##########################################</span></span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a><span class="fu">observeEvent</span>(input<span class="sc">$</span>add_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span>, {</span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tryCatch</span>({</span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a>        new_name <span class="ot">&lt;-</span> input<span class="sc">$</span>name_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span></span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">length</span>(new_name) <span class="sc">==</span> <span class="dv">0</span>) shiny.fluent<span class="sc">::</span><span class="fu">updateTextField.shinyInput</span>(session, <span class="st">"name_%group_id%_%study_id%"</span>, <span class="at">errorMessage =</span> <span class="fu">translate</span>(language, <span class="fu">paste0</span>(<span class="st">"provide_valid_name"</span>), r<span class="sc">$</span>words))</span>
<span id="cb2-62"><a href="#cb2-62" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span> shiny.fluent<span class="sc">::</span><span class="fu">updateTextField.shinyInput</span>(session, <span class="st">"name_%group_id%_%study_id%"</span>, <span class="at">errorMessage =</span> <span class="cn">NULL</span>)</span>
<span id="cb2-63"><a href="#cb2-63" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-64"><a href="#cb2-64" aria-hidden="true" tabindex="-1"></a>        <span class="fu">req</span>(<span class="fu">length</span>(new_name) <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb2-65"><a href="#cb2-65" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-66"><a href="#cb2-66" aria-hidden="true" tabindex="-1"></a>        sql <span class="ot">&lt;-</span> <span class="st">"SELECT DISTINCT(value) FROM modules_elements_options WHERE deleted IS FALSE AND group_id = %group_id% AND study_id = %study_id% AND name = 'exclusion_reason_name'"</span> </span>
<span id="cb2-67"><a href="#cb2-67" aria-hidden="true" tabindex="-1"></a>        distinct_values <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbGetQuery</span>(r<span class="sc">$</span>db, sql) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">pull</span>() <span class="sc">%&gt;%</span> <span class="fu">tolower</span>()</span>
<span id="cb2-68"><a href="#cb2-68" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb2-69"><a href="#cb2-69" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">tolower</span>(new_name) <span class="sc">%in%</span> distinct_values) <span class="fu">show_message_bar</span>(output, <span class="dv">2</span>, <span class="st">"name_already_used"</span>, <span class="st">"severeWarning"</span>, language)</span>
<span id="cb2-70"><a href="#cb2-70" aria-hidden="true" tabindex="-1"></a>        <span class="fu">req</span>(<span class="fu">tolower</span>(new_name) <span class="sc">%not_in%</span> distinct_values)</span>
<span id="cb2-71"><a href="#cb2-71" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-72"><a href="#cb2-72" aria-hidden="true" tabindex="-1"></a>        last_row <span class="ot">&lt;-</span> <span class="fu">get_last_row</span>(r<span class="sc">$</span>db, <span class="st">"modules_elements_options"</span>)</span>
<span id="cb2-73"><a href="#cb2-73" aria-hidden="true" tabindex="-1"></a>        datetime <span class="ot">&lt;-</span> <span class="fu">as.character</span>(<span class="fu">Sys.time</span>())</span>
<span id="cb2-74"><a href="#cb2-74" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-75"><a href="#cb2-75" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Insert new exclusion criterion in database</span></span>
<span id="cb2-76"><a href="#cb2-76" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-77"><a href="#cb2-77" aria-hidden="true" tabindex="-1"></a>        sql <span class="ot">&lt;-</span> glue<span class="sc">::</span><span class="fu">glue_sql</span>(<span class="st">"INSERT INTO modules_elements_options(id, group_id, study_id, category, name, value, creator_id, datetime, deleted)</span></span>
<span id="cb2-78"><a href="#cb2-78" aria-hidden="true" tabindex="-1"></a><span class="st">            SELECT {last_row + 1}, %group_id%, %study_id%, 'aggregated', 'exclusion_reason_name', {new_name}, {r$user_id}, {datetime}, FALSE"</span>, <span class="at">.con =</span> r<span class="sc">$</span>db)</span>
<span id="cb2-79"><a href="#cb2-79" aria-hidden="true" tabindex="-1"></a>        query <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbSendStatement</span>(r<span class="sc">$</span>db, sql)</span>
<span id="cb2-80"><a href="#cb2-80" aria-hidden="true" tabindex="-1"></a>        DBI<span class="sc">::</span><span class="fu">dbClearResult</span>(query)</span>
<span id="cb2-81"><a href="#cb2-81" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-82"><a href="#cb2-82" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Insert also its display order</span></span>
<span id="cb2-83"><a href="#cb2-83" aria-hidden="true" tabindex="-1"></a>        sql <span class="ot">&lt;-</span> glue<span class="sc">::</span><span class="fu">glue_sql</span>(<span class="fu">paste0</span>(<span class="st">"SELECT COALESCE(MAX(value_num), 0) FROM modules_elements_options WHERE deleted IS FALSE AND group_id = %group_id% AND study_id = %study_id%"</span>,</span>
<span id="cb2-84"><a href="#cb2-84" aria-hidden="true" tabindex="-1"></a>            <span class="st">" AND category = 'aggregated' AND name = 'display_order'"</span>), <span class="at">.con =</span> r<span class="sc">$</span>db)</span>
<span id="cb2-85"><a href="#cb2-85" aria-hidden="true" tabindex="-1"></a>        last_display_order <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbGetQuery</span>(r<span class="sc">$</span>db, sql) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">pull</span>()</span>
<span id="cb2-86"><a href="#cb2-86" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-87"><a href="#cb2-87" aria-hidden="true" tabindex="-1"></a>        sql <span class="ot">&lt;-</span> glue<span class="sc">::</span><span class="fu">glue_sql</span>(<span class="st">"INSERT INTO modules_elements_options(id, group_id, study_id, link_id, category, name, value_num, creator_id, datetime, deleted)</span></span>
<span id="cb2-88"><a href="#cb2-88" aria-hidden="true" tabindex="-1"></a><span class="st">            SELECT {last_row + 2}, %group_id%, %study_id%, {last_row + 1}, 'aggregated', 'display_order', {last_display_order + 1}, {r$user_id}, {datetime}, FALSE"</span>, <span class="at">.con =</span> r<span class="sc">$</span>db)</span>
<span id="cb2-89"><a href="#cb2-89" aria-hidden="true" tabindex="-1"></a>        query <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbSendStatement</span>(r<span class="sc">$</span>db, sql)</span>
<span id="cb2-90"><a href="#cb2-90" aria-hidden="true" tabindex="-1"></a>        DBI<span class="sc">::</span><span class="fu">dbClearResult</span>(query)</span>
<span id="cb2-91"><a href="#cb2-91" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-92"><a href="#cb2-92" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Reload data</span></span>
<span id="cb2-93"><a href="#cb2-93" aria-hidden="true" tabindex="-1"></a>        plugins_load_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span>(r)</span>
<span id="cb2-94"><a href="#cb2-94" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-95"><a href="#cb2-95" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Reset textfield</span></span>
<span id="cb2-96"><a href="#cb2-96" aria-hidden="true" tabindex="-1"></a>        shiny.fluent<span class="sc">::</span><span class="fu">updateTextField.shinyInput</span>(session, <span class="st">"name_%group_id%_%study_id%"</span>, <span class="at">value =</span> <span class="cn">NULL</span>)</span>
<span id="cb2-97"><a href="#cb2-97" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-98"><a href="#cb2-98" aria-hidden="true" tabindex="-1"></a>        <span class="fu">show_message_bar</span>(output, <span class="dv">1</span>, <span class="fu">translate</span>(language, <span class="st">"exclusion_criterion_added"</span>, new_words), <span class="st">"success"</span>, language)</span>
<span id="cb2-99"><a href="#cb2-99" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-100"><a href="#cb2-100" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Send a message to flowchart's plugin, to reload data</span></span>
<span id="cb2-101"><a href="#cb2-101" aria-hidden="true" tabindex="-1"></a>        r<span class="sc">$</span>reload_flowchart_<span class="sc">%study_id%</span> <span class="er">&lt;</span><span class="sc">-</span> <span class="cn">TRUE</span></span>
<span id="cb2-102"><a href="#cb2-102" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-103"><a href="#cb2-103" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb2-104"><a href="#cb2-104" aria-hidden="true" tabindex="-1"></a>    <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cf">if</span> (<span class="fu">nchar</span>(e[<span class="dv">1</span>]) <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="fu">report_bug</span>(<span class="at">r =</span> r, <span class="at">output =</span> output, <span class="at">error_message =</span> <span class="st">"error_run_plugin_server_code"</span>, </span>
<span id="cb2-105"><a href="#cb2-105" aria-hidden="true" tabindex="-1"></a>      <span class="at">error_name =</span> <span class="st">"%group_id% - run server code"</span>, <span class="at">category =</span> <span class="st">"Error"</span>, <span class="at">error_report =</span> <span class="fu">toString</span>(e), <span class="at">language =</span> language),</span>
<span id="cb2-106"><a href="#cb2-106" aria-hidden="true" tabindex="-1"></a>    <span class="at">warning =</span> <span class="cf">function</span>(w) <span class="cf">if</span> (<span class="fu">nchar</span>(w[<span class="dv">1</span>]) <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="fu">report_bug</span>(<span class="at">r =</span> r, <span class="at">output =</span> output, <span class="at">error_message =</span> <span class="st">"error_run_plugin_server_code"</span>, </span>
<span id="cb2-107"><a href="#cb2-107" aria-hidden="true" tabindex="-1"></a>      <span class="at">error_name =</span> <span class="st">"%group_id% - run server code"</span>, <span class="at">category =</span> <span class="st">"Warning"</span>, <span class="at">error_report =</span> <span class="fu">toString</span>(w), <span class="at">language =</span> language))</span>
<span id="cb2-108"><a href="#cb2-108" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb2-109"><a href="#cb2-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-110"><a href="#cb2-110" aria-hidden="true" tabindex="-1"></a><span class="do">##########################################</span></span>
<span id="cb2-111"><a href="#cb2-111" aria-hidden="true" tabindex="-1"></a><span class="co"># Management datatable                   #</span></span>
<span id="cb2-112"><a href="#cb2-112" aria-hidden="true" tabindex="-1"></a><span class="do">##########################################</span></span>
<span id="cb2-113"><a href="#cb2-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-114"><a href="#cb2-114" aria-hidden="true" tabindex="-1"></a>col_names <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Name"</span>, <span class="st">"Display order"</span>, <span class="st">"Creator"</span>, <span class="st">"Datetime"</span>, <span class="st">"Action"</span>)</span>
<span id="cb2-115"><a href="#cb2-115" aria-hidden="true" tabindex="-1"></a>sortable_cols <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"value"</span>, <span class="st">"display_order"</span>, <span class="st">"creator_name"</span>, <span class="st">"datetime"</span>)</span>
<span id="cb2-116"><a href="#cb2-116" aria-hidden="true" tabindex="-1"></a>centered_cols <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"datetime"</span>, <span class="st">"display_order"</span>, <span class="st">"action"</span>, <span class="st">"creator_name"</span>)</span>
<span id="cb2-117"><a href="#cb2-117" aria-hidden="true" tabindex="-1"></a>column_widths <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"datetime"</span> <span class="ot">=</span> <span class="st">"180px"</span>, <span class="st">"action"</span> <span class="ot">=</span> <span class="st">"80px"</span>, <span class="st">"display_order"</span> <span class="ot">=</span> <span class="st">"100px"</span>, <span class="st">"creator_name"</span> <span class="ot">=</span> <span class="st">"100px"</span>, <span class="st">"name"</span> <span class="ot">=</span> <span class="st">"400px"</span>)</span>
<span id="cb2-118"><a href="#cb2-118" aria-hidden="true" tabindex="-1"></a>searchable_cols <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"value"</span>, <span class="st">"datetime"</span>, <span class="st">"creator_name"</span>)</span>
<span id="cb2-119"><a href="#cb2-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-120"><a href="#cb2-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-121"><a href="#cb2-121" aria-hidden="true" tabindex="-1"></a><span class="fu">observeEvent</span>(r<span class="sc">$</span>plugins_data_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span>, {</span>
<span id="cb2-122"><a href="#cb2-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-123"><a href="#cb2-123" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tryCatch</span>({</span>
<span id="cb2-124"><a href="#cb2-124" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-125"><a href="#cb2-125" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get page_id for dropdowns &amp; delete button</span></span>
<span id="cb2-126"><a href="#cb2-126" aria-hidden="true" tabindex="-1"></a>        page_id <span class="ot">&lt;-</span> id</span>
<span id="cb2-127"><a href="#cb2-127" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-128"><a href="#cb2-128" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add dropdown for display order &amp; delete buttons</span></span>
<span id="cb2-129"><a href="#cb2-129" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-130"><a href="#cb2-130" aria-hidden="true" tabindex="-1"></a>        options <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb2-131"><a href="#cb2-131" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">nrow</span>(r<span class="sc">$</span>plugins_data_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span>) <span class="sc">&gt;</span> <span class="dv">0</span>){</span>
<span id="cb2-132"><a href="#cb2-132" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb2-133"><a href="#cb2-133" aria-hidden="true" tabindex="-1"></a>            options <span class="ot">&lt;-</span> <span class="fu">convert_tibble_to_list</span>(<span class="at">data =</span> r<span class="sc">$</span>plugins_data_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span> <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">n =</span> <span class="dv">1</span><span class="sc">:</span>dplyr<span class="sc">::</span><span class="fu">n</span>()), <span class="at">key_col =</span> <span class="st">"n"</span>, <span class="at">text_col =</span> <span class="st">"n"</span>)</span>
<span id="cb2-134"><a href="#cb2-134" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb2-135"><a href="#cb2-135" aria-hidden="true" tabindex="-1"></a>            <span class="co"># If this is not an update of the dropdowns</span></span>
<span id="cb2-136"><a href="#cb2-136" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb2-137"><a href="#cb2-137" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (<span class="fu">length</span>(<span class="fu">unique</span>(r<span class="sc">$</span>plugins_data_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span><span class="er">$</span>display_order)) <span class="sc">==</span> <span class="fu">nrow</span>(r<span class="sc">$</span>plugins_data_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span>)){</span>
<span id="cb2-138"><a href="#cb2-138" aria-hidden="true" tabindex="-1"></a>                r<span class="sc">$</span>plugins_data_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span> <span class="er">&lt;</span><span class="sc">-</span> r<span class="sc">$</span>plugins_data_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span> <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">arrange</span>(display_order) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">n =</span> <span class="dv">1</span><span class="sc">:</span>dplyr<span class="sc">::</span><span class="fu">n</span>())} </span>
<span id="cb2-139"><a href="#cb2-139" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span> r<span class="sc">$</span>plugins_data_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span> <span class="er">&lt;</span><span class="sc">-</span> r<span class="sc">$</span>plugins_data_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span> <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">n =</span> display_order)</span>
<span id="cb2-140"><a href="#cb2-140" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb2-141"><a href="#cb2-141" aria-hidden="true" tabindex="-1"></a>            data_temp <span class="ot">&lt;-</span> r<span class="sc">$</span>plugins_data_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span> <span class="sc">%&gt;%</span></span>
<span id="cb2-142"><a href="#cb2-142" aria-hidden="true" tabindex="-1"></a>                dplyr<span class="sc">::</span><span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb2-143"><a href="#cb2-143" aria-hidden="true" tabindex="-1"></a>                dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb2-144"><a href="#cb2-144" aria-hidden="true" tabindex="-1"></a>                    <span class="at">display_order =</span> <span class="fu">as.character</span>(</span>
<span id="cb2-145"><a href="#cb2-145" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">div</span>(</span>
<span id="cb2-146"><a href="#cb2-146" aria-hidden="true" tabindex="-1"></a>                            shiny.fluent<span class="sc">::</span><span class="fu">Dropdown.shinyInput</span>(<span class="fu">ns</span>(<span class="fu">paste0</span>(<span class="st">"dropdown_%group_id%_%study_id%_"</span>, id)),</span>
<span id="cb2-147"><a href="#cb2-147" aria-hidden="true" tabindex="-1"></a>                                <span class="at">options =</span> options, <span class="at">value =</span> <span class="fu">as.integer</span>(n),</span>
<span id="cb2-148"><a href="#cb2-148" aria-hidden="true" tabindex="-1"></a>                                <span class="at">onclick =</span> <span class="fu">paste0</span>(<span class="st">"Shiny.setInputValue('"</span>, page_id, <span class="st">"-dropdown_updated', '"</span>, <span class="fu">paste0</span>(<span class="st">"dropdown_%group_id%_%study_id%_value_"</span>, id), <span class="st">"', {priority: 'event'})"</span>),</span>
<span id="cb2-149"><a href="#cb2-149" aria-hidden="true" tabindex="-1"></a>                                <span class="at">style =</span> <span class="st">"width:120px;"</span></span>
<span id="cb2-150"><a href="#cb2-150" aria-hidden="true" tabindex="-1"></a>                            )</span>
<span id="cb2-151"><a href="#cb2-151" aria-hidden="true" tabindex="-1"></a>                        )</span>
<span id="cb2-152"><a href="#cb2-152" aria-hidden="true" tabindex="-1"></a>                    ),</span>
<span id="cb2-153"><a href="#cb2-153" aria-hidden="true" tabindex="-1"></a>                    <span class="at">action =</span> <span class="fu">as.character</span>(</span>
<span id="cb2-154"><a href="#cb2-154" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">div</span>(</span>
<span id="cb2-155"><a href="#cb2-155" aria-hidden="true" tabindex="-1"></a>                            shiny<span class="sc">::</span><span class="fu">actionButton</span>(<span class="fu">ns</span>(<span class="fu">paste0</span>(<span class="st">"delete_%group_id%_%study_id%_"</span>, id)), <span class="st">""</span>, <span class="at">icon =</span> <span class="fu">icon</span>(<span class="st">"trash-alt"</span>),</span>
<span id="cb2-156"><a href="#cb2-156" aria-hidden="true" tabindex="-1"></a>                            <span class="at">onclick =</span> <span class="fu">paste0</span>(<span class="st">"Shiny.setInputValue('"</span>, page_id, <span class="st">"-deleted_pressed_%group_id%_%study_id%', this.id, {priority: 'event'})"</span>))</span>
<span id="cb2-157"><a href="#cb2-157" aria-hidden="true" tabindex="-1"></a>                        )</span>
<span id="cb2-158"><a href="#cb2-158" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb2-159"><a href="#cb2-159" aria-hidden="true" tabindex="-1"></a>                ) <span class="sc">%&gt;%</span></span>
<span id="cb2-160"><a href="#cb2-160" aria-hidden="true" tabindex="-1"></a>                dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>id, <span class="sc">-</span>n)</span>
<span id="cb2-161"><a href="#cb2-161" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb2-162"><a href="#cb2-162" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span> data_temp <span class="ot">&lt;-</span> tibble<span class="sc">::</span><span class="fu">tibble</span>()</span>
<span id="cb2-163"><a href="#cb2-163" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-164"><a href="#cb2-164" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Render datatable</span></span>
<span id="cb2-165"><a href="#cb2-165" aria-hidden="true" tabindex="-1"></a>        <span class="fu">render_datatable</span>(</span>
<span id="cb2-166"><a href="#cb2-166" aria-hidden="true" tabindex="-1"></a>            <span class="at">data =</span> data_temp,</span>
<span id="cb2-167"><a href="#cb2-167" aria-hidden="true" tabindex="-1"></a>            <span class="at">output =</span> output,</span>
<span id="cb2-168"><a href="#cb2-168" aria-hidden="true" tabindex="-1"></a>            <span class="at">r =</span> r,</span>
<span id="cb2-169"><a href="#cb2-169" aria-hidden="true" tabindex="-1"></a>            <span class="at">ns =</span> ns,</span>
<span id="cb2-170"><a href="#cb2-170" aria-hidden="true" tabindex="-1"></a>            <span class="at">language =</span> language,</span>
<span id="cb2-171"><a href="#cb2-171" aria-hidden="true" tabindex="-1"></a>            <span class="at">output_name =</span> <span class="st">"datatable_%group_id%_%study_id%"</span>,</span>
<span id="cb2-172"><a href="#cb2-172" aria-hidden="true" tabindex="-1"></a>            <span class="at">col_names =</span> col_names,</span>
<span id="cb2-173"><a href="#cb2-173" aria-hidden="true" tabindex="-1"></a>            <span class="at">page_length =</span> <span class="dv">20</span>,</span>
<span id="cb2-174"><a href="#cb2-174" aria-hidden="true" tabindex="-1"></a>            <span class="at">sortable_cols =</span> sortable_cols,</span>
<span id="cb2-175"><a href="#cb2-175" aria-hidden="true" tabindex="-1"></a>            <span class="at">centered_cols =</span> centered_cols,</span>
<span id="cb2-176"><a href="#cb2-176" aria-hidden="true" tabindex="-1"></a>            <span class="at">column_widths =</span> column_widths,</span>
<span id="cb2-177"><a href="#cb2-177" aria-hidden="true" tabindex="-1"></a>            <span class="at">filter =</span> <span class="cn">TRUE</span>,</span>
<span id="cb2-178"><a href="#cb2-178" aria-hidden="true" tabindex="-1"></a>            <span class="at">searchable_cols =</span> searchable_cols</span>
<span id="cb2-179"><a href="#cb2-179" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb2-180"><a href="#cb2-180" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-181"><a href="#cb2-181" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Make an observer by dropdown</span></span>
<span id="cb2-182"><a href="#cb2-182" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sapply</span>(r<span class="sc">$</span>plugins_data_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span> <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">pull</span>(id), <span class="cf">function</span>(id){</span>
<span id="cb2-183"><a href="#cb2-183" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-184"><a href="#cb2-184" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (id <span class="sc">%not_in%</span> r<span class="sc">$</span>plugins_dropdowns_observers_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span>){</span>
<span id="cb2-185"><a href="#cb2-185" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-186"><a href="#cb2-186" aria-hidden="true" tabindex="-1"></a>                <span class="fu">observeEvent</span>(input[[<span class="fu">paste0</span>(<span class="st">"dropdown_%group_id%_%study_id%_"</span>, id)]], {</span>
<span id="cb2-187"><a href="#cb2-187" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb2-188"><a href="#cb2-188" aria-hidden="true" tabindex="-1"></a>                    new_value <span class="ot">&lt;-</span> input[[<span class="fu">paste0</span>(<span class="st">"dropdown_%group_id%_%study_id%_"</span>, id)]]</span>
<span id="cb2-189"><a href="#cb2-189" aria-hidden="true" tabindex="-1"></a>                    old_value <span class="ot">&lt;-</span> r<span class="sc">$</span>plugins_data_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span>[[<span class="fu">which</span>(r<span class="sc">$</span>plugins_data_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span>[<span class="st">"id"</span>] <span class="sc">==</span> id), <span class="st">"display_order"</span>]]</span>
<span id="cb2-190"><a href="#cb2-190" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb2-191"><a href="#cb2-191" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># If value is changed</span></span>
<span id="cb2-192"><a href="#cb2-192" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> (old_value <span class="sc">!=</span> new_value){</span>
<span id="cb2-193"><a href="#cb2-193" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb2-194"><a href="#cb2-194" aria-hidden="true" tabindex="-1"></a>                        r<span class="sc">$</span>plugins_data_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span>[[<span class="fu">which</span>(r<span class="sc">$</span>plugins_data_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span>[<span class="st">"id"</span>] <span class="sc">==</span> id), <span class="st">"display_order"</span>]] <span class="ot">&lt;-</span> new_value</span>
<span id="cb2-195"><a href="#cb2-195" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb2-196"><a href="#cb2-196" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> (new_value <span class="sc">&gt;</span> old_value){</span>
<span id="cb2-197"><a href="#cb2-197" aria-hidden="true" tabindex="-1"></a>                            ids <span class="ot">&lt;-</span> r<span class="sc">$</span>plugins_data_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span> <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(display_order <span class="sc">&gt;=</span> old_value <span class="sc">&amp;</span> display_order <span class="sc">&lt;=</span> new_value <span class="sc">&amp;</span> id <span class="sc">!=</span> <span class="sc">!!</span>id) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">pull</span>(id)</span>
<span id="cb2-198"><a href="#cb2-198" aria-hidden="true" tabindex="-1"></a>                            adding <span class="ot">&lt;-</span> <span class="sc">-</span>1L</span>
<span id="cb2-199"><a href="#cb2-199" aria-hidden="true" tabindex="-1"></a>                        }</span>
<span id="cb2-200"><a href="#cb2-200" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> (new_value <span class="sc">&lt;</span> old_value){</span>
<span id="cb2-201"><a href="#cb2-201" aria-hidden="true" tabindex="-1"></a>                            ids <span class="ot">&lt;-</span> r<span class="sc">$</span>plugins_data_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span> <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(display_order <span class="sc">&gt;=</span> new_value <span class="sc">&amp;</span> display_order <span class="sc">&lt;=</span> old_value <span class="sc">&amp;</span> id <span class="sc">!=</span> <span class="sc">!!</span>id) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">pull</span>(id)</span>
<span id="cb2-202"><a href="#cb2-202" aria-hidden="true" tabindex="-1"></a>                            adding <span class="ot">&lt;-</span> 1L</span>
<span id="cb2-203"><a href="#cb2-203" aria-hidden="true" tabindex="-1"></a>                        } </span>
<span id="cb2-204"><a href="#cb2-204" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb2-205"><a href="#cb2-205" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># For each row to update, change value in r variable &amp; update dropdown</span></span>
<span id="cb2-206"><a href="#cb2-206" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">sapply</span>(ids, <span class="cf">function</span>(id_bis){</span>
<span id="cb2-207"><a href="#cb2-207" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb2-208"><a href="#cb2-208" aria-hidden="true" tabindex="-1"></a>                            display_order <span class="ot">&lt;-</span> r<span class="sc">$</span>plugins_data_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span>[[<span class="fu">which</span>(r<span class="sc">$</span>plugins_data_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span>[<span class="st">"id"</span>] <span class="sc">==</span> id_bis), <span class="st">"display_order"</span>]]</span>
<span id="cb2-209"><a href="#cb2-209" aria-hidden="true" tabindex="-1"></a>                            r<span class="sc">$</span>plugins_data_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span>[[<span class="fu">which</span>(r<span class="sc">$</span>plugins_data_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span>[<span class="st">"id"</span>] <span class="sc">==</span> id_bis), <span class="st">"display_order"</span>]] <span class="ot">&lt;-</span> display_order <span class="sc">+</span> adding</span>
<span id="cb2-210"><a href="#cb2-210" aria-hidden="true" tabindex="-1"></a>                            shiny.fluent<span class="sc">::</span><span class="fu">updateDropdown.shinyInput</span>(session, <span class="fu">paste0</span>(<span class="st">"dropdown_%group_id%_%study_id%_"</span>, id_bis), <span class="at">value =</span> display_order <span class="sc">+</span> adding)</span>
<span id="cb2-211"><a href="#cb2-211" aria-hidden="true" tabindex="-1"></a>                        })</span>
<span id="cb2-212"><a href="#cb2-212" aria-hidden="true" tabindex="-1"></a>                    }</span>
<span id="cb2-213"><a href="#cb2-213" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb2-214"><a href="#cb2-214" aria-hidden="true" tabindex="-1"></a>                }, <span class="at">ignoreInit =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-215"><a href="#cb2-215" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb2-216"><a href="#cb2-216" aria-hidden="true" tabindex="-1"></a>                r<span class="sc">$</span>plugins_dropdowns_observers_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span> <span class="er">&lt;</span><span class="sc">-</span> <span class="fu">c</span>(r<span class="sc">$</span>plugins_dropdowns_observers_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span>, id)</span>
<span id="cb2-217"><a href="#cb2-217" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb2-218"><a href="#cb2-218" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb2-219"><a href="#cb2-219" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb2-220"><a href="#cb2-220" aria-hidden="true" tabindex="-1"></a>    <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cf">if</span> (<span class="fu">nchar</span>(e[<span class="dv">1</span>]) <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="fu">report_bug</span>(<span class="at">r =</span> r, <span class="at">output =</span> output, <span class="at">error_message =</span> <span class="st">"error_run_plugin_server_code"</span>, </span>
<span id="cb2-221"><a href="#cb2-221" aria-hidden="true" tabindex="-1"></a>      <span class="at">error_name =</span> <span class="st">"%group_id% - run server code"</span>, <span class="at">category =</span> <span class="st">"Error"</span>, <span class="at">error_report =</span> <span class="fu">toString</span>(e), <span class="at">language =</span> language),</span>
<span id="cb2-222"><a href="#cb2-222" aria-hidden="true" tabindex="-1"></a>    <span class="at">warning =</span> <span class="cf">function</span>(w) <span class="cf">if</span> (<span class="fu">nchar</span>(w[<span class="dv">1</span>]) <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="fu">report_bug</span>(<span class="at">r =</span> r, <span class="at">output =</span> output, <span class="at">error_message =</span> <span class="st">"error_run_plugin_server_code"</span>, </span>
<span id="cb2-223"><a href="#cb2-223" aria-hidden="true" tabindex="-1"></a>      <span class="at">error_name =</span> <span class="st">"%group_id% - run server code"</span>, <span class="at">category =</span> <span class="st">"Warning"</span>, <span class="at">error_report =</span> <span class="fu">toString</span>(w), <span class="at">language =</span> language))</span>
<span id="cb2-224"><a href="#cb2-224" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb2-225"><a href="#cb2-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-226"><a href="#cb2-226" aria-hidden="true" tabindex="-1"></a><span class="do">##########################################</span></span>
<span id="cb2-227"><a href="#cb2-227" aria-hidden="true" tabindex="-1"></a><span class="co"># Change display order                   #</span></span>
<span id="cb2-228"><a href="#cb2-228" aria-hidden="true" tabindex="-1"></a><span class="do">##########################################</span></span>
<span id="cb2-229"><a href="#cb2-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-230"><a href="#cb2-230" aria-hidden="true" tabindex="-1"></a><span class="fu">observeEvent</span>(input<span class="sc">$</span>save_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span>, {</span>
<span id="cb2-231"><a href="#cb2-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-232"><a href="#cb2-232" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tryCatch</span>({</span>
<span id="cb2-233"><a href="#cb2-233" aria-hidden="true" tabindex="-1"></a>        duplicates_display_order <span class="ot">&lt;-</span> r<span class="sc">$</span>plugins_data_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span> <span class="sc">%&gt;%</span> </span>
<span id="cb2-234"><a href="#cb2-234" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">group_by</span>(display_order) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">summarize</span>(<span class="at">n =</span> dplyr<span class="sc">::</span><span class="fu">n</span>()) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(n <span class="sc">&gt;</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> <span class="fu">nrow</span>()</span>
<span id="cb2-235"><a href="#cb2-235" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb2-236"><a href="#cb2-236" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (duplicates_display_order <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="fu">show_message_bar</span>(output, <span class="dv">1</span>, <span class="st">"modif_display_order_duplicates"</span>, <span class="st">"severeWarning"</span>, language)</span>
<span id="cb2-237"><a href="#cb2-237" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-238"><a href="#cb2-238" aria-hidden="true" tabindex="-1"></a>        <span class="fu">req</span>(duplicates_display_order <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb2-239"><a href="#cb2-239" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-240"><a href="#cb2-240" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Delete data from table</span></span>
<span id="cb2-241"><a href="#cb2-241" aria-hidden="true" tabindex="-1"></a>        ids_to_del <span class="ot">&lt;-</span> r<span class="sc">$</span>plugins_data_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span> <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">pull</span>(id)</span>
<span id="cb2-242"><a href="#cb2-242" aria-hidden="true" tabindex="-1"></a>        DBI<span class="sc">::</span><span class="fu">dbSendStatement</span>(r<span class="sc">$</span>db, <span class="fu">paste0</span>(<span class="st">"DELETE FROM modules_elements_options WHERE link_id IN ("</span>, <span class="fu">paste</span>(ids_to_del, <span class="at">collapse =</span> <span class="st">","</span>), <span class="st">")"</span>)) <span class="ot">-&gt;</span> query</span>
<span id="cb2-243"><a href="#cb2-243" aria-hidden="true" tabindex="-1"></a>        DBI<span class="sc">::</span><span class="fu">dbClearResult</span>(query)</span>
<span id="cb2-244"><a href="#cb2-244" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-245"><a href="#cb2-245" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Append data to table</span></span>
<span id="cb2-246"><a href="#cb2-246" aria-hidden="true" tabindex="-1"></a>        last_row <span class="ot">&lt;-</span> <span class="fu">get_last_row</span>(r<span class="sc">$</span>db, <span class="st">"modules_elements_options"</span>)</span>
<span id="cb2-247"><a href="#cb2-247" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-248"><a href="#cb2-248" aria-hidden="true" tabindex="-1"></a>        new_data <span class="ot">&lt;-</span> r<span class="sc">$</span>plugins_data_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span> <span class="sc">%&gt;%</span></span>
<span id="cb2-249"><a href="#cb2-249" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">transmute</span>(<span class="at">group_id =</span> <span class="sc">%group_id%</span>, <span class="at">study_id =</span> <span class="sc">%study_id%</span>, <span class="at">patient_id =</span> <span class="cn">NA_integer_</span>, <span class="at">link_id =</span> id, <span class="at">category =</span> <span class="st">"aggregated"</span>, <span class="at">name =</span> <span class="st">"display_order"</span>, </span>
<span id="cb2-250"><a href="#cb2-250" aria-hidden="true" tabindex="-1"></a>                <span class="at">value =</span> <span class="cn">NA_character_</span>, <span class="at">value_num =</span> display_order, <span class="at">creator_id =</span> r<span class="sc">$</span>user_id, datetime, <span class="at">deleted =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb2-251"><a href="#cb2-251" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">mutate</span>(id) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">relocate</span>(id)</span>
<span id="cb2-252"><a href="#cb2-252" aria-hidden="true" tabindex="-1"></a>        new_data<span class="sc">$</span>id <span class="ot">&lt;-</span> <span class="fu">seq.int</span>(<span class="fu">nrow</span>(new_data)) <span class="sc">+</span> last_row</span>
<span id="cb2-253"><a href="#cb2-253" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-254"><a href="#cb2-254" aria-hidden="true" tabindex="-1"></a>        DBI<span class="sc">::</span><span class="fu">dbAppendTable</span>(r<span class="sc">$</span>db, <span class="st">"modules_elements_options"</span>, new_data)</span>
<span id="cb2-255"><a href="#cb2-255" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-256"><a href="#cb2-256" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Notification to the user</span></span>
<span id="cb2-257"><a href="#cb2-257" aria-hidden="true" tabindex="-1"></a>        <span class="fu">show_message_bar</span>(output, <span class="dv">2</span>, <span class="st">"modif_saved"</span>, <span class="st">"success"</span>, language)</span>
<span id="cb2-258"><a href="#cb2-258" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-259"><a href="#cb2-259" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Send a message to flowchart's plugin, to reload data</span></span>
<span id="cb2-260"><a href="#cb2-260" aria-hidden="true" tabindex="-1"></a>        r<span class="sc">$</span>reload_flowchart_<span class="sc">%study_id%</span> <span class="er">&lt;</span><span class="sc">-</span> <span class="cn">TRUE</span></span>
<span id="cb2-261"><a href="#cb2-261" aria-hidden="true" tabindex="-1"></a>    }, </span>
<span id="cb2-262"><a href="#cb2-262" aria-hidden="true" tabindex="-1"></a>    <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cf">if</span> (<span class="fu">nchar</span>(e[<span class="dv">1</span>]) <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="fu">report_bug</span>(<span class="at">r =</span> r, <span class="at">output =</span> output, <span class="at">error_message =</span> <span class="st">"error_run_plugin_server_code"</span>, </span>
<span id="cb2-263"><a href="#cb2-263" aria-hidden="true" tabindex="-1"></a>      <span class="at">error_name =</span> <span class="st">"%group_id% - run server code"</span>, <span class="at">category =</span> <span class="st">"Error"</span>, <span class="at">error_report =</span> <span class="fu">toString</span>(e), <span class="at">language =</span> language),</span>
<span id="cb2-264"><a href="#cb2-264" aria-hidden="true" tabindex="-1"></a>    <span class="at">warning =</span> <span class="cf">function</span>(w) <span class="cf">if</span> (<span class="fu">nchar</span>(w[<span class="dv">1</span>]) <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="fu">report_bug</span>(<span class="at">r =</span> r, <span class="at">output =</span> output, <span class="at">error_message =</span> <span class="st">"error_run_plugin_server_code"</span>, </span>
<span id="cb2-265"><a href="#cb2-265" aria-hidden="true" tabindex="-1"></a>      <span class="at">error_name =</span> <span class="st">"%group_id% - run server code"</span>, <span class="at">category =</span> <span class="st">"Warning"</span>, <span class="at">error_report =</span> <span class="fu">toString</span>(w), <span class="at">language =</span> language))</span>
<span id="cb2-266"><a href="#cb2-266" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb2-267"><a href="#cb2-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-268"><a href="#cb2-268" aria-hidden="true" tabindex="-1"></a><span class="do">##########################################</span></span>
<span id="cb2-269"><a href="#cb2-269" aria-hidden="true" tabindex="-1"></a><span class="co"># Delete a row                           #</span></span>
<span id="cb2-270"><a href="#cb2-270" aria-hidden="true" tabindex="-1"></a><span class="do">##########################################</span></span>
<span id="cb2-271"><a href="#cb2-271" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-272"><a href="#cb2-272" aria-hidden="true" tabindex="-1"></a><span class="co"># Delete button is pressed</span></span>
<span id="cb2-273"><a href="#cb2-273" aria-hidden="true" tabindex="-1"></a><span class="fu">observeEvent</span>(input<span class="sc">$</span>deleted_pressed_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span>, r<span class="sc">$</span>delete_dialog_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span> <span class="er">&lt;</span><span class="sc">-</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-274"><a href="#cb2-274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-275"><a href="#cb2-275" aria-hidden="true" tabindex="-1"></a><span class="co"># Rendering react output</span></span>
<span id="cb2-276"><a href="#cb2-276" aria-hidden="true" tabindex="-1"></a><span class="fu">observeEvent</span>(r<span class="sc">$</span>delete_dialog_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span> , {</span>
<span id="cb2-277"><a href="#cb2-277" aria-hidden="true" tabindex="-1"></a>    output<span class="sc">$</span>delete_confirm <span class="ot">&lt;-</span> shiny.fluent<span class="sc">::</span><span class="fu">renderReact</span>({</span>
<span id="cb2-278"><a href="#cb2-278" aria-hidden="true" tabindex="-1"></a>        dialogContentProps <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb2-279"><a href="#cb2-279" aria-hidden="true" tabindex="-1"></a>            <span class="at">type =</span> <span class="dv">0</span>,</span>
<span id="cb2-280"><a href="#cb2-280" aria-hidden="true" tabindex="-1"></a>            <span class="at">title =</span> <span class="fu">translate</span>(language, <span class="st">"delete_exclusion_criterion"</span>, new_words),</span>
<span id="cb2-281"><a href="#cb2-281" aria-hidden="true" tabindex="-1"></a>            <span class="at">closeButtonAriaLabel =</span> <span class="st">"Close"</span>,</span>
<span id="cb2-282"><a href="#cb2-282" aria-hidden="true" tabindex="-1"></a>            <span class="at">subText =</span> <span class="fu">translate</span>(language, <span class="st">"delete_exclusion_criterion_subtext"</span>, new_words)</span>
<span id="cb2-283"><a href="#cb2-283" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb2-284"><a href="#cb2-284" aria-hidden="true" tabindex="-1"></a>        shiny.fluent<span class="sc">::</span><span class="fu">Dialog</span>(</span>
<span id="cb2-285"><a href="#cb2-285" aria-hidden="true" tabindex="-1"></a>            <span class="at">hidden =</span> <span class="sc">!</span>r<span class="sc">$</span>delete_dialog_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span>,</span>
<span id="cb2-286"><a href="#cb2-286" aria-hidden="true" tabindex="-1"></a>            <span class="at">onDismiss =</span> htmlwidgets<span class="sc">::</span><span class="fu">JS</span>(<span class="fu">paste0</span>(<span class="st">"function() { Shiny.setInputValue('hide_dialog_%group_id%_%study_id%', Math.random()); }"</span>)),</span>
<span id="cb2-287"><a href="#cb2-287" aria-hidden="true" tabindex="-1"></a>            <span class="at">dialogContentProps =</span> dialogContentProps,</span>
<span id="cb2-288"><a href="#cb2-288" aria-hidden="true" tabindex="-1"></a>            <span class="at">modalProps =</span> <span class="fu">list</span>(),</span>
<span id="cb2-289"><a href="#cb2-289" aria-hidden="true" tabindex="-1"></a>            shiny.fluent<span class="sc">::</span><span class="fu">DialogFooter</span>(</span>
<span id="cb2-290"><a href="#cb2-290" aria-hidden="true" tabindex="-1"></a>                shiny.fluent<span class="sc">::</span><span class="fu">PrimaryButton.shinyInput</span>(<span class="fu">ns</span>(<span class="st">"delete_confirmed_%group_id%_%study_id%"</span>), <span class="at">text =</span> <span class="fu">translate</span>(language, <span class="st">"delete"</span>, r<span class="sc">$</span>words)),</span>
<span id="cb2-291"><a href="#cb2-291" aria-hidden="true" tabindex="-1"></a>                shiny.fluent<span class="sc">::</span><span class="fu">DefaultButton.shinyInput</span>(<span class="fu">ns</span>(<span class="st">"delete_canceled_%group_id%_%study_id%"</span>), <span class="at">text =</span> <span class="fu">translate</span>(language, <span class="st">"dont_delete"</span>, r<span class="sc">$</span>words))</span>
<span id="cb2-292"><a href="#cb2-292" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb2-293"><a href="#cb2-293" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb2-294"><a href="#cb2-294" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb2-295"><a href="#cb2-295" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb2-296"><a href="#cb2-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-297"><a href="#cb2-297" aria-hidden="true" tabindex="-1"></a><span class="co"># Whether to close or not delete dialog box</span></span>
<span id="cb2-298"><a href="#cb2-298" aria-hidden="true" tabindex="-1"></a><span class="fu">observeEvent</span>(input<span class="sc">$</span>hide_dialog_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span>, r<span class="sc">$</span>delete_dialog_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span> <span class="er">&lt;</span><span class="sc">-</span> <span class="cn">FALSE</span>)</span>
<span id="cb2-299"><a href="#cb2-299" aria-hidden="true" tabindex="-1"></a><span class="fu">observeEvent</span>(input<span class="sc">$</span>delete_canceled_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span>, r<span class="sc">$</span>delete_dialog_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span> <span class="er">&lt;</span><span class="sc">-</span> <span class="cn">FALSE</span>)</span>
<span id="cb2-300"><a href="#cb2-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-301"><a href="#cb2-301" aria-hidden="true" tabindex="-1"></a><span class="co"># When the delete is confirmed</span></span>
<span id="cb2-302"><a href="#cb2-302" aria-hidden="true" tabindex="-1"></a><span class="fu">observeEvent</span>(input<span class="sc">$</span>delete_confirmed_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span>, {</span>
<span id="cb2-303"><a href="#cb2-303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-304"><a href="#cb2-304" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tryCatch</span>({</span>
<span id="cb2-305"><a href="#cb2-305" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-306"><a href="#cb2-306" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get value of deleted row</span></span>
<span id="cb2-307"><a href="#cb2-307" aria-hidden="true" tabindex="-1"></a>        row_deleted <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(<span class="fu">substr</span>(input<span class="sc">$</span>deleted_pressed_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span>, <span class="fu">nchar</span>(<span class="fu">paste0</span>(id, <span class="st">"-delete_%group_id%_%study_id%_"</span>)) <span class="sc">+</span> <span class="dv">1</span>, <span class="fu">nchar</span>(input<span class="sc">$</span>deleted_pressed_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span>)))</span>
<span id="cb2-308"><a href="#cb2-308" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-309"><a href="#cb2-309" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Delete row in database</span></span>
<span id="cb2-310"><a href="#cb2-310" aria-hidden="true" tabindex="-1"></a>        sql <span class="ot">&lt;-</span> glue<span class="sc">::</span><span class="fu">glue_sql</span>(<span class="st">"UPDATE modules_elements_options SET deleted = TRUE WHERE id = {row_deleted} OR link_id = {row_deleted}"</span>, <span class="at">.con =</span> r<span class="sc">$</span>db)</span>
<span id="cb2-311"><a href="#cb2-311" aria-hidden="true" tabindex="-1"></a>        query <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbSendStatement</span>(r<span class="sc">$</span>db, sql)</span>
<span id="cb2-312"><a href="#cb2-312" aria-hidden="true" tabindex="-1"></a>        DBI<span class="sc">::</span><span class="fu">dbClearResult</span>(query)</span>
<span id="cb2-313"><a href="#cb2-313" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-314"><a href="#cb2-314" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Change display orders, depending on the display order of deleted row</span></span>
<span id="cb2-315"><a href="#cb2-315" aria-hidden="true" tabindex="-1"></a>        sql <span class="ot">&lt;-</span> glue<span class="sc">::</span><span class="fu">glue_sql</span>(<span class="st">"SELECT value_num FROM modules_elements_options WHERE link_id = {row_deleted}"</span>, <span class="at">.con =</span> r<span class="sc">$</span>db)</span>
<span id="cb2-316"><a href="#cb2-316" aria-hidden="true" tabindex="-1"></a>        display_order_deleted <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbGetQuery</span>(r<span class="sc">$</span>db, sql) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">pull</span>()</span>
<span id="cb2-317"><a href="#cb2-317" aria-hidden="true" tabindex="-1"></a>        sql <span class="ot">&lt;-</span> glue<span class="sc">::</span><span class="fu">glue_sql</span>(<span class="fu">paste0</span>(<span class="st">"UPDATE modules_elements_options SET value_num = value_num - 1"</span>,</span>
<span id="cb2-318"><a href="#cb2-318" aria-hidden="true" tabindex="-1"></a>            <span class="st">" WHERE deleted IS FALSE AND group_id = %group_id% AND study_id = %study_id% AND category = 'aggregated' AND name = 'display_order' AND value_num &gt; {display_order_deleted}"</span>), <span class="at">.con =</span> r<span class="sc">$</span>db)</span>
<span id="cb2-319"><a href="#cb2-319" aria-hidden="true" tabindex="-1"></a>        query <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbSendStatement</span>(r<span class="sc">$</span>db, sql)</span>
<span id="cb2-320"><a href="#cb2-320" aria-hidden="true" tabindex="-1"></a>        DBI<span class="sc">::</span><span class="fu">dbClearResult</span>(query)</span>
<span id="cb2-321"><a href="#cb2-321" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-322"><a href="#cb2-322" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Close dialog box</span></span>
<span id="cb2-323"><a href="#cb2-323" aria-hidden="true" tabindex="-1"></a>        r<span class="sc">$</span>delete_dialog_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span> <span class="er">&lt;</span><span class="sc">-</span> <span class="cn">FALSE</span></span>
<span id="cb2-324"><a href="#cb2-324" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-325"><a href="#cb2-325" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Reload r variable</span></span>
<span id="cb2-326"><a href="#cb2-326" aria-hidden="true" tabindex="-1"></a>        plugins_load_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span>(r)</span>
<span id="cb2-327"><a href="#cb2-327" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-328"><a href="#cb2-328" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Notification to user</span></span>
<span id="cb2-329"><a href="#cb2-329" aria-hidden="true" tabindex="-1"></a>        <span class="fu">show_message_bar</span>(<span class="at">output =</span> output, <span class="at">id =</span> <span class="dv">3</span>, <span class="fu">translate</span>(language, <span class="st">"exclusion_criterion_deleted"</span>, new_words), <span class="at">type =</span><span class="st">"severeWarning"</span>, <span class="at">language =</span> language)</span>
<span id="cb2-330"><a href="#cb2-330" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-331"><a href="#cb2-331" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Send a message to flowchart's plugin, to reload data</span></span>
<span id="cb2-332"><a href="#cb2-332" aria-hidden="true" tabindex="-1"></a>        r<span class="sc">$</span>reload_flowchart_<span class="sc">%study_id%</span> <span class="er">&lt;</span><span class="sc">-</span> <span class="cn">TRUE</span></span>
<span id="cb2-333"><a href="#cb2-333" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb2-334"><a href="#cb2-334" aria-hidden="true" tabindex="-1"></a>    <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cf">if</span> (<span class="fu">nchar</span>(e[<span class="dv">1</span>]) <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="fu">report_bug</span>(<span class="at">r =</span> r, <span class="at">output =</span> output, <span class="at">error_message =</span> <span class="st">"error_run_plugin_server_code"</span>, </span>
<span id="cb2-335"><a href="#cb2-335" aria-hidden="true" tabindex="-1"></a>      <span class="at">error_name =</span> <span class="st">"%group_id% - run server code"</span>, <span class="at">category =</span> <span class="st">"Error"</span>, <span class="at">error_report =</span> <span class="fu">toString</span>(e), <span class="at">language =</span> language),</span>
<span id="cb2-336"><a href="#cb2-336" aria-hidden="true" tabindex="-1"></a>    <span class="at">warning =</span> <span class="cf">function</span>(w) <span class="cf">if</span> (<span class="fu">nchar</span>(w[<span class="dv">1</span>]) <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="fu">report_bug</span>(<span class="at">r =</span> r, <span class="at">output =</span> output, <span class="at">error_message =</span> <span class="st">"error_run_plugin_server_code"</span>, </span>
<span id="cb2-337"><a href="#cb2-337" aria-hidden="true" tabindex="-1"></a>      <span class="at">error_name =</span> <span class="st">"%group_id% - run server code"</span>, <span class="at">category =</span> <span class="st">"Warning"</span>, <span class="at">error_report =</span> <span class="fu">toString</span>(w), <span class="at">language =</span> language))</span>
<span id="cb2-338"><a href="#cb2-338" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="exclusion-criteria-applier">Exclusion criteria applier<a class="anchor" aria-label="anchor" href="#exclusion-criteria-applier"></a>
</h2>
<div class="section level3">
<h3 id="description-1">Description<a class="anchor" aria-label="anchor" href="#description-1"></a>
</h3>
<ul>
<li>
<strong>Version</strong> : 0.0.1</li>
<li>
<strong>Libraries</strong> : none</li>
</ul>
</div>
<div class="section level3">
<h3 id="ui-code-1">UI code<a class="anchor" aria-label="anchor" href="#ui-code-1"></a>
</h3>
</div>
<div class="section level3">
<h3 id="server-code-1">Server code<a class="anchor" aria-label="anchor" href="#server-code-1"></a>
</h3>
</div>
</div>
<div class="section level2">
<h2 id="flowchart">Flowchart<a class="anchor" aria-label="anchor" href="#flowchart"></a>
</h2>
<div class="section level3">
<h3 id="description-2">Description<a class="anchor" aria-label="anchor" href="#description-2"></a>
</h3>
<ul>
<li>
<strong>Version</strong> : 0.0.1</li>
<li>
<strong>Libraries</strong> : RDiagrammeR, clipr</li>
</ul>
</div>
<div class="section level3">
<h3 id="ui-code-2">UI code<a class="anchor" aria-label="anchor" href="#ui-code-2"></a>
</h3>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">temp</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span><span class="op">{</span>

    <span class="co"># Translations</span>
    <span class="va">new_words</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html" class="external-link">tribble</a></span><span class="op">(</span><span class="op">~</span><span class="va">language</span>, <span class="op">~</span><span class="va">reference_word</span>, <span class="op">~</span><span class="va">translated_word</span>,
        <span class="st">"EN"</span>, <span class="st">"copy_figure"</span>, <span class="st">"Copy figure"</span>,
        <span class="st">"FR"</span>, <span class="st">"copy_figure"</span>, <span class="st">"Copier la figure"</span>,
        <span class="st">"EN"</span>, <span class="st">"display_figure"</span>, <span class="st">"Display figure"</span>,
        <span class="st">"FR"</span>, <span class="st">"display_figure"</span>, <span class="st">"Afficher la figure"</span>
    <span class="op">)</span>
    
    <span class="co"># Get width &amp; height</span>

    <span class="va">flowchart_attr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>
    
    <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"width"</span>, <span class="st">"height"</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">attr</span><span class="op">)</span><span class="op">{</span>
    
        <span class="va">flowchart_attr</span><span class="op">[[</span><span class="va">attr</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html" class="external-link">dbGetQuery</a></span><span class="op">(</span><span class="va">r</span><span class="op">$</span><span class="va">db</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"SELECT value_num FROM modules_elements_options WHERE category = 'aggregated' AND name = 'flowchart_"</span>, <span class="va">attr</span>, <span class="st">"' 
            AND group_id = %group_id% AND study_id = %study_id% AND deleted IS FALSE"</span><span class="op">)</span><span class="op">)</span>
            
        <span class="co"># If no entry in database yet, create one</span>
        <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">flowchart_attr</span><span class="op">[[</span><span class="va">attr</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span><span class="op">{</span>
        
            <span class="va">last_row</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_last_row.html">get_last_row</a></span><span class="op">(</span><span class="va">r</span><span class="op">$</span><span class="va">db</span>, <span class="st">"modules_elements_options"</span><span class="op">)</span>
            <span class="va">sql</span> <span class="op">&lt;-</span> <span class="fu">glue</span><span class="fu">::</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue_sql.html" class="external-link">glue_sql</a></span><span class="op">(</span><span class="st">"INSERT INTO modules_elements_options(id, group_id, study_id, category, name, value_num, creator_id, datetime, deleted)
                SELECT {last_row + 1}, %group_id%, %study_id%, 'aggregated', {paste0('flowchart_', attr)}, 300, {r$user_id}, {as.character(Sys.time())}, FALSE"</span>, .con <span class="op">=</span> <span class="va">r</span><span class="op">$</span><span class="va">db</span><span class="op">)</span>
            <span class="va">query</span> <span class="op">&lt;-</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbSendStatement.html" class="external-link">dbSendStatement</a></span><span class="op">(</span><span class="va">r</span><span class="op">$</span><span class="va">db</span>, <span class="va">sql</span><span class="op">)</span>
            <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbClearResult.html" class="external-link">dbClearResult</a></span><span class="op">(</span><span class="va">query</span><span class="op">)</span>
            
            <span class="va">flowchart_attr</span><span class="op">[[</span><span class="va">attr</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;&lt;-</span> <span class="fl">400</span>
        <span class="op">}</span>
        
        <span class="co"># If already an entry, get this entry and update sliders</span>
        <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">flowchart_attr</span><span class="op">[[</span><span class="va">attr</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span><span class="op">{</span>
        
            <span class="va">value</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">flowchart_attr</span><span class="op">[[</span><span class="va">attr</span><span class="op">]</span><span class="op">]</span> <span class="op">%&gt;%</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">value_num</span><span class="op">)</span><span class="op">)</span>
            <span class="va">flowchart_attr</span><span class="op">[[</span><span class="va">attr</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;&lt;-</span> <span class="va">value</span>
            <span class="va">r</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"flowchart_"</span>, <span class="va">attr</span>, <span class="st">"_%group_id%_%study_id%"</span><span class="op">)</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">value</span>
        <span class="op">}</span>  
    <span class="op">}</span><span class="op">)</span>

    <span class="fu">div</span><span class="op">(</span>
        <span class="fu">uiOutput</span><span class="op">(</span><span class="fu">ns</span><span class="op">(</span><span class="st">"message_bar_1_%group_id%_%study_id%"</span><span class="op">)</span><span class="op">)</span>,
        <span class="fu">uiOutput</span><span class="op">(</span><span class="fu">ns</span><span class="op">(</span><span class="st">"message_bar_2_%group_id%_%study_id%"</span><span class="op">)</span><span class="op">)</span>, <span class="fu">br</span><span class="op">(</span><span class="op">)</span>,
        <span class="fu">uiOutput</span><span class="op">(</span><span class="fu">ns</span><span class="op">(</span><span class="st">"flowchart_%group_id%_%study_id%"</span><span class="op">)</span><span class="op">)</span>,
        <span class="fu">div</span><span class="op">(</span>
            <span class="fu">span</span><span class="op">(</span><span class="st">"Width"</span>, style <span class="op">=</span> <span class="st">"font-weight:bold; margin-left: 5px;"</span><span class="op">)</span>, <span class="fu">br</span><span class="op">(</span><span class="op">)</span>,
            <span class="fu">shiny.fluent</span><span class="fu">::</span><span class="fu"><a href="https://appsilon.github.io/shiny.fluent/reference/Slider.html" class="external-link">Slider.shinyInput</a></span><span class="op">(</span><span class="fu">ns</span><span class="op">(</span><span class="st">"flowchart_width_%group_id%_%study_id%"</span><span class="op">)</span>, value <span class="op">=</span> <span class="va">flowchart_attr</span><span class="op">$</span><span class="va">width</span>, min <span class="op">=</span> <span class="fl">10</span>, max <span class="op">=</span> <span class="fl">2000</span><span class="op">)</span>, <span class="fu">br</span><span class="op">(</span><span class="op">)</span>,
            <span class="fu">span</span><span class="op">(</span><span class="st">"Height"</span>, style <span class="op">=</span> <span class="st">"font-weight:bold; margin-left: 5px;"</span><span class="op">)</span>, <span class="fu">br</span><span class="op">(</span><span class="op">)</span>,
            <span class="fu">shiny.fluent</span><span class="fu">::</span><span class="fu"><a href="https://appsilon.github.io/shiny.fluent/reference/Slider.html" class="external-link">Slider.shinyInput</a></span><span class="op">(</span><span class="fu">ns</span><span class="op">(</span><span class="st">"flowchart_height_%group_id%_%study_id%"</span><span class="op">)</span>, value <span class="op">=</span> <span class="va">flowchart_attr</span><span class="op">$</span><span class="va">height</span>, min <span class="op">=</span> <span class="fl">10</span>, max <span class="op">=</span> <span class="fl">2000</span><span class="op">)</span>, <span class="fu">br</span><span class="op">(</span><span class="op">)</span>,
            <span class="fu">shiny.fluent</span><span class="fu">::</span><span class="fu"><a href="https://appsilon.github.io/shiny.fluent/reference/Stack.html" class="external-link">Stack</a></span><span class="op">(</span>horizontal <span class="op">=</span> <span class="cn">TRUE</span>, tokens <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>childrenGap <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,
                <span class="fu">shiny.fluent</span><span class="fu">::</span><span class="fu"><a href="https://appsilon.github.io/shiny.fluent/reference/Button.html" class="external-link">DefaultButton.shinyInput</a></span><span class="op">(</span><span class="fu">ns</span><span class="op">(</span><span class="st">"flowchart_render_%group_id%_%study_id%"</span><span class="op">)</span>, <span class="fu"><a href="../reference/translate.html">translate</a></span><span class="op">(</span><span class="va">language</span>, <span class="st">"display_figure"</span>, <span class="va">new_words</span><span class="op">)</span><span class="op">)</span>,
                <span class="fu">shiny.fluent</span><span class="fu">::</span><span class="fu"><a href="https://appsilon.github.io/shiny.fluent/reference/Button.html" class="external-link">DefaultButton.shinyInput</a></span><span class="op">(</span><span class="fu">ns</span><span class="op">(</span><span class="st">"flowchart_copy_%group_id%_%study_id%"</span><span class="op">)</span>, <span class="fu"><a href="../reference/translate.html">translate</a></span><span class="op">(</span><span class="va">language</span>, <span class="st">"copy_figure"</span>, <span class="va">new_words</span><span class="op">)</span><span class="op">)</span>,
                <span class="fu">shiny.fluent</span><span class="fu">::</span><span class="fu"><a href="https://appsilon.github.io/shiny.fluent/reference/Button.html" class="external-link">PrimaryButton.shinyInput</a></span><span class="op">(</span><span class="fu">ns</span><span class="op">(</span><span class="st">"flowchart_save_%group_id%_%study_id%"</span><span class="op">)</span>, <span class="fu"><a href="../reference/translate.html">translate</a></span><span class="op">(</span><span class="va">language</span>, <span class="st">"save"</span>, <span class="va">r</span><span class="op">$</span><span class="va">words</span><span class="op">)</span><span class="op">)</span>
            <span class="op">)</span>,
        style <span class="op">=</span> <span class="st">"float:center;"</span><span class="op">)</span>
    <span class="op">)</span>
    
<span class="op">}</span>

<span class="fu">temp</span><span class="op">(</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="server-code-2">Server code<a class="anchor" aria-label="anchor" href="#server-code-2"></a>
</h3>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="do">##########################################</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Translations                           #</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="do">##########################################</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>new_words <span class="ot">&lt;-</span> tibble<span class="sc">::</span><span class="fu">tribble</span>(<span class="sc">~</span>language, <span class="sc">~</span>reference_word, <span class="sc">~</span>translated_word,</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"EN"</span>, <span class="st">"screened_patients"</span>, <span class="st">"Screened patients"</span>,</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"FR"</span>, <span class="st">"screened_patients"</span>, <span class="st">"Patients screenés"</span>,</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"EN"</span>, <span class="st">"patients_not_excluded"</span>, <span class="st">"Patients not excluded"</span>,</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"FR"</span>, <span class="st">"patients_not_excluded"</span>, <span class="st">"Patients non exclus"</span>,</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"EN"</span>, <span class="st">"clipr_required"</span>, <span class="st">"Library clipr required to copy a figure, please install it with install.packages('clipr')"</span>,</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"FR"</span>, <span class="st">"clipr_required"</span>, <span class="st">"Le package clipr est nécessaire pour copier une figure, merci de l'installer avec install.packages('clipr')"</span>,</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"EN"</span>, <span class="st">"diagrammeR_required"</span>, <span class="st">"Library diagrammeR required to display a flowchart, please install it with install.packages('DiagrammeR')"</span>,</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"FR"</span>, <span class="st">"diagrammeR_required"</span>, <span class="st">"Le package diagrammeR est nécessaire pour afficher le flowchart, merci de l'installer avec install.packages('DiagrammeR')"</span>,</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"EN"</span>, <span class="st">"no_exclusion_criteria"</span>, <span class="st">"No exclusion criteria available for this study"</span>,</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"FR"</span>, <span class="st">"no_exclusion_criteria"</span>, <span class="st">"Pas de critère d'exclusion disponible pour cette étude"</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a><span class="do">##########################################</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a><span class="co"># The flowchart is a reactive            #</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a><span class="do">##########################################</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>flowchart_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span> <span class="er">&lt;</span><span class="sc">-</span> <span class="fu">reactive</span>({ </span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tryCatch</span>({</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>        <span class="do">##########################################</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get exclusion reasons                  #</span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>        <span class="do">##########################################</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Existing exclusion reasons</span></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>        <span class="co"># A message sent by other plugins to reload flowchart</span></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>        <span class="co"># No need to send a message from Patient-level data, cause it changes r$patients_options variable, with makes this reactives reload</span></span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">length</span>(r<span class="sc">$</span>reload_flowchart_<span class="sc">%study_id%</span>) <span class="sc">&gt;</span> <span class="dv">0</span>) r<span class="sc">$</span>reload_flowchart_<span class="sc">%study_id%</span> <span class="er">&lt;</span><span class="sc">-</span> <span class="cn">FALSE</span></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>        sql <span class="ot">&lt;-</span> glue<span class="sc">::</span><span class="fu">glue_sql</span>(<span class="fu">paste0</span>(<span class="st">"SELECT meo1.id, meo1.value AS exclusion_reason, meo2.value_num AS display_order</span></span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a><span class="st">            FROM modules_elements_options meo1</span></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a><span class="st">            LEFT JOIN modules_elements_options meo2 ON meo1.id = meo2.link_id</span></span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a><span class="st">            WHERE meo1.deleted IS FALSE AND meo2.deleted IS FALSE AND meo1.category = 'aggregated' AND meo1.name = 'exclusion_reason_name'</span></span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a><span class="st">            AND meo1.study_id = %study_id%"</span>), <span class="at">.con =</span> r<span class="sc">$</span>db)</span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>        exclusion_reasons <span class="ot">&lt;&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbGetQuery</span>(r<span class="sc">$</span>db, sql) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">arrange</span>(display_order) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">mutate_at</span>(<span class="st">"display_order"</span>, as.integer)</span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Excluded patients with exclusions reasons</span></span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>        excluded_patients <span class="ot">&lt;-</span> r<span class="sc">$</span>patients_options <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(category <span class="sc">==</span> <span class="st">"exclusion_reason"</span> <span class="sc">&amp;</span> study_id <span class="sc">==</span> <span class="sc">%study_id%</span>) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(patient_id, value_num)</span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Merge the two tables</span></span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>        excluded_patients <span class="ot">&lt;-</span> </span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a>            excluded_patients <span class="sc">%&gt;%</span></span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">left_join</span>(exclusion_reasons <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="at">value_num =</span> id, exclusion_reason, display_order), <span class="at">by =</span> <span class="st">"value_num"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>value_num)</span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get list of all patients</span></span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a>        subsets <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbGetQuery</span>(r<span class="sc">$</span>db, <span class="st">"SELECT id FROM subsets WHERE deleted IS FALSE AND study_id = %study_id%"</span>) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">pull</span>()</span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a>        sql <span class="ot">&lt;-</span> glue<span class="sc">::</span><span class="fu">glue_sql</span>(<span class="st">"SELECT patient_id FROM subset_patients WHERE deleted IS FALSE AND subset_id IN ({subsets*}) GROUP BY patient_id"</span>, <span class="at">.con =</span> r<span class="sc">$</span>db)</span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a>        all_patients <span class="ot">&lt;&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbGetQuery</span>(r<span class="sc">$</span>db, sql)</span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Merge all_patients table with excluded_patients table</span></span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a>        <span class="co"># To have all exclusion reasons (if an exclusion reason is not used), merge with exclusion_reasons</span></span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a>        all_patients <span class="ot">&lt;&lt;-</span></span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a>            all_patients <span class="sc">%&gt;%</span></span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">left_join</span>(excluded_patients, <span class="at">by =</span> <span class="st">"patient_id"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb4-65"><a href="#cb4-65" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">count</span>(exclusion_reason)</span>
<span id="cb4-66"><a href="#cb4-66" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb4-67"><a href="#cb4-67" aria-hidden="true" tabindex="-1"></a>        exclusion_reasons <span class="ot">&lt;&lt;-</span></span>
<span id="cb4-68"><a href="#cb4-68" aria-hidden="true" tabindex="-1"></a>            exclusion_reasons <span class="sc">%&gt;%</span></span>
<span id="cb4-69"><a href="#cb4-69" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">left_join</span>(all_patients, <span class="at">by =</span> <span class="st">"exclusion_reason"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb4-70"><a href="#cb4-70" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">n =</span> <span class="fu">ifelse</span>(<span class="sc">!</span><span class="fu">is.na</span>(n), n, 0L))</span>
<span id="cb4-71"><a href="#cb4-71" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb4-72"><a href="#cb4-72" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">nrow</span>(exclusion_reasons) <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">show_message_bar</span>(<span class="at">output =</span> output, <span class="at">id =</span> <span class="dv">4</span>, <span class="at">message =</span> <span class="st">"no_exclusion_criteria"</span>, <span class="at">language =</span> language, <span class="at">words =</span> new_words)</span>
<span id="cb4-73"><a href="#cb4-73" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb4-74"><a href="#cb4-74" aria-hidden="true" tabindex="-1"></a>        <span class="do">##########################################</span></span>
<span id="cb4-75"><a href="#cb4-75" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create flowchart                       #</span></span>
<span id="cb4-76"><a href="#cb4-76" aria-hidden="true" tabindex="-1"></a>        <span class="do">##########################################</span></span>
<span id="cb4-77"><a href="#cb4-77" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-78"><a href="#cb4-78" aria-hidden="true" tabindex="-1"></a>        patients_count <span class="ot">&lt;&lt;-</span> <span class="fu">sum</span>(all_patients<span class="sc">$</span>n)</span>
<span id="cb4-79"><a href="#cb4-79" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-80"><a href="#cb4-80" aria-hidden="true" tabindex="-1"></a>        flowchart_text <span class="ot">&lt;&lt;-</span> <span class="fu">paste0</span>(<span class="st">"[1]: '"</span>, <span class="fu">translate</span>(language, <span class="st">"screened_patients"</span>, new_words), <span class="st">" | n = "</span>, patients_count, <span class="st">"'"</span>)</span>
<span id="cb4-81"><a href="#cb4-81" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-82"><a href="#cb4-82" aria-hidden="true" tabindex="-1"></a>        nodes_text <span class="ot">&lt;&lt;-</span> <span class="st">""</span></span>
<span id="cb4-83"><a href="#cb4-83" aria-hidden="true" tabindex="-1"></a>        vertical_arrows_1 <span class="ot">&lt;&lt;-</span> <span class="st">""</span></span>
<span id="cb4-84"><a href="#cb4-84" aria-hidden="true" tabindex="-1"></a>        vertical_arrows_2 <span class="ot">&lt;&lt;-</span> <span class="st">""</span></span>
<span id="cb4-85"><a href="#cb4-85" aria-hidden="true" tabindex="-1"></a>        horizontal_arrows <span class="ot">&lt;&lt;-</span> <span class="st">""</span></span>
<span id="cb4-86"><a href="#cb4-86" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-87"><a href="#cb4-87" aria-hidden="true" tabindex="-1"></a>        i <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb4-88"><a href="#cb4-88" aria-hidden="true" tabindex="-1"></a>        j <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb4-89"><a href="#cb4-89" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-90"><a href="#cb4-90" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">nrow</span>(exclusion_reasons) <span class="sc">&gt;</span> <span class="dv">0</span>){</span>
<span id="cb4-91"><a href="#cb4-91" aria-hidden="true" tabindex="-1"></a>            <span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(exclusion_reasons), <span class="cf">function</span>(k) {</span>
<span id="cb4-92"><a href="#cb4-92" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb4-93"><a href="#cb4-93" aria-hidden="true" tabindex="-1"></a>                row <span class="ot">&lt;-</span> exclusion_reasons[k, ]</span>
<span id="cb4-94"><a href="#cb4-94" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb4-95"><a href="#cb4-95" aria-hidden="true" tabindex="-1"></a>                patients_count <span class="ot">&lt;&lt;-</span> patients_count <span class="sc">-</span> row<span class="sc">$</span>n</span>
<span id="cb4-96"><a href="#cb4-96" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb4-97"><a href="#cb4-97" aria-hidden="true" tabindex="-1"></a>                flowchart_text <span class="ot">&lt;&lt;-</span> <span class="fu">paste0</span>(flowchart_text, </span>
<span id="cb4-98"><a href="#cb4-98" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"</span><span class="sc">\n</span><span class="st">["</span>, i, <span class="st">"]: '"</span>, row<span class="sc">$</span>exclusion_reason, <span class="st">" | n = "</span>, row<span class="sc">$</span>n, <span class="st">"'"</span>,</span>
<span id="cb4-99"><a href="#cb4-99" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"</span><span class="sc">\n</span><span class="st">["</span>, i <span class="sc">+</span> <span class="dv">1</span>, <span class="st">"]: '"</span>, <span class="fu">translate</span>(language, <span class="st">"patients_not_excluded"</span>, new_words), <span class="st">" | n = "</span>, patients_count, <span class="st">"'"</span>)</span>
<span id="cb4-100"><a href="#cb4-100" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb4-101"><a href="#cb4-101" aria-hidden="true" tabindex="-1"></a>                nodes_text <span class="ot">&lt;&lt;-</span> <span class="fu">paste0</span>(nodes_text, </span>
<span id="cb4-102"><a href="#cb4-102" aria-hidden="true" tabindex="-1"></a>                <span class="st">"i"</span>, j, <span class="st">" [label = '@@"</span>, i <span class="sc">-</span> <span class="dv">1</span>, <span class="st">"']</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb4-103"><a href="#cb4-103" aria-hidden="true" tabindex="-1"></a>                <span class="st">"e"</span>, j, <span class="st">" [label = '@@"</span>, i, <span class="st">"']</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb4-104"><a href="#cb4-104" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb4-105"><a href="#cb4-105" aria-hidden="true" tabindex="-1"></a>                vertical_arrows_1 <span class="ot">&lt;&lt;-</span> <span class="fu">paste0</span>(vertical_arrows_1, <span class="st">"i"</span>, j, <span class="st">" -&gt; d"</span>, j, <span class="st">"; "</span>)</span>
<span id="cb4-106"><a href="#cb4-106" aria-hidden="true" tabindex="-1"></a>                vertical_arrows_2 <span class="ot">&lt;&lt;-</span> <span class="fu">paste0</span>(vertical_arrows_2, <span class="st">"d"</span>, j, <span class="st">" -&gt; i"</span>, j <span class="sc">+</span> <span class="dv">1</span>, <span class="st">"; "</span>)</span>
<span id="cb4-107"><a href="#cb4-107" aria-hidden="true" tabindex="-1"></a>                horizontal_arrows <span class="ot">&lt;&lt;-</span> <span class="fu">paste0</span>(horizontal_arrows, <span class="st">"{rank = same; d"</span>, j, <span class="st">" -&gt; e"</span>, j, <span class="st">"}</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb4-108"><a href="#cb4-108" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb4-109"><a href="#cb4-109" aria-hidden="true" tabindex="-1"></a>                i <span class="ot">&lt;&lt;-</span> i <span class="sc">+</span> <span class="dv">2</span></span>
<span id="cb4-110"><a href="#cb4-110" aria-hidden="true" tabindex="-1"></a>                j <span class="ot">&lt;&lt;-</span> j <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb4-111"><a href="#cb4-111" aria-hidden="true" tabindex="-1"></a>            })</span>
<span id="cb4-112"><a href="#cb4-112" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb4-113"><a href="#cb4-113" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-114"><a href="#cb4-114" aria-hidden="true" tabindex="-1"></a>        nodes_text <span class="ot">&lt;&lt;-</span> <span class="fu">paste0</span>(nodes_text,</span>
<span id="cb4-115"><a href="#cb4-115" aria-hidden="true" tabindex="-1"></a>            <span class="st">"i"</span>, j, <span class="st">" [label = '@@"</span>, i <span class="sc">-</span> <span class="dv">1</span>, <span class="st">"']</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb4-116"><a href="#cb4-116" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb4-117"><a href="#cb4-117" aria-hidden="true" tabindex="-1"></a>        graph <span class="ot">&lt;-</span> <span class="fu">paste0</span>(</span>
<span id="cb4-118"><a href="#cb4-118" aria-hidden="true" tabindex="-1"></a>            <span class="st">"digraph flowchart {</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb4-119"><a href="#cb4-119" aria-hidden="true" tabindex="-1"></a>            <span class="st">"node [fontname = Helvetica, shape = rectangle, width = 3]</span><span class="sc">\n\n</span><span class="st">"</span>,</span>
<span id="cb4-120"><a href="#cb4-120" aria-hidden="true" tabindex="-1"></a>            nodes_text, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb4-121"><a href="#cb4-121" aria-hidden="true" tabindex="-1"></a>            <span class="st">"node [shape = none, width = 0, height = 0, label = '']</span><span class="sc">\n\n</span><span class="st">"</span>,</span>
<span id="cb4-122"><a href="#cb4-122" aria-hidden="true" tabindex="-1"></a>            <span class="st">"edge [dir = none]</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb4-123"><a href="#cb4-123" aria-hidden="true" tabindex="-1"></a>            vertical_arrows_1, <span class="st">"</span><span class="sc">\n\n</span><span class="st">"</span>,</span>
<span id="cb4-124"><a href="#cb4-124" aria-hidden="true" tabindex="-1"></a>            <span class="st">"edge [len = 0.5, style = solid]</span><span class="sc">\n</span><span class="st">"</span>, </span>
<span id="cb4-125"><a href="#cb4-125" aria-hidden="true" tabindex="-1"></a>            vertical_arrows_2, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb4-126"><a href="#cb4-126" aria-hidden="true" tabindex="-1"></a>            horizontal_arrows, <span class="st">"</span><span class="sc">\n\n</span><span class="st">"</span>,</span>
<span id="cb4-127"><a href="#cb4-127" aria-hidden="true" tabindex="-1"></a>            <span class="st">"}</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb4-128"><a href="#cb4-128" aria-hidden="true" tabindex="-1"></a>            flowchart_text)</span>
<span id="cb4-129"><a href="#cb4-129" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb4-130"><a href="#cb4-130" aria-hidden="true" tabindex="-1"></a>        graph</span>
<span id="cb4-131"><a href="#cb4-131" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb4-132"><a href="#cb4-132" aria-hidden="true" tabindex="-1"></a>    <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cf">if</span> (<span class="fu">nchar</span>(e[<span class="dv">1</span>]) <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="fu">report_bug</span>(<span class="at">r =</span> r, <span class="at">output =</span> output, <span class="at">error_message =</span> <span class="st">"error_run_plugin_server_code"</span>, </span>
<span id="cb4-133"><a href="#cb4-133" aria-hidden="true" tabindex="-1"></a>      <span class="at">error_name =</span> <span class="st">"%group_id% - run server code"</span>, <span class="at">category =</span> <span class="st">"Error"</span>, <span class="at">error_report =</span> <span class="fu">toString</span>(e), <span class="at">language =</span> language),</span>
<span id="cb4-134"><a href="#cb4-134" aria-hidden="true" tabindex="-1"></a>    <span class="at">warning =</span> <span class="cf">function</span>(w) <span class="cf">if</span> (<span class="fu">nchar</span>(w[<span class="dv">1</span>]) <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="fu">report_bug</span>(<span class="at">r =</span> r, <span class="at">output =</span> output, <span class="at">error_message =</span> <span class="st">"error_run_plugin_server_code"</span>, </span>
<span id="cb4-135"><a href="#cb4-135" aria-hidden="true" tabindex="-1"></a>      <span class="at">error_name =</span> <span class="st">"%group_id% - run server code"</span>, <span class="at">category =</span> <span class="st">"Warning"</span>, <span class="at">error_report =</span> <span class="fu">toString</span>(w), <span class="at">language =</span> language))</span>
<span id="cb4-136"><a href="#cb4-136" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb4-137"><a href="#cb4-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-138"><a href="#cb4-138" aria-hidden="true" tabindex="-1"></a><span class="co"># Render flowchart</span></span>
<span id="cb4-139"><a href="#cb4-139" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">requireNamespace</span>(<span class="st">"DiagrammeR"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)){</span>
<span id="cb4-140"><a href="#cb4-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-141"><a href="#cb4-141" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(r<span class="sc">$</span>flowchart_width_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span>) <span class="sc">==</span> <span class="dv">0</span>) r<span class="sc">$</span>flowchart_width_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span> <span class="er">&lt;</span><span class="sc">-</span> <span class="dv">400</span></span>
<span id="cb4-142"><a href="#cb4-142" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(r<span class="sc">$</span>flowchart_height_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span>) <span class="sc">==</span> <span class="dv">0</span>) r<span class="sc">$</span>flowchart_height_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span> <span class="er">&lt;</span><span class="sc">-</span> <span class="dv">400</span></span>
<span id="cb4-143"><a href="#cb4-143" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-144"><a href="#cb4-144" aria-hidden="true" tabindex="-1"></a>    output<span class="sc">$</span>flowchart_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span> <span class="er">&lt;</span><span class="sc">-</span> <span class="fu">renderUI</span>(<span class="fu">div</span>(DiagrammeR<span class="sc">::</span><span class="fu">grVizOutput</span>(<span class="fu">ns</span>(<span class="st">"flowchart_grviz_%group_id%_%study_id%"</span>), </span>
<span id="cb4-145"><a href="#cb4-145" aria-hidden="true" tabindex="-1"></a>        <span class="at">width =</span> r<span class="sc">$</span>flowchart_width_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span>, <span class="at">height =</span> r<span class="sc">$</span>flowchart_height_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span>), <span class="at">style =</span> <span class="st">"float:left; margin-right: 100px;"</span>))</span>
<span id="cb4-146"><a href="#cb4-146" aria-hidden="true" tabindex="-1"></a>    output<span class="sc">$</span>flowchart_grviz_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span> <span class="er">&lt;</span><span class="sc">-</span> DiagrammeR<span class="sc">::</span><span class="fu">renderGrViz</span>(DiagrammeR<span class="sc">::</span><span class="fu">grViz</span>(flowchart_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span>()))</span>
<span id="cb4-147"><a href="#cb4-147" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-148"><a href="#cb4-148" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">"DiagrammeR"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) output<span class="sc">$</span>message_bar_1_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span> <span class="er">&lt;</span><span class="sc">-</span> <span class="fu">renderUI</span>(</span>
<span id="cb4-149"><a href="#cb4-149" aria-hidden="true" tabindex="-1"></a>    <span class="fu">div</span>(shiny.fluent<span class="sc">::</span><span class="fu">MessageBar</span>(<span class="fu">translate</span>(language, <span class="st">"diagrammeR_required"</span>, new_words), <span class="at">messageBarType =</span> <span class="dv">3</span>), <span class="at">style =</span> <span class="st">"margin-top:10px;"</span>))</span>
<span id="cb4-150"><a href="#cb4-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-151"><a href="#cb4-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-152"><a href="#cb4-152" aria-hidden="true" tabindex="-1"></a><span class="do">##########################################</span></span>
<span id="cb4-153"><a href="#cb4-153" aria-hidden="true" tabindex="-1"></a><span class="co"># Change width or height                 #</span></span>
<span id="cb4-154"><a href="#cb4-154" aria-hidden="true" tabindex="-1"></a><span class="do">##########################################</span></span>
<span id="cb4-155"><a href="#cb4-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-156"><a href="#cb4-156" aria-hidden="true" tabindex="-1"></a><span class="fu">observeEvent</span>(input<span class="sc">$</span>flowchart_render_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span>, {</span>
<span id="cb4-157"><a href="#cb4-157" aria-hidden="true" tabindex="-1"></a>    r<span class="sc">$</span>flowchart_width_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span> <span class="er">&lt;</span><span class="sc">-</span> input<span class="sc">$</span>flowchart_width_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span></span>
<span id="cb4-158"><a href="#cb4-158" aria-hidden="true" tabindex="-1"></a>    r<span class="sc">$</span>flowchart_height_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span> <span class="er">&lt;</span><span class="sc">-</span> input<span class="sc">$</span>flowchart_height_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span></span>
<span id="cb4-159"><a href="#cb4-159" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb4-160"><a href="#cb4-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-161"><a href="#cb4-161" aria-hidden="true" tabindex="-1"></a><span class="do">##########################################</span></span>
<span id="cb4-162"><a href="#cb4-162" aria-hidden="true" tabindex="-1"></a><span class="co"># Copy figure                            #</span></span>
<span id="cb4-163"><a href="#cb4-163" aria-hidden="true" tabindex="-1"></a><span class="do">##########################################</span></span>
<span id="cb4-164"><a href="#cb4-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-165"><a href="#cb4-165" aria-hidden="true" tabindex="-1"></a><span class="fu">observeEvent</span>(input<span class="sc">$</span>flowchart_copy_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span>, {</span>
<span id="cb4-166"><a href="#cb4-166" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">requireNamespace</span>(<span class="st">"clipr"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>) <span class="sc">&amp;</span> <span class="fu">requireNamespace</span>(<span class="st">"DiagrammeR"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)){</span>
<span id="cb4-167"><a href="#cb4-167" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-168"><a href="#cb4-168" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Save figure in data/figures dir</span></span>
<span id="cb4-169"><a href="#cb4-169" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-170"><a href="#cb4-170" aria-hidden="true" tabindex="-1"></a>        dir <span class="ot">&lt;-</span>  <span class="fu">paste0</span>(<span class="fu">find.package</span>(<span class="st">"cdwtools"</span>), <span class="st">"/data/figures"</span>)</span>
<span id="cb4-171"><a href="#cb4-171" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(dir)) <span class="fu">dir.create</span>(dir)</span>
<span id="cb4-172"><a href="#cb4-172" aria-hidden="true" tabindex="-1"></a>        file <span class="ot">&lt;-</span> <span class="fu">paste0</span>(dir, <span class="st">"/flowchart_%group_id%_%study_id%.png"</span>)</span>
<span id="cb4-173"><a href="#cb4-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-174"><a href="#cb4-174" aria-hidden="true" tabindex="-1"></a>        DiagrammeR<span class="sc">::</span><span class="fu">grViz</span>(flowchart_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span>()) <span class="sc">%&gt;%</span> DiagrammeRsvg<span class="sc">::</span><span class="fu">export_svg</span>() <span class="sc">%&gt;%</span> <span class="fu">charToRaw</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb4-175"><a href="#cb4-175" aria-hidden="true" tabindex="-1"></a>            rsvg<span class="sc">::</span><span class="fu">rsvg_png</span>(file, <span class="at">height =</span> r<span class="sc">$</span>flowchart_height_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span>)</span>
<span id="cb4-176"><a href="#cb4-176" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-177"><a href="#cb4-177" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Copy the code to user clipboard</span></span>
<span id="cb4-178"><a href="#cb4-178" aria-hidden="true" tabindex="-1"></a>        clipr<span class="sc">::</span><span class="fu">write_clip</span>(<span class="fu">paste0</span>(<span class="st">"`r knitr::include_graphics('"</span>, file, <span class="st">"')`"</span>))</span>
<span id="cb4-179"><a href="#cb4-179" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-180"><a href="#cb4-180" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb4-181"><a href="#cb4-181" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> output<span class="sc">$</span>message_bar_2_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span> <span class="er">&lt;</span><span class="sc">-</span> <span class="fu">renderUI</span>(</span>
<span id="cb4-182"><a href="#cb4-182" aria-hidden="true" tabindex="-1"></a>        <span class="fu">div</span>(shiny.fluent<span class="sc">::</span><span class="fu">MessageBar</span>(<span class="fu">translate</span>(language, <span class="st">"clipr_required"</span>, new_words), <span class="at">messageBarType =</span> <span class="dv">3</span>), <span class="at">style =</span> <span class="st">"margin-top:10px;"</span>))</span>
<span id="cb4-183"><a href="#cb4-183" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb4-184"><a href="#cb4-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-185"><a href="#cb4-185" aria-hidden="true" tabindex="-1"></a><span class="do">##########################################</span></span>
<span id="cb4-186"><a href="#cb4-186" aria-hidden="true" tabindex="-1"></a><span class="co"># Save settings                          #</span></span>
<span id="cb4-187"><a href="#cb4-187" aria-hidden="true" tabindex="-1"></a><span class="do">##########################################</span></span>
<span id="cb4-188"><a href="#cb4-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-189"><a href="#cb4-189" aria-hidden="true" tabindex="-1"></a><span class="fu">observeEvent</span>(input<span class="sc">$</span>flowchart_save_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span>, {</span>
<span id="cb4-190"><a href="#cb4-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-191"><a href="#cb4-191" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tryCatch</span>({</span>
<span id="cb4-192"><a href="#cb4-192" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-193"><a href="#cb4-193" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sapply</span>(<span class="fu">c</span>(<span class="st">"width"</span>, <span class="st">"height"</span>), <span class="cf">function</span>(attr){</span>
<span id="cb4-194"><a href="#cb4-194" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-195"><a href="#cb4-195" aria-hidden="true" tabindex="-1"></a>            sql <span class="ot">&lt;-</span> glue<span class="sc">::</span><span class="fu">glue_sql</span>(<span class="st">"UPDATE modules_elements_options SET value_num = {input[[paste0('flowchart_', attr, '_%group_id%_%study_id%')]]}</span></span>
<span id="cb4-196"><a href="#cb4-196" aria-hidden="true" tabindex="-1"></a><span class="st">                WHERE category = 'aggregated' AND name = {paste0('flowchart_', attr)} AND group_id = %group_id% AND study_id = %study_id% AND deleted IS FALSE"</span>, <span class="at">.con =</span> r<span class="sc">$</span>db)</span>
<span id="cb4-197"><a href="#cb4-197" aria-hidden="true" tabindex="-1"></a>            query <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbSendStatement</span>(r<span class="sc">$</span>db, sql)</span>
<span id="cb4-198"><a href="#cb4-198" aria-hidden="true" tabindex="-1"></a>            DBI<span class="sc">::</span><span class="fu">dbClearResult</span>(query)</span>
<span id="cb4-199"><a href="#cb4-199" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb4-200"><a href="#cb4-200" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-201"><a href="#cb4-201" aria-hidden="true" tabindex="-1"></a>        <span class="fu">show_message_bar</span>(output, <span class="dv">1</span>, <span class="st">"modif_saved"</span>, <span class="st">"success"</span>, language, r<span class="sc">$</span>words)</span>
<span id="cb4-202"><a href="#cb4-202" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb4-203"><a href="#cb4-203" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-204"><a href="#cb4-204" aria-hidden="true" tabindex="-1"></a>    <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cf">if</span> (<span class="fu">nchar</span>(e[<span class="dv">1</span>]) <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="fu">report_bug</span>(<span class="at">r =</span> r, <span class="at">output =</span> output, <span class="at">error_message =</span> <span class="st">"error_run_plugin_server_code"</span>, </span>
<span id="cb4-205"><a href="#cb4-205" aria-hidden="true" tabindex="-1"></a>      <span class="at">error_name =</span> <span class="st">"%group_id% - run server code"</span>, <span class="at">category =</span> <span class="st">"Error"</span>, <span class="at">error_report =</span> <span class="fu">toString</span>(e), <span class="at">language =</span> language),</span>
<span id="cb4-206"><a href="#cb4-206" aria-hidden="true" tabindex="-1"></a>    <span class="at">warning =</span> <span class="cf">function</span>(w) <span class="cf">if</span> (<span class="fu">nchar</span>(w[<span class="dv">1</span>]) <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="fu">report_bug</span>(<span class="at">r =</span> r, <span class="at">output =</span> output, <span class="at">error_message =</span> <span class="st">"error_run_plugin_server_code"</span>, </span>
<span id="cb4-207"><a href="#cb4-207" aria-hidden="true" tabindex="-1"></a>      <span class="at">error_name =</span> <span class="st">"%group_id% - run server code"</span>, <span class="at">category =</span> <span class="st">"Warning"</span>, <span class="at">error_report =</span> <span class="fu">toString</span>(w), <span class="at">language =</span> language))</span>
<span id="cb4-208"><a href="#cb4-208" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="report">Report<a class="anchor" aria-label="anchor" href="#report"></a>
</h2>
<div class="section level3">
<h3 id="description-3">Description<a class="anchor" aria-label="anchor" href="#description-3"></a>
</h3>
<ul>
<li>
<strong>Version</strong> : 0.0.1</li>
<li>
<strong>Libraries</strong> : none</li>
</ul>
</div>
<div class="section level3">
<h3 id="ui-code-3">UI code<a class="anchor" aria-label="anchor" href="#ui-code-3"></a>
</h3>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">temp</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span><span class="op">{</span>
    
    <span class="co">##########################################</span>
    <span class="co"># Translations                           #</span>
    <span class="co">##########################################</span>
    
    <span class="va">new_words</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html" class="external-link">tribble</a></span><span class="op">(</span><span class="op">~</span><span class="va">language</span>, <span class="op">~</span><span class="va">reference_word</span>, <span class="op">~</span><span class="va">translated_word</span>,
        <span class="st">"EN"</span>, <span class="st">"abstract"</span>, <span class="st">"Abstract"</span>,
        <span class="st">"FR"</span>, <span class="st">"abstract"</span>, <span class="st">"Abstract"</span>,
        <span class="st">"EN"</span>, <span class="st">"intro"</span>, <span class="st">"Intro"</span>,
        <span class="st">"FR"</span>, <span class="st">"intro"</span>, <span class="st">"Intro"</span>,
        <span class="st">"EN"</span>, <span class="st">"methods"</span>, <span class="st">"Methods"</span>,
        <span class="st">"FR"</span>, <span class="st">"methods"</span>, <span class="st">"Matériels &amp; méthodes"</span>,
        <span class="st">"EN"</span>, <span class="st">"results"</span>, <span class="st">"Results"</span>,
        <span class="st">"FR"</span>, <span class="st">"results"</span>, <span class="st">"Résultats"</span>,
        <span class="st">"EN"</span>, <span class="st">"discussion"</span>, <span class="st">"Discussion"</span>,
        <span class="st">"FR"</span>, <span class="st">"discussion"</span>, <span class="st">"Discussion"</span>,
        <span class="st">"EN"</span>, <span class="st">"conclusion"</span>, <span class="st">"Conclusion"</span>,
        <span class="st">"FR"</span>, <span class="st">"conclusion"</span>, <span class="st">"Conclusion"</span>,
        <span class="st">"EN"</span>, <span class="st">"preview"</span>, <span class="st">"Preview"</span>,
        <span class="st">"FR"</span>, <span class="st">"preview"</span>, <span class="st">"Aperçu"</span>,
        <span class="st">"EN"</span>, <span class="st">"format"</span>, <span class="st">"Format"</span>,
        <span class="st">"FR"</span>, <span class="st">"format"</span>, <span class="st">"Format"</span>,
        <span class="st">"EN"</span>, <span class="st">"export"</span>, <span class="st">"Export"</span>,
        <span class="st">"FR"</span>, <span class="st">"export"</span>, <span class="st">"Exporter"</span>
    <span class="op">)</span>
    
    <span class="co">##########################################</span>
    <span class="co"># Get current values                     #</span>
    <span class="co">##########################################</span>
    
    <span class="va">pages</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"abstract"</span>, <span class="st">"intro"</span>, <span class="st">"methods"</span>, <span class="st">"results"</span>, <span class="st">"discussion"</span>, <span class="st">"conclusion"</span><span class="op">)</span>
    
    <span class="va">report_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>
    
    <span class="kw"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">tryCatch</a></span><span class="op">(</span><span class="op">{</span>
        <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">pages</span>, <span class="kw">function</span><span class="op">(</span><span class="va">page</span><span class="op">)</span><span class="op">{</span>
        
            <span class="va">sql</span> <span class="op">&lt;-</span> <span class="fu">glue</span><span class="fu">::</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue_sql.html" class="external-link">glue_sql</a></span><span class="op">(</span><span class="st">"SELECT id, value, creator_id, datetime FROM modules_elements_options WHERE deleted IS FALSE
                AND group_id = %group_id% AND study_id = %study_id% AND category = 'aggregated' AND name = {paste0('report_', page)}"</span>, .con <span class="op">=</span> <span class="va">r</span><span class="op">$</span><span class="va">db</span><span class="op">)</span>
            <span class="va">report_data</span><span class="op">[[</span><span class="va">page</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;&lt;-</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html" class="external-link">dbGetQuery</a></span><span class="op">(</span><span class="va">r</span><span class="op">$</span><span class="va">db</span>, <span class="va">sql</span><span class="op">)</span>
            
            <span class="co"># If there's noy any value yet</span>
            <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">report_data</span><span class="op">[[</span><span class="va">page</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span><span class="op">{</span>
            
                <span class="va">sql</span> <span class="op">&lt;-</span> <span class="fu">glue</span><span class="fu">::</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue_sql.html" class="external-link">glue_sql</a></span><span class="op">(</span><span class="st">"INSERT INTO modules_elements_options(id, group_id, study_id, category, name, value, creator_id, datetime, deleted)
                    SELECT {get_last_row(r$db, 'modules_elements_options') + 1}, %group_id%, %study_id%, 'aggregated', {paste0('report_', page)}, '', {r$user_id}, 
                    {as.character(Sys.time())}, FALSE"</span>, .con <span class="op">=</span> <span class="va">r</span><span class="op">$</span><span class="va">db</span><span class="op">)</span>
                    
                <span class="va">query</span> <span class="op">&lt;-</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbSendStatement.html" class="external-link">dbSendStatement</a></span><span class="op">(</span><span class="va">r</span><span class="op">$</span><span class="va">db</span>, <span class="va">sql</span><span class="op">)</span>
                <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbClearResult.html" class="external-link">dbClearResult</a></span><span class="op">(</span><span class="va">query</span><span class="op">)</span>
            <span class="op">}</span>
        <span class="op">}</span><span class="op">)</span>
    <span class="op">}</span>,
    error <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nchar.html" class="external-link">nchar</a></span><span class="op">(</span><span class="va">e</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="fu"><a href="../reference/report_bug.html">report_bug</a></span><span class="op">(</span>r <span class="op">=</span> <span class="va">r</span>, output <span class="op">=</span> <span class="va">output</span>, error_message <span class="op">=</span> <span class="st">"error_run_plugin_ui_code"</span>, 
        error_name <span class="op">=</span> <span class="st">"%group_id% - run ui code"</span>, category <span class="op">=</span> <span class="st">"Error"</span>, error_report <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/toString.html" class="external-link">toString</a></span><span class="op">(</span><span class="va">e</span><span class="op">)</span>, language <span class="op">=</span> <span class="va">language</span><span class="op">)</span>,
    warning <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">w</span><span class="op">)</span> <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nchar.html" class="external-link">nchar</a></span><span class="op">(</span><span class="va">w</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="fu"><a href="../reference/report_bug.html">report_bug</a></span><span class="op">(</span>r <span class="op">=</span> <span class="va">r</span>, output <span class="op">=</span> <span class="va">output</span>, error_message <span class="op">=</span> <span class="st">"error_run_plugin_ui_code"</span>, 
        error_name <span class="op">=</span> <span class="st">"%group_id% - run ui code"</span>, category <span class="op">=</span> <span class="st">"Warning"</span>, error_report <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/toString.html" class="external-link">toString</a></span><span class="op">(</span><span class="va">w</span><span class="op">)</span>, language <span class="op">=</span> <span class="va">language</span><span class="op">)</span><span class="op">)</span>
    
    <span class="co">##########################################</span>
    <span class="co"># Render UI                              #</span>
    <span class="co">##########################################</span>
    
    <span class="va">pages</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"abstract"</span>, <span class="st">"intro"</span>, <span class="st">"methods"</span>, <span class="st">"results"</span>, <span class="st">"discussion"</span>, <span class="st">"conclusion"</span><span class="op">)</span>
    
    <span class="va">ace_editor</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">page</span><span class="op">)</span><span class="op">{</span>
        <span class="fu">conditionalPanel</span><span class="op">(</span>condition <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"input.report_page_%group_id%_%study_id% == '"</span>, <span class="va">page</span>, <span class="st">"'"</span><span class="op">)</span>, ns <span class="op">=</span> <span class="va">ns</span>,
            <span class="fu">div</span><span class="op">(</span><span class="fu">shinyAce</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/shinyAce/man/aceEditor.html" class="external-link">aceEditor</a></span><span class="op">(</span><span class="fu">ns</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"ace_editor_"</span>, <span class="va">page</span>, <span class="st">"_%group_id%_%study_id%"</span><span class="op">)</span><span class="op">)</span>, value <span class="op">=</span> <span class="va">report_data</span><span class="op">[[</span><span class="va">page</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">value</span>,
                mode <span class="op">=</span> <span class="st">"markdown"</span>, autoScrollEditorIntoView <span class="op">=</span> <span class="cn">TRUE</span>, minLines <span class="op">=</span> <span class="fl">30</span>, maxLines <span class="op">=</span> <span class="fl">2000</span><span class="op">)</span>, style <span class="op">=</span> <span class="st">"width: 100%;"</span><span class="op">)</span><span class="op">)</span>
    <span class="op">}</span>
    
    <span class="va">ace_editors</span> <span class="op">&lt;-</span> <span class="fu">tagList</span><span class="op">(</span><span class="op">)</span>
    <span class="va">options</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>
    
    <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">pages</span>, <span class="kw">function</span><span class="op">(</span><span class="va">page</span><span class="op">)</span><span class="op">{</span>
        <span class="va">ace_editors</span> <span class="op">&lt;&lt;-</span> <span class="fu">tagList</span><span class="op">(</span><span class="va">ace_editors</span>, <span class="fu">ace_editor</span><span class="op">(</span><span class="va">page</span><span class="op">)</span><span class="op">)</span>
        <span class="va">options</span> <span class="op">&lt;&lt;-</span> <span class="fu">rlist</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rlist/man/list.append.html" class="external-link">list.append</a></span><span class="op">(</span><span class="va">options</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>key <span class="op">=</span> <span class="va">page</span>, text <span class="op">=</span> <span class="fu"><a href="../reference/translate.html">translate</a></span><span class="op">(</span><span class="va">language</span>, <span class="va">page</span>, <span class="va">new_words</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>    
    <span class="op">}</span><span class="op">)</span>
    
    <span class="fu">tagList</span><span class="op">(</span>
        <span class="fu">shiny.fluent</span><span class="fu">::</span><span class="fu"><a href="https://appsilon.github.io/shiny.fluent/reference/ChoiceGroup.html" class="external-link">ChoiceGroup.shinyInput</a></span><span class="op">(</span><span class="fu">ns</span><span class="op">(</span><span class="st">"report_page_%group_id%_%study_id%"</span><span class="op">)</span>, value <span class="op">=</span> <span class="st">"abstract"</span>, options <span class="op">=</span> <span class="va">options</span>, className <span class="op">=</span> <span class="st">"inline_choicegroup"</span><span class="op">)</span>,
        <span class="va">ace_editors</span>,
        <span class="fu">shiny.fluent</span><span class="fu">::</span><span class="fu"><a href="https://appsilon.github.io/shiny.fluent/reference/Stack.html" class="external-link">Stack</a></span><span class="op">(</span>horizontal <span class="op">=</span> <span class="cn">TRUE</span>, tokens <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>childrenGap <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>,
            <span class="fu">shiny.fluent</span><span class="fu">::</span><span class="fu"><a href="https://appsilon.github.io/shiny.fluent/reference/Button.html" class="external-link">PrimaryButton.shinyInput</a></span><span class="op">(</span><span class="fu">ns</span><span class="op">(</span><span class="st">"report_save_%group_id%_%study_id%"</span><span class="op">)</span>, <span class="fu"><a href="../reference/translate.html">translate</a></span><span class="op">(</span><span class="va">language</span>, <span class="st">"save"</span>, <span class="va">r</span><span class="op">$</span><span class="va">words</span><span class="op">)</span><span class="op">)</span>,
            <span class="fu">shiny.fluent</span><span class="fu">::</span><span class="fu"><a href="https://appsilon.github.io/shiny.fluent/reference/Button.html" class="external-link">DefaultButton.shinyInput</a></span><span class="op">(</span><span class="fu">ns</span><span class="op">(</span><span class="st">"report_preview_%group_id%_%study_id%"</span><span class="op">)</span>, <span class="fu"><a href="../reference/translate.html">translate</a></span><span class="op">(</span><span class="va">language</span>, <span class="st">"preview"</span>, <span class="va">new_words</span><span class="op">)</span><span class="op">)</span>,
            <span class="fu">div</span><span class="op">(</span><span class="fu">shiny.fluent</span><span class="fu">::</span><span class="fu"><a href="https://appsilon.github.io/shiny.fluent/reference/Dropdown.html" class="external-link">Dropdown.shinyInput</a></span><span class="op">(</span><span class="fu">ns</span><span class="op">(</span><span class="st">"report_export_format_%group_id%_%study_id%"</span><span class="op">)</span>, <span class="fu"><a href="../reference/translate.html">translate</a></span><span class="op">(</span><span class="va">language</span>, <span class="st">"format"</span>, <span class="va">new_words</span><span class="op">)</span>,
                options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>key <span class="op">=</span> <span class="st">"pdf"</span>, text <span class="op">=</span> <span class="st">"PDF"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>key <span class="op">=</span> <span class="st">"html"</span>, text <span class="op">=</span> <span class="st">"HTML"</span><span class="op">)</span><span class="op">)</span>, value <span class="op">=</span> <span class="st">"pdf"</span><span class="op">)</span>, style <span class="op">=</span> <span class="st">"width:80px"</span><span class="op">)</span>,
            <span class="fu">shiny.fluent</span><span class="fu">::</span><span class="fu"><a href="https://appsilon.github.io/shiny.fluent/reference/Button.html" class="external-link">DefaultButton.shinyInput</a></span><span class="op">(</span><span class="fu">ns</span><span class="op">(</span><span class="st">"report_export_button_%group_id%_%study_id%"</span><span class="op">)</span>, <span class="fu"><a href="../reference/translate.html">translate</a></span><span class="op">(</span><span class="va">language</span>, <span class="st">"export"</span>, <span class="va">new_words</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,
        <span class="fu">br</span><span class="op">(</span><span class="op">)</span>,
        <span class="fu">div</span><span class="op">(</span><span class="fu">downloadButton</span><span class="op">(</span><span class="fu">ns</span><span class="op">(</span><span class="st">"report_export_%group_id%_%study_id%"</span><span class="op">)</span><span class="op">)</span>, style <span class="op">=</span> <span class="st">"display:none;"</span><span class="op">)</span>,
        <span class="fu">div</span><span class="op">(</span><span class="fu">uiOutput</span><span class="op">(</span><span class="fu">ns</span><span class="op">(</span><span class="st">"report_preview_ui_%group_id%_%study_id%"</span><span class="op">)</span><span class="op">)</span>, style <span class="op">=</span> <span class="st">"border:dashed 1px; min-height:40px; padding-left:10px; padding-right:10px;"</span><span class="op">)</span>
    <span class="op">)</span>
<span class="op">}</span>

<span class="fu">temp</span><span class="op">(</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="server-code-3">Server code<a class="anchor" aria-label="anchor" href="#server-code-3"></a>
</h3>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Careful : hidden dependency : "webshot" and phantomJS with install.packages("phantomJS")</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="do">##########################################</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Translations                           #</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="do">##########################################</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>new_words <span class="ot">&lt;-</span> tibble<span class="sc">::</span><span class="fu">tribble</span>(<span class="sc">~</span>language, <span class="sc">~</span>reference_word, <span class="sc">~</span>translated_word,</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"EN"</span>, <span class="st">"report"</span>, <span class="st">"report"</span>,</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"FR"</span>, <span class="st">"report"</span>, <span class="st">"article"</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="do">##########################################</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Save editors                           #</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="do">##########################################</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a><span class="fu">observeEvent</span>(input<span class="sc">$</span>report_save_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span>, {</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>    pages <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"abstract"</span>, <span class="st">"intro"</span>, <span class="st">"methods"</span>, <span class="st">"results"</span>, <span class="st">"discussion"</span>, <span class="st">"conclusion"</span>)</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tryCatch</span>({</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sapply</span>(pages, <span class="cf">function</span>(page){</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>            sql <span class="ot">&lt;-</span> glue<span class="sc">::</span><span class="fu">glue_sql</span>(<span class="st">"UPDATE modules_elements_options SET value = {input[[paste0('ace_editor_', page, '_%group_id%_%study_id%')]]}, creator_id = {r$user_id}, datetime = {as.character(Sys.time())}</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a><span class="st">                WHERE deleted IS FALSE AND group_id = %group_id% AND study_id = %study_id% AND category = 'aggregated' AND name = {paste0('report_', page)}"</span> ,<span class="at">.con =</span> r<span class="sc">$</span>db)</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>            query <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbSendStatement</span>(r<span class="sc">$</span>db, sql)</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>            DBI<span class="sc">::</span><span class="fu">dbClearResult</span>(query)</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>        <span class="fu">show_message_bar</span>(output, <span class="dv">1</span>, <span class="fu">translate</span>(language, <span class="st">"modif_saved"</span>, r<span class="sc">$</span>words), <span class="st">"success"</span>, language)</span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cf">if</span> (<span class="fu">nchar</span>(e[<span class="dv">1</span>]) <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="fu">report_bug</span>(<span class="at">r =</span> r, <span class="at">output =</span> output, <span class="at">error_message =</span> <span class="st">"error_run_plugin_server_code"</span>, </span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>        <span class="at">error_name =</span> <span class="st">"%group_id% - run server code"</span>, <span class="at">category =</span> <span class="st">"Error"</span>, <span class="at">error_report =</span> <span class="fu">toString</span>(e), <span class="at">language =</span> language),</span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">warning =</span> <span class="cf">function</span>(w) <span class="cf">if</span> (<span class="fu">nchar</span>(w[<span class="dv">1</span>]) <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="fu">report_bug</span>(<span class="at">r =</span> r, <span class="at">output =</span> output, <span class="at">error_message =</span> <span class="st">"error_run_plugin_server_code"</span>, </span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>        <span class="at">error_name =</span> <span class="st">"%group_id% - run server code"</span>, <span class="at">category =</span> <span class="st">"Warning"</span>, <span class="at">error_report =</span> <span class="fu">toString</span>(w), <span class="at">language =</span> language))</span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a><span class="do">##########################################</span></span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Preview                                #</span></span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a><span class="do">##########################################</span></span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a><span class="fu">observeEvent</span>(input<span class="sc">$</span>report_preview_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span>, {</span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a>    output<span class="sc">$</span>report_preview_ui_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span> <span class="er">&lt;</span><span class="sc">-</span> <span class="fu">renderUI</span>({</span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a>        <span class="fu">tryCatch</span>({</span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Clear temp dir</span></span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a>            <span class="fu">unlink</span>(<span class="fu">paste0</span>(<span class="fu">find.package</span>(<span class="st">"cdwtools"</span>), <span class="st">"/data/temp"</span>), <span class="at">recursive =</span> <span class="cn">TRUE</span>, <span class="at">force =</span> <span class="cn">TRUE</span>)</span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a>            markdown_file <span class="ot">&lt;-</span> <span class="fu">isolate</span>(input[[<span class="fu">paste0</span>(<span class="st">"ace_editor_"</span>, input<span class="sc">$</span>report_page_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span>, <span class="st">"_%group_id%_%study_id%"</span>)]]) <span class="sc">%&gt;%</span></span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a>                stringr<span class="sc">::</span><span class="fu">str_replace_all</span>(<span class="st">"</span><span class="sc">\r</span><span class="st">"</span>, <span class="st">""</span>)</span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Create temp dir</span></span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true" tabindex="-1"></a>            dir <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="fu">find.package</span>(<span class="st">"cdwtools"</span>), <span class="st">"/data/temp"</span>)</span>
<span id="cb6-56"><a href="#cb6-56" aria-hidden="true" tabindex="-1"></a>            file <span class="ot">&lt;-</span> <span class="fu">paste0</span>(dir, <span class="st">"/"</span>, <span class="fu">as.character</span>(<span class="fu">Sys.time</span>()) <span class="sc">%&gt;%</span> stringr<span class="sc">::</span><span class="fu">str_replace_all</span>(<span class="st">":"</span>, <span class="st">"_"</span>), <span class="st">".Md"</span>)</span>
<span id="cb6-57"><a href="#cb6-57" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(dir)) <span class="fu">dir.create</span>(dir)</span>
<span id="cb6-58"><a href="#cb6-58" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb6-59"><a href="#cb6-59" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Create the markdown file</span></span>
<span id="cb6-60"><a href="#cb6-60" aria-hidden="true" tabindex="-1"></a>            knitr<span class="sc">::</span><span class="fu">knit</span>(<span class="at">text =</span> markdown_file, <span class="at">output =</span> file, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb6-61"><a href="#cb6-61" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb6-62"><a href="#cb6-62" aria-hidden="true" tabindex="-1"></a>            <span class="fu">withMathJax</span>(<span class="fu">includeMarkdown</span>(file))</span>
<span id="cb6-63"><a href="#cb6-63" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="cb6-64"><a href="#cb6-64" aria-hidden="true" tabindex="-1"></a>        <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cf">if</span> (<span class="fu">nchar</span>(e[<span class="dv">1</span>]) <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="fu">report_bug</span>(<span class="at">r =</span> r, <span class="at">output =</span> output, <span class="at">error_message =</span> <span class="st">"error_run_plugin_server_code"</span>, </span>
<span id="cb6-65"><a href="#cb6-65" aria-hidden="true" tabindex="-1"></a>            <span class="at">error_name =</span> <span class="st">"%group_id% - run server code"</span>, <span class="at">category =</span> <span class="st">"Error"</span>, <span class="at">error_report =</span> <span class="fu">toString</span>(e), <span class="at">language =</span> language),</span>
<span id="cb6-66"><a href="#cb6-66" aria-hidden="true" tabindex="-1"></a>        <span class="at">warning =</span> <span class="cf">function</span>(w) <span class="cf">if</span> (<span class="fu">nchar</span>(w[<span class="dv">1</span>]) <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="fu">report_bug</span>(<span class="at">r =</span> r, <span class="at">output =</span> output, <span class="at">error_message =</span> <span class="st">"error_run_plugin_server_code"</span>, </span>
<span id="cb6-67"><a href="#cb6-67" aria-hidden="true" tabindex="-1"></a>            <span class="at">error_name =</span> <span class="st">"%group_id% - run server code"</span>, <span class="at">category =</span> <span class="st">"Warning"</span>, <span class="at">error_report =</span> <span class="fu">toString</span>(w), <span class="at">language =</span> language))</span>
<span id="cb6-68"><a href="#cb6-68" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb6-69"><a href="#cb6-69" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb6-70"><a href="#cb6-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-71"><a href="#cb6-71" aria-hidden="true" tabindex="-1"></a><span class="do">##########################################</span></span>
<span id="cb6-72"><a href="#cb6-72" aria-hidden="true" tabindex="-1"></a><span class="co"># Export                                 #</span></span>
<span id="cb6-73"><a href="#cb6-73" aria-hidden="true" tabindex="-1"></a><span class="do">##########################################</span></span>
<span id="cb6-74"><a href="#cb6-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-75"><a href="#cb6-75" aria-hidden="true" tabindex="-1"></a><span class="fu">observeEvent</span>(input<span class="sc">$</span>report_export_button_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span>, {</span>
<span id="cb6-76"><a href="#cb6-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-77"><a href="#cb6-77" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tryCatch</span>({</span>
<span id="cb6-78"><a href="#cb6-78" aria-hidden="true" tabindex="-1"></a>        pages <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"abstract"</span>, <span class="st">"intro"</span>, <span class="st">"methods"</span>, <span class="st">"results"</span>, <span class="st">"discussion"</span>, <span class="st">"conclusion"</span>)</span>
<span id="cb6-79"><a href="#cb6-79" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb6-80"><a href="#cb6-80" aria-hidden="true" tabindex="-1"></a>        report_pages <span class="ot">&lt;-</span> <span class="st">""</span></span>
<span id="cb6-81"><a href="#cb6-81" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sapply</span>(pages, <span class="cf">function</span>(page){</span>
<span id="cb6-82"><a href="#cb6-82" aria-hidden="true" tabindex="-1"></a>            report_pages <span class="ot">&lt;&lt;-</span> <span class="fu">paste0</span>(report_pages, <span class="fu">paste0</span>(input[[<span class="fu">paste0</span>(<span class="st">"ace_editor_"</span>, page, <span class="st">"_%group_id%_%study_id%"</span>)]], <span class="st">"</span><span class="sc">\n\n</span><span class="st">"</span>))</span>
<span id="cb6-83"><a href="#cb6-83" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb6-84"><a href="#cb6-84" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-85"><a href="#cb6-85" aria-hidden="true" tabindex="-1"></a>        report <span class="ot">&lt;-</span> <span class="fu">paste0</span>(</span>
<span id="cb6-86"><a href="#cb6-86" aria-hidden="true" tabindex="-1"></a>            <span class="st">"---</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb6-87"><a href="#cb6-87" aria-hidden="true" tabindex="-1"></a>            <span class="st">"title: 'Test'</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb6-88"><a href="#cb6-88" aria-hidden="true" tabindex="-1"></a>            <span class="st">"output: "</span>, input<span class="sc">$</span>report_export_format_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span>, <span class="st">"_document</span><span class="sc">\n</span><span class="st">"</span> ,</span>
<span id="cb6-89"><a href="#cb6-89" aria-hidden="true" tabindex="-1"></a>            <span class="st">"---</span><span class="sc">\n\n</span><span class="st">"</span>,</span>
<span id="cb6-90"><a href="#cb6-90" aria-hidden="true" tabindex="-1"></a>            report_pages</span>
<span id="cb6-91"><a href="#cb6-91" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb6-92"><a href="#cb6-92" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-93"><a href="#cb6-93" aria-hidden="true" tabindex="-1"></a>        params <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb6-94"><a href="#cb6-94" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-95"><a href="#cb6-95" aria-hidden="true" tabindex="-1"></a>        study_name <span class="ot">&lt;-</span> r<span class="sc">$</span>studies <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(id <span class="sc">==</span> input<span class="sc">$</span>study) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">pull</span>(name)</span>
<span id="cb6-96"><a href="#cb6-96" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb6-97"><a href="#cb6-97" aria-hidden="true" tabindex="-1"></a>        filename <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="fu">find.package</span>(<span class="st">"cdwtools"</span>), <span class="st">"/data/temp/"</span>, <span class="fu">as.character</span>(<span class="fu">Sys.Date</span>()), <span class="st">" - "</span> , study_name, <span class="st">" - "</span>, <span class="fu">translate</span>(language, <span class="st">"report"</span>, new_words))</span>
<span id="cb6-98"><a href="#cb6-98" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-99"><a href="#cb6-99" aria-hidden="true" tabindex="-1"></a>        <span class="fu">writeLines</span>(report, <span class="fu">paste0</span>(filename, <span class="st">".Rmd"</span>))</span>
<span id="cb6-100"><a href="#cb6-100" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-101"><a href="#cb6-101" aria-hidden="true" tabindex="-1"></a>        rmarkdown<span class="sc">::</span><span class="fu">render</span>(</span>
<span id="cb6-102"><a href="#cb6-102" aria-hidden="true" tabindex="-1"></a>            <span class="at">input =</span> <span class="fu">paste0</span>(filename, <span class="st">".Rmd"</span>),</span>
<span id="cb6-103"><a href="#cb6-103" aria-hidden="true" tabindex="-1"></a>            <span class="at">output_format =</span> <span class="fu">paste0</span>(input<span class="sc">$</span>report_export_format_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span>, <span class="st">"_document"</span>),</span>
<span id="cb6-104"><a href="#cb6-104" aria-hidden="true" tabindex="-1"></a>            <span class="at">output_file =</span> <span class="fu">paste0</span>(filename, <span class="st">"."</span>, input<span class="sc">$</span>report_export_format_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span>), <span class="at">envir =</span> <span class="fu">new.env</span>(<span class="at">parent =</span> <span class="fu">globalenv</span>()))</span>
<span id="cb6-105"><a href="#cb6-105" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb6-106"><a href="#cb6-106" aria-hidden="true" tabindex="-1"></a>    <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cf">if</span> (<span class="fu">nchar</span>(e[<span class="dv">1</span>]) <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="fu">report_bug</span>(<span class="at">r =</span> r, <span class="at">output =</span> output, <span class="at">error_message =</span> <span class="st">"error_run_plugin_server_code"</span>, </span>
<span id="cb6-107"><a href="#cb6-107" aria-hidden="true" tabindex="-1"></a>        <span class="at">error_name =</span> <span class="st">"%group_id% - run server code"</span>, <span class="at">category =</span> <span class="st">"Error"</span>, <span class="at">error_report =</span> <span class="fu">toString</span>(e), <span class="at">language =</span> language),</span>
<span id="cb6-108"><a href="#cb6-108" aria-hidden="true" tabindex="-1"></a>    <span class="at">warning =</span> <span class="cf">function</span>(w) <span class="cf">if</span> (<span class="fu">nchar</span>(w[<span class="dv">1</span>]) <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="fu">report_bug</span>(<span class="at">r =</span> r, <span class="at">output =</span> output, <span class="at">error_message =</span> <span class="st">"error_run_plugin_server_code"</span>, </span>
<span id="cb6-109"><a href="#cb6-109" aria-hidden="true" tabindex="-1"></a>        <span class="at">error_name =</span> <span class="st">"%group_id% - run server code"</span>, <span class="at">category =</span> <span class="st">"Warning"</span>, <span class="at">error_report =</span> <span class="fu">toString</span>(w), <span class="at">language =</span> language))</span>
<span id="cb6-110"><a href="#cb6-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-111"><a href="#cb6-111" aria-hidden="true" tabindex="-1"></a>    <span class="co">#output$report_export_%group_id%_%study_id% &lt;- renderUI(shiny.fluent::Link("test",</span></span>
<span id="cb6-112"><a href="#cb6-112" aria-hidden="true" tabindex="-1"></a>    <span class="co">#    href = paste0(filename, ".", input$report_export_format_%group_id%_%study_id%)))</span></span>
<span id="cb6-113"><a href="#cb6-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-114"><a href="#cb6-114" aria-hidden="true" tabindex="-1"></a>    shinyjs<span class="sc">::</span><span class="fu">click</span>(<span class="st">"report_export_%group_id%_%study_id%"</span>)</span>
<span id="cb6-115"><a href="#cb6-115" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-116"><a href="#cb6-116" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb6-117"><a href="#cb6-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-118"><a href="#cb6-118" aria-hidden="true" tabindex="-1"></a>output<span class="sc">$</span>report_export_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span> <span class="er">&lt;</span><span class="sc">-</span> <span class="fu">downloadHandler</span>(</span>
<span id="cb6-119"><a href="#cb6-119" aria-hidden="true" tabindex="-1"></a>    <span class="at">filename =</span> <span class="cf">function</span>() {</span>
<span id="cb6-120"><a href="#cb6-120" aria-hidden="true" tabindex="-1"></a>        <span class="fu">paste</span>(<span class="st">"data-"</span>, <span class="fu">Sys.Date</span>(), <span class="st">".csv"</span>, <span class="at">sep=</span><span class="st">""</span>)</span>
<span id="cb6-121"><a href="#cb6-121" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb6-122"><a href="#cb6-122" aria-hidden="true" tabindex="-1"></a>    <span class="at">content =</span> <span class="cf">function</span>(file) {</span>
<span id="cb6-123"><a href="#cb6-123" aria-hidden="true" tabindex="-1"></a>        <span class="fu">write.csv</span>(tibble<span class="sc">::</span><span class="fu">tribble</span>(<span class="sc">~</span>id, <span class="dv">1</span>, <span class="dv">2</span>), file)</span>
<span id="cb6-124"><a href="#cb6-124" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb6-125"><a href="#cb6-125" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="bibliography">Bibliography<a class="anchor" aria-label="anchor" href="#bibliography"></a>
</h2>
<div class="section level3">
<h3 id="description-4">Description<a class="anchor" aria-label="anchor" href="#description-4"></a>
</h3>
<ul>
<li>
<strong>Version</strong> : 0.0.1</li>
<li>
<strong>Libraries</strong> : none</li>
</ul>
</div>
<div class="section level3">
<h3 id="ui-code-4">UI code<a class="anchor" aria-label="anchor" href="#ui-code-4"></a>
</h3>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">temp</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span><span class="op">{</span>

    <span class="co"># Translations</span>
    <span class="va">new_words</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html" class="external-link">tribble</a></span><span class="op">(</span><span class="op">~</span><span class="va">language</span>, <span class="op">~</span><span class="va">reference_word</span>, <span class="op">~</span><span class="va">translated_word</span>,
        <span class="st">"EN"</span>, <span class="st">"open_bib"</span>, <span class="st">"Open a bibliography"</span>,
        <span class="st">"FR"</span>, <span class="st">"open_bib"</span>, <span class="st">"Ouvrir une bibliographie"</span>,
        <span class="st">"EN"</span>, <span class="st">"manage_bib"</span>, <span class="st">"Manage bibliographies"</span>,
        <span class="st">"FR"</span>,<span class="st">" manage_bib"</span>, <span class="st">"Gérer les bibliographies"</span>,
        <span class="st">"EN"</span>, <span class="st">"bibliography"</span>, <span class="st">"Bibliography"</span>,
        <span class="st">"FR"</span>, <span class="st">"bibliography"</span>, <span class="st">"Bibliographie"</span>,
        <span class="st">"EN"</span>, <span class="st">"new_bib"</span>, <span class="st">"New bibliography"</span>,
        <span class="st">"FR"</span>, <span class="st">"new_bib"</span>, <span class="st">"Nouvelle bibliographie"</span>,
        <span class="st">"EN"</span>, <span class="st">"browse_bib"</span>, <span class="st">"Choose BibTeX file"</span>,
        <span class="st">"FR"</span>, <span class="st">"browse_bib"</span>, <span class="st">"Choisir un fichier BibTeX"</span>,
        <span class="st">"EN"</span>, <span class="st">"upload_bib"</span>, <span class="st">"Upload BibTeX file"</span>,
        <span class="st">"FR"</span>, <span class="st">"upload_bib"</span>, <span class="st">"Charger un fichier BibTeX"</span>,
        <span class="st">"EN"</span>, <span class="st">"import_bib_file"</span>, <span class="st">"Import a bibliography file"</span>,
        <span class="st">"FR"</span>, <span class="st">"import_bib_file"</span>, <span class="st">"Importer un fichier de bibliographie"</span>,
        <span class="st">"EN"</span>, <span class="st">"delete_bib"</span>, <span class="st">"Delete a bibliography"</span>,
        <span class="st">"FR"</span>, <span class="st">"delete_bib"</span>, <span class="st">"Supprimer une bibliographie"</span>,
        <span class="st">"EN"</span>, <span class="st">"file"</span>, <span class="st">"File"</span>,
        <span class="st">"FR"</span>, <span class="st">"file"</span>, <span class="st">"Fichier"</span>
    <span class="op">)</span>
    
    <span class="va">action_choice_options</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
        <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>key <span class="op">=</span> <span class="st">"open_bib"</span>, text <span class="op">=</span> <span class="fu"><a href="../reference/translate.html">translate</a></span><span class="op">(</span><span class="va">language</span>, <span class="st">"open_bib"</span>, <span class="va">new_words</span><span class="op">)</span><span class="op">)</span>,
        <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>key <span class="op">=</span> <span class="st">"manage_bib"</span>, text <span class="op">=</span> <span class="fu"><a href="../reference/translate.html">translate</a></span><span class="op">(</span><span class="va">language</span>, <span class="st">"manage_bib"</span>, <span class="va">new_words</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
        
    <span class="va">bib_options</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/convert_tibble_to_list.html">convert_tibble_to_list</a></span><span class="op">(</span><span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html" class="external-link">dbGetQuery</a></span><span class="op">(</span><span class="va">r</span><span class="op">$</span><span class="va">db</span>, <span class="st">"SELECT * FROM modules_elements_options WHERE DELETED IS FALSE AND group_id = %group_id% AND study_id = %study_id% AND name = 'bib_name'"</span><span class="op">)</span>, key_col <span class="op">=</span> <span class="st">"id"</span>, text_col <span class="op">=</span> <span class="st">"value"</span><span class="op">)</span>
    
    <span class="fu">div</span><span class="op">(</span>
        <span class="fu">shiny.fluent</span><span class="fu">::</span><span class="fu"><a href="https://appsilon.github.io/shiny.fluent/reference/ChoiceGroup.html" class="external-link">ChoiceGroup.shinyInput</a></span><span class="op">(</span><span class="fu">ns</span><span class="op">(</span><span class="st">"action_choice_%group_id%_%study_id%"</span><span class="op">)</span>, value <span class="op">=</span> <span class="st">"open_bib"</span>, options <span class="op">=</span> <span class="va">action_choice_options</span>, className <span class="op">=</span> <span class="st">"inline_choicegroup"</span><span class="op">)</span>,
        
        <span class="fu">conditionalPanel</span><span class="op">(</span>condition <span class="op">=</span> <span class="st">"input.action_choice_%group_id%_%study_id% == 'open_bib'"</span>, ns <span class="op">=</span> <span class="va">ns</span>,
            <span class="fu"><a href="../reference/make_dropdown.html">make_dropdown</a></span><span class="op">(</span>label <span class="op">=</span> <span class="st">"bibliography"</span>, id <span class="op">=</span> <span class="st">"bib_select_%group_id%_%study_id%"</span>, words <span class="op">=</span> <span class="va">new_words</span>, ns <span class="op">=</span> <span class="va">ns</span>, options <span class="op">=</span> <span class="va">bib_options</span>, width <span class="op">=</span> <span class="st">"300px"</span><span class="op">)</span>,
            <span class="fu">DT</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/DT/man/dataTableOutput.html" class="external-link">DTOutput</a></span><span class="op">(</span><span class="fu">ns</span><span class="op">(</span><span class="st">"bib_datatable_%group_id%_%study_id%"</span><span class="op">)</span><span class="op">)</span>
        <span class="op">)</span>,
        
        <span class="fu">conditionalPanel</span><span class="op">(</span>condition <span class="op">=</span> <span class="st">"input.action_choice_%group_id%_%study_id% == 'manage_bib'"</span>, ns <span class="op">=</span> <span class="va">ns</span>,
            <span class="fu">br</span><span class="op">(</span><span class="op">)</span>, <span class="fu">shiny.fluent</span><span class="fu">::</span><span class="fu"><a href="https://appsilon.github.io/shiny.fluent/reference/Text.html" class="external-link">Text</a></span><span class="op">(</span>variant <span class="op">=</span> <span class="st">"large"</span>, <span class="fu"><a href="../reference/translate.html">translate</a></span><span class="op">(</span><span class="va">language</span>, <span class="st">"new_bib"</span>, <span class="va">new_words</span><span class="op">)</span>, block <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
            <span class="fu">shiny.fluent</span><span class="fu">::</span><span class="fu"><a href="https://appsilon.github.io/shiny.fluent/reference/Stack.html" class="external-link">Stack</a></span><span class="op">(</span>horizontal <span class="op">=</span> <span class="cn">TRUE</span>, tokens <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>childrenGap <span class="op">=</span> <span class="fl">20</span><span class="op">)</span>,
                <span class="fu"><a href="../reference/make_textfield.html">make_textfield</a></span><span class="op">(</span>label <span class="op">=</span> <span class="st">"name"</span>, id <span class="op">=</span> <span class="st">"new_bib_name_%group_id%_%study_id%"</span>, ns <span class="op">=</span> <span class="va">ns</span>, width <span class="op">=</span> <span class="st">"300px"</span><span class="op">)</span>,
                <span class="fu">div</span><span class="op">(</span><span class="fu">shiny.fluent</span><span class="fu">::</span><span class="fu"><a href="https://appsilon.github.io/shiny.fluent/reference/Button.html" class="external-link">PrimaryButton.shinyInput</a></span><span class="op">(</span><span class="fu">ns</span><span class="op">(</span><span class="st">"new_bib_add_%group_id%_%study_id%"</span><span class="op">)</span>, <span class="fu"><a href="../reference/translate.html">translate</a></span><span class="op">(</span><span class="va">language</span>, <span class="st">"add"</span>, <span class="va">r</span><span class="op">$</span><span class="va">words</span><span class="op">)</span><span class="op">)</span>, style <span class="op">=</span> <span class="st">"padding-top:38px;"</span><span class="op">)</span>
            <span class="op">)</span>,
            <span class="fu">br</span><span class="op">(</span><span class="op">)</span>, <span class="fu">hr</span><span class="op">(</span><span class="op">)</span>, <span class="fu">shiny.fluent</span><span class="fu">::</span><span class="fu"><a href="https://appsilon.github.io/shiny.fluent/reference/Text.html" class="external-link">Text</a></span><span class="op">(</span>variant <span class="op">=</span> <span class="st">"large"</span>, <span class="fu"><a href="../reference/translate.html">translate</a></span><span class="op">(</span><span class="va">language</span>, <span class="st">"import_bib_file"</span>, <span class="va">new_words</span><span class="op">)</span>, block <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
            <span class="fu">div</span><span class="op">(</span>style <span class="op">=</span> <span class="st">"display:none;"</span>, <span class="fu">fileInput</span><span class="op">(</span><span class="fu">ns</span><span class="op">(</span><span class="st">"import_bib_file_%group_id%_%study_id%"</span><span class="op">)</span>, label <span class="op">=</span> <span class="st">""</span>, multiple <span class="op">=</span> <span class="cn">FALSE</span>, accept <span class="op">=</span> <span class="st">".bib"</span><span class="op">)</span><span class="op">)</span>,
            <span class="fu">shiny.fluent</span><span class="fu">::</span><span class="fu"><a href="https://appsilon.github.io/shiny.fluent/reference/Stack.html" class="external-link">Stack</a></span><span class="op">(</span>horizontal <span class="op">=</span> <span class="cn">TRUE</span>, tokens <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>childrenGap <span class="op">=</span> <span class="fl">20</span><span class="op">)</span>,
                <span class="fu"><a href="../reference/make_dropdown.html">make_dropdown</a></span><span class="op">(</span>label <span class="op">=</span> <span class="st">"bibliography"</span>, id <span class="op">=</span> <span class="st">"import_bib_name_%group_id%_%study_id%"</span>, ns <span class="op">=</span> <span class="va">ns</span>, options <span class="op">=</span> <span class="va">bib_options</span>, width <span class="op">=</span> <span class="st">"300px"</span>, words <span class="op">=</span> <span class="va">new_words</span><span class="op">)</span>,
                <span class="fu">div</span><span class="op">(</span><span class="fu">shiny.fluent</span><span class="fu">::</span><span class="fu"><a href="https://appsilon.github.io/shiny.fluent/reference/Button.html" class="external-link">DefaultButton.shinyInput</a></span><span class="op">(</span><span class="fu">ns</span><span class="op">(</span><span class="st">"import_bib_browse_%group_id%_%study_id%"</span><span class="op">)</span>, <span class="fu"><a href="../reference/translate.html">translate</a></span><span class="op">(</span><span class="va">language</span>, <span class="st">"browse_bib"</span>, <span class="va">new_words</span><span class="op">)</span>, iconProps <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>iconName <span class="op">=</span> <span class="st">"Upload"</span><span class="op">)</span><span class="op">)</span>, style <span class="op">=</span> <span class="st">"padding-top:38px;"</span><span class="op">)</span>,
                <span class="fu">div</span><span class="op">(</span><span class="fu">uiOutput</span><span class="op">(</span><span class="fu">ns</span><span class="op">(</span><span class="st">"import_bib_status_%group_id%_%study_id%"</span><span class="op">)</span><span class="op">)</span>, style <span class="op">=</span> <span class="st">"padding-top:38px;"</span><span class="op">)</span>
            <span class="op">)</span>, <span class="fu">br</span><span class="op">(</span><span class="op">)</span>,
            <span class="fu">shiny.fluent</span><span class="fu">::</span><span class="fu"><a href="https://appsilon.github.io/shiny.fluent/reference/Button.html" class="external-link">PrimaryButton.shinyInput</a></span><span class="op">(</span><span class="fu">ns</span><span class="op">(</span><span class="st">"import_bib_validate_%group_id%_%study_id%"</span><span class="op">)</span>, <span class="fu"><a href="../reference/translate.html">translate</a></span><span class="op">(</span><span class="va">language</span>, <span class="st">"upload_bib"</span>, <span class="va">new_words</span><span class="op">)</span><span class="op">)</span>, <span class="fu">br</span><span class="op">(</span><span class="op">)</span>,
            <span class="fu">br</span><span class="op">(</span><span class="op">)</span>, <span class="fu">hr</span><span class="op">(</span><span class="op">)</span>, <span class="fu">shiny.fluent</span><span class="fu">::</span><span class="fu"><a href="https://appsilon.github.io/shiny.fluent/reference/Text.html" class="external-link">Text</a></span><span class="op">(</span>variant <span class="op">=</span> <span class="st">"large"</span>, <span class="fu"><a href="../reference/translate.html">translate</a></span><span class="op">(</span><span class="va">language</span>, <span class="st">"delete_bib"</span>, <span class="va">new_words</span><span class="op">)</span>, block <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
            <span class="fu">shiny.fluent</span><span class="fu">::</span><span class="fu"><a href="https://appsilon.github.io/shiny.fluent/reference/Stack.html" class="external-link">Stack</a></span><span class="op">(</span>horizontal <span class="op">=</span> <span class="cn">TRUE</span>, tokens <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>childrenGap <span class="op">=</span> <span class="fl">20</span><span class="op">)</span>,
                <span class="fu"><a href="../reference/make_dropdown.html">make_dropdown</a></span><span class="op">(</span>label <span class="op">=</span> <span class="st">"bibliography"</span>, id <span class="op">=</span> <span class="st">"delete_bib_%group_id%_%study_id%"</span>, ns <span class="op">=</span> <span class="va">ns</span>, options <span class="op">=</span> <span class="va">bib_options</span>, width <span class="op">=</span> <span class="st">"300px"</span>, words <span class="op">=</span> <span class="va">new_words</span><span class="op">)</span>,
                <span class="fu">div</span><span class="op">(</span><span class="fu">shiny.fluent</span><span class="fu">::</span><span class="fu"><a href="https://appsilon.github.io/shiny.fluent/reference/Button.html" class="external-link">DefaultButton.shinyInput</a></span><span class="op">(</span><span class="fu">ns</span><span class="op">(</span><span class="st">"delete_bib_validate_%group_id%_%study_id%"</span><span class="op">)</span>, <span class="fu"><a href="../reference/translate.html">translate</a></span><span class="op">(</span><span class="va">language</span>, <span class="st">"delete"</span>, <span class="va">r</span><span class="op">$</span><span class="va">words</span><span class="op">)</span><span class="op">)</span>, style <span class="op">=</span> <span class="st">"padding-top:38px;"</span><span class="op">)</span>
            <span class="op">)</span>
        <span class="op">)</span>,
        
        <span class="fu">textOutput</span><span class="op">(</span><span class="fu">ns</span><span class="op">(</span><span class="st">"test"</span><span class="op">)</span><span class="op">)</span>
    <span class="op">)</span>
<span class="op">}</span>

<span class="fu">temp</span><span class="op">(</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="server-code-4">Server code<a class="anchor" aria-label="anchor" href="#server-code-4"></a>
</h3>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="do">##########################################</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Translations                           #</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="do">##########################################</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>new_words <span class="ot">&lt;-</span> tibble<span class="sc">::</span><span class="fu">tribble</span>(<span class="sc">~</span>language, <span class="sc">~</span>reference_word, <span class="sc">~</span>translated_word,</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"EN"</span>, <span class="st">"new_bib_added"</span>, <span class="st">"New bibliography added"</span>,</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"FR"</span>, <span class="st">"new_bib_added"</span>, <span class="st">"Nouvelle bibliographie ajoutée"</span>,</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"EN"</span>, <span class="st">"delete_bib"</span>, <span class="st">"Delete a bibliography"</span>,</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"FR"</span>, <span class="st">"delete_bib"</span>, <span class="st">"Supprimer une bibliographie"</span>,</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"EN"</span>, <span class="st">"delete_bib_subtext"</span>, <span class="st">"Are you sure you want to delete this bibliography ?"</span>,</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"FR"</span>, <span class="st">"delete_bib_subtext"</span>, <span class="st">"Etes-vous sûr de vouloir supprimer cette bibliographie ?"</span>,</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"EN"</span>, <span class="st">"bib_deleted"</span>, <span class="st">"Bibliography deleted"</span>,</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"FR"</span>, <span class="st">"bib_deleted"</span>, <span class="st">"Bibliographie supprimée"</span>,</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"EN"</span>, <span class="st">"bib_imported"</span>, <span class="st">"Bibliography imported"</span>,</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"FR"</span>, <span class="st">"bib_imported"</span>, <span class="st">"Bibliographie importée"</span>,</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"EN"</span>, <span class="st">"bib_import_choose_bib"</span>, <span class="st">"Choose a bibliography to import BibTeX file"</span>,</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">"FR"</span>, <span class="st">"bib_import_choose_bib"</span>, <span class="st">"Choisir une bibliographie pour importer le fichier BibTeX"</span>,</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">"EN"</span>, <span class="st">"title"</span>, <span class="st">"Title"</span>,</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">"FR"</span>, <span class="st">"title"</span>, <span class="st">"Titre"</span>,</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">"EN"</span>, <span class="st">"authors"</span>, <span class="st">"Authors"</span>,</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">"FR"</span>, <span class="st">"authors"</span>, <span class="st">"Auteurs"</span>,</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">"EN"</span>, <span class="st">"journal"</span>, <span class="st">"Journal"</span>,</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">"FR"</span>, <span class="st">"journal"</span>, <span class="st">"Revue"</span>,</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">"EN"</span>, <span class="st">"doi"</span>, <span class="st">"DOI"</span>,</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">"FR"</span>, <span class="st">"doi"</span>, <span class="st">"DOI"</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a><span class="do">##########################################</span></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Display a BibTeX file  with DT         #</span></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a><span class="do">##########################################</span></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">requireNamespace</span>(<span class="st">"bib2df"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>) <span class="sc">&amp;</span> <span class="fu">requireNamespace</span>(<span class="st">"clipr"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)){</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">observeEvent</span>(input<span class="sc">$</span>bib_select_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span>, {</span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>        <span class="fu">tryCatch</span>({</span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Get page_id for delete button</span></span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>            page_id <span class="ot">&lt;-</span> id</span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Use same dir as datamarts</span></span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (<span class="fu">length</span>(r<span class="sc">$</span>datamarts_folder) <span class="sc">&gt;</span> <span class="dv">0</span>) folder <span class="ot">&lt;-</span> <span class="fu">paste0</span>(r<span class="sc">$</span>datamarts_folder, <span class="st">"/bib/"</span>)</span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span> folder <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="fu">path.expand</span>(<span class="st">'~'</span>), <span class="st">"/data/bib/"</span>)</span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a>            path <span class="ot">&lt;-</span> <span class="fu">paste0</span>(folder, <span class="st">"bib_%group_id%_%study_id%_"</span>, input<span class="sc">$</span>import_bib_name_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span>, <span class="st">".bib"</span>)</span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>            <span class="co"># If file exists, transform bib file to dataframe &amp; render as a datatable</span></span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (<span class="fu">file.exists</span>(path)){</span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Select &amp; rename cols</span></span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Make a copy button in action column</span></span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a>                bib <span class="ot">&lt;-</span> bib2df<span class="sc">::</span><span class="fu">bib2df</span>(path) <span class="sc">%&gt;%</span> </span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a>                    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="at">title =</span> TITLE, <span class="at">authors =</span> AUTHOR, <span class="at">journal =</span> JOURNAL, <span class="at">doi =</span> DOI, <span class="at">key =</span> BIBTEXKEY) <span class="sc">%&gt;%</span></span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true" tabindex="-1"></a>                    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">id =</span> <span class="dv">1</span><span class="sc">:</span>dplyr<span class="sc">::</span><span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb8-57"><a href="#cb8-57" aria-hidden="true" tabindex="-1"></a>                    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">authors =</span> <span class="fu">sapply</span>(authors, toString)) <span class="sc">%&gt;%</span> </span>
<span id="cb8-58"><a href="#cb8-58" aria-hidden="true" tabindex="-1"></a>                    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">title =</span> stringr<span class="sc">::</span><span class="fu">str_replace_all</span>(title, <span class="fu">c</span>(<span class="st">"</span><span class="sc">\\</span><span class="st">{"</span> <span class="ot">=</span> <span class="st">""</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">}"</span> <span class="ot">=</span> <span class="st">""</span>)))</span>
<span id="cb8-59"><a href="#cb8-59" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb8-60"><a href="#cb8-60" aria-hidden="true" tabindex="-1"></a>                r<span class="sc">$</span>bib_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span> <span class="er">&lt;</span><span class="sc">-</span> bib</span>
<span id="cb8-61"><a href="#cb8-61" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb8-62"><a href="#cb8-62" aria-hidden="true" tabindex="-1"></a>                bib <span class="ot">&lt;-</span> bib <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb8-63"><a href="#cb8-63" aria-hidden="true" tabindex="-1"></a>                    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">key =</span> <span class="fu">as.character</span>(</span>
<span id="cb8-64"><a href="#cb8-64" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">div</span>(</span>
<span id="cb8-65"><a href="#cb8-65" aria-hidden="true" tabindex="-1"></a>                            shiny<span class="sc">::</span><span class="fu">actionButton</span>(<span class="fu">ns</span>(<span class="fu">paste0</span>(<span class="st">"bib_copy_%group_id%_%study_id%_"</span>, id)), <span class="st">""</span>, <span class="at">icon =</span> <span class="fu">icon</span>(<span class="st">"copy"</span>),</span>
<span id="cb8-66"><a href="#cb8-66" aria-hidden="true" tabindex="-1"></a>                            <span class="at">onclick =</span> <span class="fu">paste0</span>(<span class="st">"Shiny.setInputValue('"</span>, page_id, <span class="st">"-bib_copy_%group_id%_%study_id%', "</span>, id, <span class="st">", {priority: 'event'})"</span>))</span>
<span id="cb8-67"><a href="#cb8-67" aria-hidden="true" tabindex="-1"></a>                        )</span>
<span id="cb8-68"><a href="#cb8-68" aria-hidden="true" tabindex="-1"></a>                    ))</span>
<span id="cb8-69"><a href="#cb8-69" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb8-70"><a href="#cb8-70" aria-hidden="true" tabindex="-1"></a>                col_names <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">translate</span>(language, <span class="st">"title"</span>, new_words), <span class="fu">translate</span>(language, <span class="st">"authors"</span>, new_words), <span class="fu">translate</span>(language, <span class="st">"journal"</span>, new_words), </span>
<span id="cb8-71"><a href="#cb8-71" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">translate</span>(language, <span class="st">"doi"</span>, new_words), <span class="fu">translate</span>(language, <span class="st">"action"</span>, r<span class="sc">$</span>words))</span>
<span id="cb8-72"><a href="#cb8-72" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb8-73"><a href="#cb8-73" aria-hidden="true" tabindex="-1"></a>                sortable_cols <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"title"</span>, <span class="st">"journal"</span>)</span>
<span id="cb8-74"><a href="#cb8-74" aria-hidden="true" tabindex="-1"></a>                centered_cols <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"doi"</span>, <span class="st">"key"</span>)</span>
<span id="cb8-75"><a href="#cb8-75" aria-hidden="true" tabindex="-1"></a>                column_widths <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"action"</span> <span class="ot">=</span> <span class="st">"80"</span>)</span>
<span id="cb8-76"><a href="#cb8-76" aria-hidden="true" tabindex="-1"></a>                searchable_cols <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"title"</span>, <span class="st">"authors"</span>, <span class="st">"journal"</span>)</span>
<span id="cb8-77"><a href="#cb8-77" aria-hidden="true" tabindex="-1"></a>                factorize_cols <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"journal"</span>)</span>
<span id="cb8-78"><a href="#cb8-78" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb8-79"><a href="#cb8-79" aria-hidden="true" tabindex="-1"></a>                <span class="fu">render_datatable</span>(</span>
<span id="cb8-80"><a href="#cb8-80" aria-hidden="true" tabindex="-1"></a>                    <span class="at">data =</span> bib <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>id),</span>
<span id="cb8-81"><a href="#cb8-81" aria-hidden="true" tabindex="-1"></a>                    <span class="at">output =</span> output,</span>
<span id="cb8-82"><a href="#cb8-82" aria-hidden="true" tabindex="-1"></a>                    <span class="at">r =</span> r,</span>
<span id="cb8-83"><a href="#cb8-83" aria-hidden="true" tabindex="-1"></a>                    <span class="at">ns =</span> ns,</span>
<span id="cb8-84"><a href="#cb8-84" aria-hidden="true" tabindex="-1"></a>                    <span class="at">language =</span> language,</span>
<span id="cb8-85"><a href="#cb8-85" aria-hidden="true" tabindex="-1"></a>                    <span class="at">output_name =</span> <span class="st">"bib_datatable_%group_id%_%study_id%"</span>,</span>
<span id="cb8-86"><a href="#cb8-86" aria-hidden="true" tabindex="-1"></a>                    <span class="at">col_names =</span> col_names,</span>
<span id="cb8-87"><a href="#cb8-87" aria-hidden="true" tabindex="-1"></a>                    <span class="at">page_length =</span> <span class="dv">10</span>,</span>
<span id="cb8-88"><a href="#cb8-88" aria-hidden="true" tabindex="-1"></a>                    <span class="at">sortable_cols =</span> sortable_cols,</span>
<span id="cb8-89"><a href="#cb8-89" aria-hidden="true" tabindex="-1"></a>                    <span class="at">centered_cols =</span> centered_cols,</span>
<span id="cb8-90"><a href="#cb8-90" aria-hidden="true" tabindex="-1"></a>                    <span class="at">column_widths =</span> column_widths,</span>
<span id="cb8-91"><a href="#cb8-91" aria-hidden="true" tabindex="-1"></a>                    <span class="at">filter =</span> <span class="cn">TRUE</span>,</span>
<span id="cb8-92"><a href="#cb8-92" aria-hidden="true" tabindex="-1"></a>                    <span class="at">searchable_cols =</span> searchable_cols,</span>
<span id="cb8-93"><a href="#cb8-93" aria-hidden="true" tabindex="-1"></a>                    <span class="at">factorize_cols =</span> factorize_cols</span>
<span id="cb8-94"><a href="#cb8-94" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb8-95"><a href="#cb8-95" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb8-96"><a href="#cb8-96" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="cb8-97"><a href="#cb8-97" aria-hidden="true" tabindex="-1"></a>        <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cf">if</span> (<span class="fu">nchar</span>(e[<span class="dv">1</span>]) <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="fu">report_bug</span>(<span class="at">r =</span> r, <span class="at">output =</span> output, <span class="at">error_message =</span> <span class="st">"error_run_plugin_server_code"</span>, <span class="at">error_name =</span> <span class="st">"%group_id% - run server code"</span>, <span class="at">category =</span> <span class="st">"Error"</span>, <span class="at">error_report =</span> <span class="fu">toString</span>(e), <span class="at">language =</span> language))</span>
<span id="cb8-98"><a href="#cb8-98" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb8-99"><a href="#cb8-99" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-100"><a href="#cb8-100" aria-hidden="true" tabindex="-1"></a>    <span class="fu">observeEvent</span>(input<span class="sc">$</span>bib_copy_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span>,{</span>
<span id="cb8-101"><a href="#cb8-101" aria-hidden="true" tabindex="-1"></a>        clipr<span class="sc">::</span><span class="fu">write_clip</span>(<span class="fu">paste0</span>(<span class="st">"[@"</span>, r<span class="sc">$</span>bib_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span> <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(id <span class="sc">==</span> input<span class="sc">$</span>bib_copy_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span>) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">pull</span>(key), <span class="st">"]"</span>))</span>
<span id="cb8-102"><a href="#cb8-102" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb8-103"><a href="#cb8-103" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-104"><a href="#cb8-104" aria-hidden="true" tabindex="-1"></a>    output<span class="sc">$</span>test <span class="ot">&lt;-</span> <span class="fu">renderText</span>(input<span class="sc">$</span>bib_copy_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span>)</span>
<span id="cb8-105"><a href="#cb8-105" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb8-106"><a href="#cb8-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-107"><a href="#cb8-107" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">"bib2df"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>) <span class="sc">|</span> <span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">"clipr"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)){</span>
<span id="cb8-108"><a href="#cb8-108" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-109"><a href="#cb8-109" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb8-110"><a href="#cb8-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-111"><a href="#cb8-111" aria-hidden="true" tabindex="-1"></a><span class="do">##########################################</span></span>
<span id="cb8-112"><a href="#cb8-112" aria-hidden="true" tabindex="-1"></a><span class="co"># Add a new bibliography                 #</span></span>
<span id="cb8-113"><a href="#cb8-113" aria-hidden="true" tabindex="-1"></a><span class="do">##########################################</span></span>
<span id="cb8-114"><a href="#cb8-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-115"><a href="#cb8-115" aria-hidden="true" tabindex="-1"></a><span class="fu">observeEvent</span>(input<span class="sc">$</span>new_bib_add_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span>, {</span>
<span id="cb8-116"><a href="#cb8-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-117"><a href="#cb8-117" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tryCatch</span>({</span>
<span id="cb8-118"><a href="#cb8-118" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-119"><a href="#cb8-119" aria-hidden="true" tabindex="-1"></a>        new_name <span class="ot">&lt;-</span> input<span class="sc">$</span>new_bib_name_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span></span>
<span id="cb8-120"><a href="#cb8-120" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-121"><a href="#cb8-121" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">length</span>(new_name) <span class="sc">==</span> <span class="dv">0</span>) shiny.fluent<span class="sc">::</span><span class="fu">updateTextField.shinyInput</span>(session, <span class="st">"new_bib_name_%group_id%_%study_id%"</span>, <span class="at">errorMessage =</span> <span class="fu">translate</span>(language, <span class="fu">paste0</span>(<span class="st">"provide_valid_name"</span>), r<span class="sc">$</span>words))</span>
<span id="cb8-122"><a href="#cb8-122" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span> shiny.fluent<span class="sc">::</span><span class="fu">updateTextField.shinyInput</span>(session, <span class="st">"new_bib_name_%group_id%_%study_id%"</span>, <span class="at">errorMessage =</span> <span class="cn">NULL</span>)</span>
<span id="cb8-123"><a href="#cb8-123" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-124"><a href="#cb8-124" aria-hidden="true" tabindex="-1"></a>        <span class="fu">req</span>(<span class="fu">length</span>(new_name) <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb8-125"><a href="#cb8-125" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-126"><a href="#cb8-126" aria-hidden="true" tabindex="-1"></a>        sql <span class="ot">&lt;-</span> <span class="st">"SELECT DISTINCT(value) FROM modules_elements_options WHERE deleted IS FALSE AND group_id = %group_id% AND study_id = %study_id% AND name = 'bib_name'"</span> </span>
<span id="cb8-127"><a href="#cb8-127" aria-hidden="true" tabindex="-1"></a>        distinct_values <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbGetQuery</span>(r<span class="sc">$</span>db, sql) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">pull</span>() <span class="sc">%&gt;%</span> <span class="fu">tolower</span>()</span>
<span id="cb8-128"><a href="#cb8-128" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb8-129"><a href="#cb8-129" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">tolower</span>(new_name) <span class="sc">%in%</span> distinct_values) <span class="fu">show_message_bar</span>(output, <span class="dv">2</span>, <span class="st">"name_already_used"</span>, <span class="st">"severeWarning"</span>, language)</span>
<span id="cb8-130"><a href="#cb8-130" aria-hidden="true" tabindex="-1"></a>        <span class="fu">req</span>(<span class="fu">tolower</span>(new_name) <span class="sc">%not_in%</span> distinct_values)</span>
<span id="cb8-131"><a href="#cb8-131" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-132"><a href="#cb8-132" aria-hidden="true" tabindex="-1"></a>        last_row <span class="ot">&lt;-</span> <span class="fu">get_last_row</span>(r<span class="sc">$</span>db, <span class="st">"modules_elements_options"</span>)</span>
<span id="cb8-133"><a href="#cb8-133" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-134"><a href="#cb8-134" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Insert new bib in database</span></span>
<span id="cb8-135"><a href="#cb8-135" aria-hidden="true" tabindex="-1"></a>        <span class="co"># One row for name, one row for bib file path</span></span>
<span id="cb8-136"><a href="#cb8-136" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-137"><a href="#cb8-137" aria-hidden="true" tabindex="-1"></a>        sql <span class="ot">&lt;-</span> glue<span class="sc">::</span><span class="fu">glue_sql</span>(<span class="st">"INSERT INTO modules_elements_options(id, group_id, study_id, link_id, category, name, value, creator_id, datetime, deleted)</span></span>
<span id="cb8-138"><a href="#cb8-138" aria-hidden="true" tabindex="-1"></a><span class="st">            SELECT {last_row + 1}, %group_id%, %study_id%, {NA_integer_}, 'aggregated', 'bib_name', {new_name}, {r$user_id}, {as.character(Sys.time())}, FALSE</span></span>
<span id="cb8-139"><a href="#cb8-139" aria-hidden="true" tabindex="-1"></a><span class="st">      UNION SELECT {last_row + 2}, %group_id%, %study_id%, {last_row + 1}, 'aggregated', 'bib_file_path', '', {r$user_id}, {as.character(Sys.time())}, FALSE"</span>, <span class="at">.con =</span> r<span class="sc">$</span>db)</span>
<span id="cb8-140"><a href="#cb8-140" aria-hidden="true" tabindex="-1"></a>        query <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbSendStatement</span>(r<span class="sc">$</span>db, sql)</span>
<span id="cb8-141"><a href="#cb8-141" aria-hidden="true" tabindex="-1"></a>        DBI<span class="sc">::</span><span class="fu">dbClearResult</span>(query)</span>
<span id="cb8-142"><a href="#cb8-142" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-143"><a href="#cb8-143" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Reset textfield</span></span>
<span id="cb8-144"><a href="#cb8-144" aria-hidden="true" tabindex="-1"></a>        shiny.fluent<span class="sc">::</span><span class="fu">updateTextField.shinyInput</span>(session, <span class="st">"new_bib_name_%group_id%_%study_id%"</span>, <span class="at">value =</span> <span class="cn">NULL</span>)</span>
<span id="cb8-145"><a href="#cb8-145" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-146"><a href="#cb8-146" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Update dropdowns</span></span>
<span id="cb8-147"><a href="#cb8-147" aria-hidden="true" tabindex="-1"></a>        r<span class="sc">$</span>reload_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span> <span class="er">&lt;</span><span class="sc">-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb8-148"><a href="#cb8-148" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-149"><a href="#cb8-149" aria-hidden="true" tabindex="-1"></a>        <span class="fu">show_message_bar</span>(output, <span class="dv">1</span>, <span class="fu">translate</span>(language, <span class="st">"new_bib_added"</span>, new_words), <span class="st">"success"</span>, language)</span>
<span id="cb8-150"><a href="#cb8-150" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-151"><a href="#cb8-151" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb8-152"><a href="#cb8-152" aria-hidden="true" tabindex="-1"></a>    <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cf">if</span> (<span class="fu">nchar</span>(e[<span class="dv">1</span>]) <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="fu">report_bug</span>(<span class="at">r =</span> r, <span class="at">output =</span> output, <span class="at">error_message =</span> <span class="st">"error_run_plugin_server_code"</span>, <span class="at">error_name =</span> <span class="st">"%group_id% - run server code"</span>, <span class="at">category =</span> <span class="st">"Error"</span>, <span class="at">error_report =</span> <span class="fu">toString</span>(e), <span class="at">language =</span> language))</span>
<span id="cb8-153"><a href="#cb8-153" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb8-154"><a href="#cb8-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-155"><a href="#cb8-155" aria-hidden="true" tabindex="-1"></a><span class="do">##########################################</span></span>
<span id="cb8-156"><a href="#cb8-156" aria-hidden="true" tabindex="-1"></a><span class="co"># Import a BibTeX file                   #</span></span>
<span id="cb8-157"><a href="#cb8-157" aria-hidden="true" tabindex="-1"></a><span class="do">##########################################</span></span>
<span id="cb8-158"><a href="#cb8-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-159"><a href="#cb8-159" aria-hidden="true" tabindex="-1"></a><span class="fu">observeEvent</span>(input<span class="sc">$</span>import_bib_browse_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span>, shinyjs<span class="sc">::</span><span class="fu">click</span>(<span class="st">"import_bib_file_%group_id%_%study_id%"</span>))</span>
<span id="cb8-160"><a href="#cb8-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-161"><a href="#cb8-161" aria-hidden="true" tabindex="-1"></a>output<span class="sc">$</span>import_bib_status_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span> <span class="er">&lt;</span><span class="sc">-</span> <span class="fu">renderUI</span>(<span class="fu">tagList</span>(<span class="fu">div</span>(</span>
<span id="cb8-162"><a href="#cb8-162" aria-hidden="true" tabindex="-1"></a>    <span class="fu">span</span>(<span class="fu">translate</span>(language, <span class="st">"loaded_file"</span>, r<span class="sc">$</span>words), <span class="st">" : "</span>, <span class="at">style =</span> <span class="st">"padding-top:5px;"</span>), </span>
<span id="cb8-163"><a href="#cb8-163" aria-hidden="true" tabindex="-1"></a>    <span class="fu">span</span>(input<span class="sc">$</span>import_bib_file_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span><span class="er">$</span>name, <span class="at">style =</span> <span class="st">"font-weight:bold; color:#0078D4;"</span>), <span class="at">style =</span> <span class="st">"padding-top:10px;"</span>)))</span>
<span id="cb8-164"><a href="#cb8-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-165"><a href="#cb8-165" aria-hidden="true" tabindex="-1"></a><span class="fu">observeEvent</span>(input<span class="sc">$</span>import_bib_validate_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span>, {</span>
<span id="cb8-166"><a href="#cb8-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-167"><a href="#cb8-167" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tryCatch</span>({</span>
<span id="cb8-168"><a href="#cb8-168" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-169"><a href="#cb8-169" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">length</span>(input<span class="sc">$</span>import_bib_name_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span>) <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">show_message_bar</span>(output, <span class="dv">3</span>, <span class="st">"bib_import_choose_bib"</span>, <span class="st">"severeWarning"</span>, language, <span class="at">words =</span> new_words)</span>
<span id="cb8-170"><a href="#cb8-170" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-171"><a href="#cb8-171" aria-hidden="true" tabindex="-1"></a>        <span class="fu">req</span>(input<span class="sc">$</span>import_bib_file_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span>, input<span class="sc">$</span>import_bib_name_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span>)</span>
<span id="cb8-172"><a href="#cb8-172" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb8-173"><a href="#cb8-173" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Use same dir as datamarts</span></span>
<span id="cb8-174"><a href="#cb8-174" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-175"><a href="#cb8-175" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">length</span>(r<span class="sc">$</span>datamarts_folder) <span class="sc">&gt;</span> <span class="dv">0</span>) folder <span class="ot">&lt;-</span> <span class="fu">paste0</span>(r<span class="sc">$</span>datamarts_folder, <span class="st">"/bib/"</span>)</span>
<span id="cb8-176"><a href="#cb8-176" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span> folder <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="fu">path.expand</span>(<span class="st">'~'</span>), <span class="st">"/data/bib/"</span>)</span>
<span id="cb8-177"><a href="#cb8-177" aria-hidden="true" tabindex="-1"></a>        <span class="fu">dir.create</span>(folder, <span class="at">showWarnings =</span> <span class="cn">FALSE</span>)</span>
<span id="cb8-178"><a href="#cb8-178" aria-hidden="true" tabindex="-1"></a>        path <span class="ot">&lt;-</span> <span class="fu">paste0</span>(folder, <span class="st">"bib_%group_id%_%study_id%_"</span>, input<span class="sc">$</span>import_bib_name_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span>, <span class="st">".bib"</span>)</span>
<span id="cb8-179"><a href="#cb8-179" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-180"><a href="#cb8-180" aria-hidden="true" tabindex="-1"></a>        <span class="fu">file.copy</span>(input<span class="sc">$</span>import_bib_file_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span><span class="er">$</span>datapath, path)</span>
<span id="cb8-181"><a href="#cb8-181" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-182"><a href="#cb8-182" aria-hidden="true" tabindex="-1"></a>        <span class="fu">show_message_bar</span>(output, <span class="dv">3</span>, <span class="st">"bib_imported"</span>, <span class="st">"success"</span>, language, <span class="at">words =</span> new_words)</span>
<span id="cb8-183"><a href="#cb8-183" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-184"><a href="#cb8-184" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb8-185"><a href="#cb8-185" aria-hidden="true" tabindex="-1"></a>    <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cf">if</span> (<span class="fu">nchar</span>(e[<span class="dv">1</span>]) <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="fu">report_bug</span>(<span class="at">r =</span> r, <span class="at">output =</span> output, <span class="at">error_message =</span> <span class="st">"error_run_plugin_server_code"</span>, <span class="at">error_name =</span> <span class="st">"%group_id% - run server code"</span>, <span class="at">category =</span> <span class="st">"Error"</span>, <span class="at">error_report =</span> <span class="fu">toString</span>(e), <span class="at">language =</span> language))</span>
<span id="cb8-186"><a href="#cb8-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-187"><a href="#cb8-187" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb8-188"><a href="#cb8-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-189"><a href="#cb8-189" aria-hidden="true" tabindex="-1"></a><span class="do">##########################################</span></span>
<span id="cb8-190"><a href="#cb8-190" aria-hidden="true" tabindex="-1"></a><span class="co"># Delete a bibliography                  #</span></span>
<span id="cb8-191"><a href="#cb8-191" aria-hidden="true" tabindex="-1"></a><span class="do">##########################################</span></span>
<span id="cb8-192"><a href="#cb8-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-193"><a href="#cb8-193" aria-hidden="true" tabindex="-1"></a><span class="co"># Delete button is pressed</span></span>
<span id="cb8-194"><a href="#cb8-194" aria-hidden="true" tabindex="-1"></a><span class="fu">observeEvent</span>(input<span class="sc">$</span>delete_bib_validate_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span>, r<span class="sc">$</span>delete_dialog_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span> <span class="er">&lt;</span><span class="sc">-</span> <span class="cn">TRUE</span>)</span>
<span id="cb8-195"><a href="#cb8-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-196"><a href="#cb8-196" aria-hidden="true" tabindex="-1"></a><span class="co"># Rendering react output</span></span>
<span id="cb8-197"><a href="#cb8-197" aria-hidden="true" tabindex="-1"></a><span class="fu">observeEvent</span>(r<span class="sc">$</span>delete_dialog_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span> , {</span>
<span id="cb8-198"><a href="#cb8-198" aria-hidden="true" tabindex="-1"></a>    output<span class="sc">$</span>delete_confirm <span class="ot">&lt;-</span> shiny.fluent<span class="sc">::</span><span class="fu">renderReact</span>({</span>
<span id="cb8-199"><a href="#cb8-199" aria-hidden="true" tabindex="-1"></a>        dialogContentProps <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb8-200"><a href="#cb8-200" aria-hidden="true" tabindex="-1"></a>            <span class="at">type =</span> <span class="dv">0</span>,</span>
<span id="cb8-201"><a href="#cb8-201" aria-hidden="true" tabindex="-1"></a>            <span class="at">title =</span> <span class="fu">translate</span>(language, <span class="st">"delete_bib"</span>, new_words),</span>
<span id="cb8-202"><a href="#cb8-202" aria-hidden="true" tabindex="-1"></a>            <span class="at">closeButtonAriaLabel =</span> <span class="st">"Close"</span>,</span>
<span id="cb8-203"><a href="#cb8-203" aria-hidden="true" tabindex="-1"></a>            <span class="at">subText =</span> <span class="fu">translate</span>(language, <span class="st">"delete_bib_subtext"</span>, new_words)</span>
<span id="cb8-204"><a href="#cb8-204" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb8-205"><a href="#cb8-205" aria-hidden="true" tabindex="-1"></a>        shiny.fluent<span class="sc">::</span><span class="fu">Dialog</span>(</span>
<span id="cb8-206"><a href="#cb8-206" aria-hidden="true" tabindex="-1"></a>            <span class="at">hidden =</span> <span class="sc">!</span>r<span class="sc">$</span>delete_dialog_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span>,</span>
<span id="cb8-207"><a href="#cb8-207" aria-hidden="true" tabindex="-1"></a>            <span class="at">onDismiss =</span> htmlwidgets<span class="sc">::</span><span class="fu">JS</span>(<span class="fu">paste0</span>(<span class="st">"function() { Shiny.setInputValue('hide_dialog_%group_id%_%study_id%', Math.random()); }"</span>)),</span>
<span id="cb8-208"><a href="#cb8-208" aria-hidden="true" tabindex="-1"></a>            <span class="at">dialogContentProps =</span> dialogContentProps,</span>
<span id="cb8-209"><a href="#cb8-209" aria-hidden="true" tabindex="-1"></a>            <span class="at">modalProps =</span> <span class="fu">list</span>(),</span>
<span id="cb8-210"><a href="#cb8-210" aria-hidden="true" tabindex="-1"></a>            shiny.fluent<span class="sc">::</span><span class="fu">DialogFooter</span>(</span>
<span id="cb8-211"><a href="#cb8-211" aria-hidden="true" tabindex="-1"></a>                shiny.fluent<span class="sc">::</span><span class="fu">PrimaryButton.shinyInput</span>(<span class="fu">ns</span>(<span class="st">"delete_confirmed_%group_id%_%study_id%"</span>), <span class="at">text =</span> <span class="fu">translate</span>(language, <span class="st">"delete"</span>, r<span class="sc">$</span>words)),</span>
<span id="cb8-212"><a href="#cb8-212" aria-hidden="true" tabindex="-1"></a>                shiny.fluent<span class="sc">::</span><span class="fu">DefaultButton.shinyInput</span>(<span class="fu">ns</span>(<span class="st">"delete_canceled_%group_id%_%study_id%"</span>), <span class="at">text =</span> <span class="fu">translate</span>(language, <span class="st">"dont_delete"</span>, r<span class="sc">$</span>words))</span>
<span id="cb8-213"><a href="#cb8-213" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb8-214"><a href="#cb8-214" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb8-215"><a href="#cb8-215" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb8-216"><a href="#cb8-216" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb8-217"><a href="#cb8-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-218"><a href="#cb8-218" aria-hidden="true" tabindex="-1"></a><span class="co"># Whether to close or not delete dialog box</span></span>
<span id="cb8-219"><a href="#cb8-219" aria-hidden="true" tabindex="-1"></a><span class="fu">observeEvent</span>(input<span class="sc">$</span>hide_dialog_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span>, r<span class="sc">$</span>delete_dialog_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span> <span class="er">&lt;</span><span class="sc">-</span> <span class="cn">FALSE</span>)</span>
<span id="cb8-220"><a href="#cb8-220" aria-hidden="true" tabindex="-1"></a><span class="fu">observeEvent</span>(input<span class="sc">$</span>delete_canceled_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span>, r<span class="sc">$</span>delete_dialog_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span> <span class="er">&lt;</span><span class="sc">-</span> <span class="cn">FALSE</span>)</span>
<span id="cb8-221"><a href="#cb8-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-222"><a href="#cb8-222" aria-hidden="true" tabindex="-1"></a><span class="co"># When the delete is confirmed</span></span>
<span id="cb8-223"><a href="#cb8-223" aria-hidden="true" tabindex="-1"></a><span class="fu">observeEvent</span>(input<span class="sc">$</span>delete_confirmed_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span>, {</span>
<span id="cb8-224"><a href="#cb8-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-225"><a href="#cb8-225" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tryCatch</span>({</span>
<span id="cb8-226"><a href="#cb8-226" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-227"><a href="#cb8-227" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get value of deleted row</span></span>
<span id="cb8-228"><a href="#cb8-228" aria-hidden="true" tabindex="-1"></a>        row_deleted <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(input<span class="sc">$</span>delete_bib_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span>)</span>
<span id="cb8-229"><a href="#cb8-229" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-230"><a href="#cb8-230" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Delete row in database</span></span>
<span id="cb8-231"><a href="#cb8-231" aria-hidden="true" tabindex="-1"></a>        sql <span class="ot">&lt;-</span> glue<span class="sc">::</span><span class="fu">glue_sql</span>(<span class="st">"UPDATE modules_elements_options SET deleted = TRUE WHERE id = {row_deleted} OR link_id = {row_deleted}"</span>, <span class="at">.con =</span> r<span class="sc">$</span>db)</span>
<span id="cb8-232"><a href="#cb8-232" aria-hidden="true" tabindex="-1"></a>        query <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbSendStatement</span>(r<span class="sc">$</span>db, sql)</span>
<span id="cb8-233"><a href="#cb8-233" aria-hidden="true" tabindex="-1"></a>        DBI<span class="sc">::</span><span class="fu">dbClearResult</span>(query)</span>
<span id="cb8-234"><a href="#cb8-234" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-235"><a href="#cb8-235" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Close dialog box</span></span>
<span id="cb8-236"><a href="#cb8-236" aria-hidden="true" tabindex="-1"></a>        r<span class="sc">$</span>delete_dialog_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span> <span class="er">&lt;</span><span class="sc">-</span> <span class="cn">FALSE</span></span>
<span id="cb8-237"><a href="#cb8-237" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-238"><a href="#cb8-238" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Notification to user</span></span>
<span id="cb8-239"><a href="#cb8-239" aria-hidden="true" tabindex="-1"></a>        <span class="fu">show_message_bar</span>(<span class="at">output =</span> output, <span class="at">id =</span> <span class="dv">3</span>, <span class="fu">translate</span>(language, <span class="st">"bib_deleted"</span>, new_words), <span class="at">type =</span> <span class="st">"severeWarning"</span>, <span class="at">language =</span> language)</span>
<span id="cb8-240"><a href="#cb8-240" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-241"><a href="#cb8-241" aria-hidden="true" tabindex="-1"></a>        r<span class="sc">$</span>reload_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span> <span class="er">&lt;</span><span class="sc">-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb8-242"><a href="#cb8-242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-243"><a href="#cb8-243" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb8-244"><a href="#cb8-244" aria-hidden="true" tabindex="-1"></a>    <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cf">if</span> (<span class="fu">nchar</span>(e[<span class="dv">1</span>]) <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="fu">report_bug</span>(<span class="at">r =</span> r, <span class="at">output =</span> output, <span class="at">error_message =</span> <span class="st">"error_run_plugin_server_code"</span>, <span class="at">error_name =</span> <span class="st">"%group_id% - run server code"</span>, <span class="at">category =</span> <span class="st">"Error"</span>, <span class="at">error_report =</span> <span class="fu">toString</span>(e), <span class="at">language =</span> language))</span>
<span id="cb8-245"><a href="#cb8-245" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb8-246"><a href="#cb8-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-247"><a href="#cb8-247" aria-hidden="true" tabindex="-1"></a><span class="do">##########################################</span></span>
<span id="cb8-248"><a href="#cb8-248" aria-hidden="true" tabindex="-1"></a><span class="co"># Reload data                            #</span></span>
<span id="cb8-249"><a href="#cb8-249" aria-hidden="true" tabindex="-1"></a><span class="do">##########################################</span></span>
<span id="cb8-250"><a href="#cb8-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-251"><a href="#cb8-251" aria-hidden="true" tabindex="-1"></a><span class="fu">observeEvent</span>(r<span class="sc">$</span>reload_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span>, {</span>
<span id="cb8-252"><a href="#cb8-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-253"><a href="#cb8-253" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Update dropdowns</span></span>
<span id="cb8-254"><a href="#cb8-254" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-255"><a href="#cb8-255" aria-hidden="true" tabindex="-1"></a>    options <span class="ot">&lt;-</span> <span class="fu">convert_tibble_to_list</span>(DBI<span class="sc">::</span><span class="fu">dbGetQuery</span>(r<span class="sc">$</span>db, <span class="st">"SELECT * FROM modules_elements_options WHERE deleted IS FALSE AND group_id = %group_id% AND study_id = %study_id% AND name = 'bib_name'"</span>), <span class="at">key_col =</span> <span class="st">"id"</span>, <span class="at">text_col =</span> <span class="st">"value"</span>)</span>
<span id="cb8-256"><a href="#cb8-256" aria-hidden="true" tabindex="-1"></a>    shiny.fluent<span class="sc">::</span><span class="fu">updateDropdown.shinyInput</span>(session, <span class="st">"bib_select_%group_id%_%study_id%"</span>, <span class="at">options =</span> options)</span>
<span id="cb8-257"><a href="#cb8-257" aria-hidden="true" tabindex="-1"></a>    shiny.fluent<span class="sc">::</span><span class="fu">updateDropdown.shinyInput</span>(session, <span class="st">"import_bib_name_%group_id%_%study_id%"</span>, <span class="at">options =</span> options)</span>
<span id="cb8-258"><a href="#cb8-258" aria-hidden="true" tabindex="-1"></a>    shiny.fluent<span class="sc">::</span><span class="fu">updateDropdown.shinyInput</span>(session, <span class="st">"delete_bib_%group_id%_%study_id%"</span>, <span class="at">options =</span> options)</span>
<span id="cb8-259"><a href="#cb8-259" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="r-code">R code<a class="anchor" aria-label="anchor" href="#r-code"></a>
</h2>
<div class="section level3">
<h3 id="description-5">Description<a class="anchor" aria-label="anchor" href="#description-5"></a>
</h3>
<ul>
<li>
<strong>Version</strong> : 0.0.1</li>
<li>
<strong>Libraries</strong> : none</li>
</ul>
</div>
<div class="section level3">
<h3 id="ui-code-5">UI code<a class="anchor" aria-label="anchor" href="#ui-code-5"></a>
</h3>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">temp</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span><span class="op">{</span>
    
     <span class="co"># Translations</span>
    <span class="va">new_words</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html" class="external-link">tribble</a></span><span class="op">(</span><span class="op">~</span><span class="va">language</span>, <span class="op">~</span><span class="va">reference_word</span>, <span class="op">~</span><span class="va">translated_word</span>,
        <span class="st">"EN"</span>, <span class="st">"edit_script"</span>, <span class="st">"Edit a script"</span>,
        <span class="st">"FR"</span>, <span class="st">"edit_script"</span>, <span class="st">"Modifier un script"</span>,
        <span class="st">"EN"</span>, <span class="st">"manage_scripts"</span>, <span class="st">"Manage scripts"</span>,
        <span class="st">"FR"</span>, <span class="st">"manage_scripts"</span>, <span class="st">"Gérer les scripts"</span>,
        <span class="st">"EN"</span>, <span class="st">"r_script"</span>, <span class="st">"Script"</span>,
        <span class="st">"FR"</span>, <span class="st">"r_script"</span>, <span class="st">"Script"</span>,
        <span class="st">"EN"</span>, <span class="st">"new_script"</span>, <span class="st">"New script"</span>,
        <span class="st">"FR"</span>, <span class="st">"new_script"</span>, <span class="st">"Nouveau script"</span>,
        <span class="st">"EN"</span>, <span class="st">"delete_script"</span>, <span class="st">"Delete a script"</span>,
        <span class="st">"FR"</span>, <span class="st">"delete_script"</span>, <span class="st">"Supprimer un script"</span>
    <span class="op">)</span>
    
    <span class="va">action_choice_options</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
        <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>key <span class="op">=</span> <span class="st">"edit_code"</span>, text <span class="op">=</span> <span class="fu"><a href="../reference/translate.html">translate</a></span><span class="op">(</span><span class="va">language</span>, <span class="st">"edit_script"</span>, <span class="va">new_words</span><span class="op">)</span><span class="op">)</span>,
        <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>key <span class="op">=</span> <span class="st">"manage_code"</span>, text <span class="op">=</span> <span class="fu"><a href="../reference/translate.html">translate</a></span><span class="op">(</span><span class="va">language</span>, <span class="st">"manage_scripts"</span>, <span class="va">new_words</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
    
    <span class="va">scripts_options</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/convert_tibble_to_list.html">convert_tibble_to_list</a></span><span class="op">(</span><span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html" class="external-link">dbGetQuery</a></span><span class="op">(</span><span class="va">r</span><span class="op">$</span><span class="va">db</span>, <span class="st">"SELECT * FROM modules_elements_options WHERE DELETED IS FALSE AND group_id = %group_id% AND study_id = %study_id% AND name = 'r_script_name'"</span><span class="op">)</span>, key_col <span class="op">=</span> <span class="st">"id"</span>, text_col <span class="op">=</span> <span class="st">"value"</span><span class="op">)</span>
    
    <span class="fu">div</span><span class="op">(</span>
        <span class="fu">shiny.fluent</span><span class="fu">::</span><span class="fu"><a href="https://appsilon.github.io/shiny.fluent/reference/ChoiceGroup.html" class="external-link">ChoiceGroup.shinyInput</a></span><span class="op">(</span><span class="fu">ns</span><span class="op">(</span><span class="st">"action_choice_%group_id%_%study_id%"</span><span class="op">)</span>, value <span class="op">=</span> <span class="st">"edit_code"</span>, options <span class="op">=</span> <span class="va">action_choice_options</span>, className <span class="op">=</span> <span class="st">"inline_choicegroup"</span><span class="op">)</span>,
        
        <span class="fu">conditionalPanel</span><span class="op">(</span>condition <span class="op">=</span> <span class="st">"input.action_choice_%group_id%_%study_id% == 'edit_code'"</span>, ns <span class="op">=</span> <span class="va">ns</span>,
            <span class="fu"><a href="../reference/make_dropdown.html">make_dropdown</a></span><span class="op">(</span>label <span class="op">=</span> <span class="st">"r_script"</span>, id <span class="op">=</span> <span class="st">"Rcode_select_%group_id%_%study_id%"</span>, words <span class="op">=</span> <span class="va">new_words</span>, ns <span class="op">=</span> <span class="va">ns</span>, options <span class="op">=</span> <span class="va">scripts_options</span>, width <span class="op">=</span> <span class="st">"300px"</span><span class="op">)</span>,
            <span class="fu">div</span><span class="op">(</span><span class="fu">shinyAce</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/shinyAce/man/aceEditor.html" class="external-link">aceEditor</a></span><span class="op">(</span><span class="fu">ns</span><span class="op">(</span><span class="st">"Rcode_%group_id%_%study_id%"</span><span class="op">)</span>, <span class="st">""</span>, mode <span class="op">=</span> <span class="st">"r"</span>, autoScrollEditorIntoView <span class="op">=</span> <span class="cn">TRUE</span>, minLines <span class="op">=</span> <span class="fl">30</span>, maxLines <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span>, style <span class="op">=</span> <span class="st">"width: 100%;"</span><span class="op">)</span>,
            <span class="fu">shiny.fluent</span><span class="fu">::</span><span class="fu"><a href="https://appsilon.github.io/shiny.fluent/reference/Button.html" class="external-link">PrimaryButton.shinyInput</a></span><span class="op">(</span><span class="fu">ns</span><span class="op">(</span><span class="st">"Rcode_save_%group_id%_%study_id%"</span><span class="op">)</span>, <span class="fu"><a href="../reference/translate.html">translate</a></span><span class="op">(</span><span class="va">language</span>, <span class="st">"save"</span>, <span class="va">r</span><span class="op">$</span><span class="va">words</span><span class="op">)</span><span class="op">)</span>, <span class="st">" "</span>,
            <span class="fu">shiny.fluent</span><span class="fu">::</span><span class="fu"><a href="https://appsilon.github.io/shiny.fluent/reference/Button.html" class="external-link">DefaultButton.shinyInput</a></span><span class="op">(</span><span class="fu">ns</span><span class="op">(</span><span class="st">"Rcode_execute_%group_id%_%study_id%"</span><span class="op">)</span>, <span class="fu"><a href="../reference/translate.html">translate</a></span><span class="op">(</span><span class="va">language</span>, <span class="st">"execute_code"</span>, <span class="va">r</span><span class="op">$</span><span class="va">words</span><span class="op">)</span><span class="op">)</span>, <span class="fu">br</span><span class="op">(</span><span class="op">)</span>, <span class="fu">br</span><span class="op">(</span><span class="op">)</span>,
            <span class="fu">div</span><span class="op">(</span><span class="fu">verbatimTextOutput</span><span class="op">(</span><span class="fu">ns</span><span class="op">(</span><span class="st">"Rcode_result"</span><span class="op">)</span><span class="op">)</span>, style <span class="op">=</span> <span class="st">"width: 99%; border-style: dashed; border-width: 1px; padding: 0px 8px 0px 8px; margin-right: 5px;"</span><span class="op">)</span>
        <span class="op">)</span>,
        
        <span class="fu">conditionalPanel</span><span class="op">(</span>condition <span class="op">=</span> <span class="st">"input.action_choice_%group_id%_%study_id% == 'manage_code'"</span>, ns <span class="op">=</span> <span class="va">ns</span>,
            <span class="fu">br</span><span class="op">(</span><span class="op">)</span>, <span class="fu">shiny.fluent</span><span class="fu">::</span><span class="fu"><a href="https://appsilon.github.io/shiny.fluent/reference/Text.html" class="external-link">Text</a></span><span class="op">(</span>variant <span class="op">=</span> <span class="st">"large"</span>, <span class="fu"><a href="../reference/translate.html">translate</a></span><span class="op">(</span><span class="va">language</span>, <span class="st">"new_script"</span>, <span class="va">new_words</span><span class="op">)</span>, block <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
            <span class="fu">shiny.fluent</span><span class="fu">::</span><span class="fu"><a href="https://appsilon.github.io/shiny.fluent/reference/Stack.html" class="external-link">Stack</a></span><span class="op">(</span>horizontal <span class="op">=</span> <span class="cn">TRUE</span>, tokens <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>childrenGap <span class="op">=</span> <span class="fl">20</span><span class="op">)</span>,
                <span class="fu"><a href="../reference/make_textfield.html">make_textfield</a></span><span class="op">(</span>label <span class="op">=</span> <span class="st">"name"</span>, id <span class="op">=</span> <span class="st">"new_script_name_%group_id%_%study_id%"</span>, ns <span class="op">=</span> <span class="va">ns</span>, width <span class="op">=</span> <span class="st">"300px"</span><span class="op">)</span>,
                <span class="fu">div</span><span class="op">(</span><span class="fu">shiny.fluent</span><span class="fu">::</span><span class="fu"><a href="https://appsilon.github.io/shiny.fluent/reference/Button.html" class="external-link">PrimaryButton.shinyInput</a></span><span class="op">(</span><span class="fu">ns</span><span class="op">(</span><span class="st">"new_script_add_%group_id%_%study_id%"</span><span class="op">)</span>, <span class="fu"><a href="../reference/translate.html">translate</a></span><span class="op">(</span><span class="va">language</span>, <span class="st">"add"</span>, <span class="va">r</span><span class="op">$</span><span class="va">words</span><span class="op">)</span><span class="op">)</span>, style <span class="op">=</span> <span class="st">"padding-top:38px;"</span><span class="op">)</span>
            <span class="op">)</span>,
            <span class="fu">br</span><span class="op">(</span><span class="op">)</span>, <span class="fu">hr</span><span class="op">(</span><span class="op">)</span>, <span class="fu">shiny.fluent</span><span class="fu">::</span><span class="fu"><a href="https://appsilon.github.io/shiny.fluent/reference/Text.html" class="external-link">Text</a></span><span class="op">(</span>variant <span class="op">=</span> <span class="st">"large"</span>, <span class="fu"><a href="../reference/translate.html">translate</a></span><span class="op">(</span><span class="va">language</span>, <span class="st">"delete_script"</span>, <span class="va">new_words</span><span class="op">)</span>, block <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
            <span class="fu">shiny.fluent</span><span class="fu">::</span><span class="fu"><a href="https://appsilon.github.io/shiny.fluent/reference/Stack.html" class="external-link">Stack</a></span><span class="op">(</span>horizontal <span class="op">=</span> <span class="cn">TRUE</span>, tokens <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>childrenGap <span class="op">=</span> <span class="fl">20</span><span class="op">)</span>,
                <span class="fu"><a href="../reference/make_dropdown.html">make_dropdown</a></span><span class="op">(</span>label <span class="op">=</span> <span class="st">"r_script"</span>, id <span class="op">=</span> <span class="st">"delete_script_%group_id%_%study_id%"</span>, ns <span class="op">=</span> <span class="va">ns</span>, options <span class="op">=</span> <span class="va">scripts_options</span>, width <span class="op">=</span> <span class="st">"300px"</span>, words <span class="op">=</span> <span class="va">new_words</span><span class="op">)</span>,
                <span class="fu">div</span><span class="op">(</span><span class="fu">shiny.fluent</span><span class="fu">::</span><span class="fu"><a href="https://appsilon.github.io/shiny.fluent/reference/Button.html" class="external-link">DefaultButton.shinyInput</a></span><span class="op">(</span><span class="fu">ns</span><span class="op">(</span><span class="st">"delete_script_validate_%group_id%_%study_id%"</span><span class="op">)</span>, <span class="fu"><a href="../reference/translate.html">translate</a></span><span class="op">(</span><span class="va">language</span>, <span class="st">"delete"</span>, <span class="va">r</span><span class="op">$</span><span class="va">words</span><span class="op">)</span><span class="op">)</span>, style <span class="op">=</span> <span class="st">"padding-top:38px;"</span><span class="op">)</span>
            <span class="op">)</span>
        <span class="op">)</span>
    <span class="op">)</span>
<span class="op">}</span>

<span class="fu">temp</span><span class="op">(</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="server-code-5">Server code<a class="anchor" aria-label="anchor" href="#server-code-5"></a>
</h3>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="do">##########################################</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Translations                           #</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="do">##########################################</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>new_words <span class="ot">&lt;-</span> tibble<span class="sc">::</span><span class="fu">tribble</span>(<span class="sc">~</span>language, <span class="sc">~</span>reference_word, <span class="sc">~</span>translated_word,</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"EN"</span>, <span class="st">"new_script_added"</span>, <span class="st">"New script added"</span>,</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"FR"</span>, <span class="st">"new_script_added"</span>, <span class="st">"Nouveau script ajouté"</span>,</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"EN"</span>, <span class="st">"delete_script"</span>, <span class="st">"Delete a script"</span>,</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"FR"</span>, <span class="st">"delete_script"</span>, <span class="st">"Supprimer un script"</span>,</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"EN"</span>, <span class="st">"delete_script_subtext"</span>, <span class="st">"Are you sure you want to delete this script ?"</span>,</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"FR"</span>, <span class="st">"delete_script_subtext"</span>, <span class="st">"Etes-vous sûr de vouloir supprimer ce script ?"</span>,</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"EN"</span>, <span class="st">"script_deleted"</span>, <span class="st">"Script deleted"</span>,</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"FR"</span>, <span class="st">"script_deleted"</span>, <span class="st">"Script supprimé"</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a><span class="do">##########################################</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Add a new script                       #</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a><span class="do">##########################################</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a><span class="fu">observeEvent</span>(input<span class="sc">$</span>new_script_add_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span>, {</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tryCatch</span>({</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>        new_name <span class="ot">&lt;-</span> input<span class="sc">$</span>new_script_name_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">length</span>(new_name) <span class="sc">==</span> <span class="dv">0</span>) shiny.fluent<span class="sc">::</span><span class="fu">updateTextField.shinyInput</span>(session, <span class="st">"new_script_name_%group_id%_%study_id%"</span>, <span class="at">errorMessage =</span> <span class="fu">translate</span>(language, <span class="fu">paste0</span>(<span class="st">"provide_valid_name"</span>), r<span class="sc">$</span>words))</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span> shiny.fluent<span class="sc">::</span><span class="fu">updateTextField.shinyInput</span>(session, <span class="st">"new_script_name_%group_id%_%study_id%"</span>, <span class="at">errorMessage =</span> <span class="cn">NULL</span>)</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>        <span class="fu">req</span>(<span class="fu">length</span>(new_name) <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>        sql <span class="ot">&lt;-</span> <span class="st">"SELECT DISTINCT(value) FROM modules_elements_options WHERE deleted IS FALSE AND group_id = %group_id% AND study_id = %study_id% AND name = 'r_script_name'"</span> </span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>        distinct_values <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbGetQuery</span>(r<span class="sc">$</span>db, sql) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">pull</span>() <span class="sc">%&gt;%</span> <span class="fu">tolower</span>()</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">tolower</span>(new_name) <span class="sc">%in%</span> distinct_values) <span class="fu">show_message_bar</span>(output, <span class="dv">2</span>, <span class="st">"name_already_used"</span>, <span class="st">"severeWarning"</span>, language)</span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>        <span class="fu">req</span>(<span class="fu">tolower</span>(new_name) <span class="sc">%not_in%</span> distinct_values)</span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>        last_row <span class="ot">&lt;-</span> <span class="fu">get_last_row</span>(r<span class="sc">$</span>db, <span class="st">"modules_elements_options"</span>)</span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Insert new script in database</span></span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>        <span class="co"># One row for name, one row for code</span></span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>        sql <span class="ot">&lt;-</span> glue<span class="sc">::</span><span class="fu">glue_sql</span>(<span class="st">"INSERT INTO modules_elements_options(id, group_id, study_id, link_id, category, name, value, creator_id, datetime, deleted)</span></span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a><span class="st">            SELECT {last_row + 1}, %group_id%, %study_id%, {NA_integer_}, 'aggregated', 'r_script_name', {new_name}, {r$user_id}, {as.character(Sys.time())}, FALSE</span></span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a><span class="st">      UNION SELECT {last_row + 2}, %group_id%, %study_id%, {last_row + 1}, 'aggregated', 'r_script_code', '', {r$user_id}, { as.character(Sys.time())}, FALSE"</span>, <span class="at">.con =</span> r<span class="sc">$</span>db)</span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a>        query <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbSendStatement</span>(r<span class="sc">$</span>db, sql)</span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>        DBI<span class="sc">::</span><span class="fu">dbClearResult</span>(query)</span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Reset textfield</span></span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a>        shiny.fluent<span class="sc">::</span><span class="fu">updateTextField.shinyInput</span>(session, <span class="st">"new_script_name_%group_id%_%study_id%"</span>, <span class="at">value =</span> <span class="cn">NULL</span>)</span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Update dropdowns</span></span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a>        r<span class="sc">$</span>reload_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span> <span class="er">&lt;</span><span class="sc">-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true" tabindex="-1"></a>        <span class="fu">show_message_bar</span>(output, <span class="dv">1</span>, <span class="fu">translate</span>(language, <span class="st">"new_script_added"</span>, new_words), <span class="st">"success"</span>, language)</span>
<span id="cb10-55"><a href="#cb10-55" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-56"><a href="#cb10-56" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb10-57"><a href="#cb10-57" aria-hidden="true" tabindex="-1"></a>    <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cf">if</span> (<span class="fu">nchar</span>(e[<span class="dv">1</span>]) <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="fu">report_bug</span>(<span class="at">r =</span> r, <span class="at">output =</span> output, <span class="at">error_message =</span> <span class="st">"error_run_plugin_server_code"</span>, <span class="at">error_name =</span> <span class="st">"%group_id% - run server code"</span>, <span class="at">category =</span> <span class="st">"Error"</span>, <span class="at">error_report =</span> <span class="fu">toString</span>(e), <span class="at">language =</span> language))</span>
<span id="cb10-58"><a href="#cb10-58" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb10-59"><a href="#cb10-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-60"><a href="#cb10-60" aria-hidden="true" tabindex="-1"></a><span class="do">##########################################</span></span>
<span id="cb10-61"><a href="#cb10-61" aria-hidden="true" tabindex="-1"></a><span class="co"># Edit a script                          #</span></span>
<span id="cb10-62"><a href="#cb10-62" aria-hidden="true" tabindex="-1"></a><span class="do">##########################################</span></span>
<span id="cb10-63"><a href="#cb10-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-64"><a href="#cb10-64" aria-hidden="true" tabindex="-1"></a>    <span class="do">##########################################</span></span>
<span id="cb10-65"><a href="#cb10-65" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load script code                       #</span></span>
<span id="cb10-66"><a href="#cb10-66" aria-hidden="true" tabindex="-1"></a>    <span class="do">##########################################</span></span>
<span id="cb10-67"><a href="#cb10-67" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-68"><a href="#cb10-68" aria-hidden="true" tabindex="-1"></a>    <span class="fu">observeEvent</span>(input<span class="sc">$</span>Rcode_select_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span>, {</span>
<span id="cb10-69"><a href="#cb10-69" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-70"><a href="#cb10-70" aria-hidden="true" tabindex="-1"></a>        <span class="fu">tryCatch</span>({</span>
<span id="cb10-71"><a href="#cb10-71" aria-hidden="true" tabindex="-1"></a>            sql <span class="ot">&lt;-</span> glue<span class="sc">::</span><span class="fu">glue_sql</span>(<span class="st">"SELECT value FROM modules_elements_options WHERE deleted IS FALSE AND group_id = %group_id% AND study_id = %study_id% AND name = 'r_script_code' AND link_id = {as.integer(input$Rcode_select_%group_id%_%study_id%)}"</span>, <span class="at">.con =</span> r<span class="sc">$</span>db)</span>
<span id="cb10-72"><a href="#cb10-72" aria-hidden="true" tabindex="-1"></a>            code <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbGetQuery</span>(r<span class="sc">$</span>db, sql) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">pull</span>(value)</span>
<span id="cb10-73"><a href="#cb10-73" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb10-74"><a href="#cb10-74" aria-hidden="true" tabindex="-1"></a>            shinyAce<span class="sc">::</span><span class="fu">updateAceEditor</span>(session, <span class="st">"Rcode_%group_id%_%study_id%"</span>, <span class="at">value =</span> code)</span>
<span id="cb10-75"><a href="#cb10-75" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="cb10-76"><a href="#cb10-76" aria-hidden="true" tabindex="-1"></a>        <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cf">if</span> (<span class="fu">nchar</span>(e[<span class="dv">1</span>]) <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="fu">report_bug</span>(<span class="at">r =</span> r, <span class="at">output =</span> output, <span class="at">error_message =</span> <span class="st">"error_run_plugin_server_code"</span>, <span class="at">error_name =</span> <span class="st">"%group_id% - run server code"</span>, <span class="at">category =</span> <span class="st">"Error"</span>, <span class="at">error_report =</span> <span class="fu">toString</span>(e), <span class="at">language =</span> language))</span>
<span id="cb10-77"><a href="#cb10-77" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb10-78"><a href="#cb10-78" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-79"><a href="#cb10-79" aria-hidden="true" tabindex="-1"></a>    <span class="do">##########################################</span></span>
<span id="cb10-80"><a href="#cb10-80" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Save updates                           #</span></span>
<span id="cb10-81"><a href="#cb10-81" aria-hidden="true" tabindex="-1"></a>    <span class="do">##########################################</span></span>
<span id="cb10-82"><a href="#cb10-82" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-83"><a href="#cb10-83" aria-hidden="true" tabindex="-1"></a>    <span class="fu">observeEvent</span>(input<span class="sc">$</span>Rcode_save_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span>, {</span>
<span id="cb10-84"><a href="#cb10-84" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-85"><a href="#cb10-85" aria-hidden="true" tabindex="-1"></a>        <span class="fu">tryCatch</span>({</span>
<span id="cb10-86"><a href="#cb10-86" aria-hidden="true" tabindex="-1"></a>            <span class="fu">req</span>(<span class="sc">!</span><span class="fu">is.na</span>(input<span class="sc">$</span>Rcode_select_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span>))</span>
<span id="cb10-87"><a href="#cb10-87" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-88"><a href="#cb10-88" aria-hidden="true" tabindex="-1"></a>            code <span class="ot">&lt;-</span> input<span class="sc">$</span>Rcode_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span> <span class="sc">%&gt;%</span> stringr<span class="sc">::</span><span class="fu">str_replace_all</span>(<span class="st">"</span><span class="sc">\r</span><span class="st">"</span>, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb10-89"><a href="#cb10-89" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb10-90"><a href="#cb10-90" aria-hidden="true" tabindex="-1"></a>            sql <span class="ot">&lt;-</span> glue<span class="sc">::</span><span class="fu">glue_sql</span>(<span class="st">"UPDATE modules_elements_options SET value = {code} WHERE name = 'r_script_code' AND link_id = {as.integer(input$Rcode_select_%group_id%_%study_id%)}"</span>, <span class="at">.con =</span> r<span class="sc">$</span>db)</span>
<span id="cb10-91"><a href="#cb10-91" aria-hidden="true" tabindex="-1"></a>            query <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbSendStatement</span>(r<span class="sc">$</span>db, sql)</span>
<span id="cb10-92"><a href="#cb10-92" aria-hidden="true" tabindex="-1"></a>            DBI<span class="sc">::</span><span class="fu">dbClearResult</span>(query)</span>
<span id="cb10-93"><a href="#cb10-93" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb10-94"><a href="#cb10-94" aria-hidden="true" tabindex="-1"></a>            <span class="fu">show_message_bar</span>(<span class="at">output =</span> output, <span class="at">id =</span> <span class="dv">3</span>, <span class="at">message =</span> <span class="st">"modif_saved"</span>, <span class="at">type =</span> <span class="st">"success"</span>, <span class="at">language =</span> language)</span>
<span id="cb10-95"><a href="#cb10-95" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb10-96"><a href="#cb10-96" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="cb10-97"><a href="#cb10-97" aria-hidden="true" tabindex="-1"></a>        <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cf">if</span> (<span class="fu">nchar</span>(e[<span class="dv">1</span>]) <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="fu">report_bug</span>(<span class="at">r =</span> r, <span class="at">output =</span> output, <span class="at">error_message =</span> <span class="st">"error_run_plugin_server_code"</span>, <span class="at">error_name =</span> <span class="st">"%group_id% - run server code"</span>, <span class="at">category =</span> <span class="st">"Error"</span>, <span class="at">error_report =</span> <span class="fu">toString</span>(e), <span class="at">language =</span> language))</span>
<span id="cb10-98"><a href="#cb10-98" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb10-99"><a href="#cb10-99" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-100"><a href="#cb10-100" aria-hidden="true" tabindex="-1"></a>    <span class="do">##########################################</span></span>
<span id="cb10-101"><a href="#cb10-101" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Execute script code                    #</span></span>
<span id="cb10-102"><a href="#cb10-102" aria-hidden="true" tabindex="-1"></a>    <span class="do">##########################################</span></span>
<span id="cb10-103"><a href="#cb10-103" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-104"><a href="#cb10-104" aria-hidden="true" tabindex="-1"></a>    <span class="fu">observeEvent</span>(input<span class="sc">$</span>Rcode_execute_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span>, {</span>
<span id="cb10-105"><a href="#cb10-105" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-106"><a href="#cb10-106" aria-hidden="true" tabindex="-1"></a>        <span class="fu">tryCatch</span>({</span>
<span id="cb10-107"><a href="#cb10-107" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-108"><a href="#cb10-108" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Change this option to display correctly tibble in textbox</span></span>
<span id="cb10-109"><a href="#cb10-109" aria-hidden="true" tabindex="-1"></a>            <span class="fu">options</span>(<span class="st">'cli.num_colors'</span> <span class="ot">=</span> <span class="dv">1</span>)</span>
<span id="cb10-110"><a href="#cb10-110" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb10-111"><a href="#cb10-111" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Capture console output of our code</span></span>
<span id="cb10-112"><a href="#cb10-112" aria-hidden="true" tabindex="-1"></a>            captured_output <span class="ot">&lt;-</span> <span class="fu">capture.output</span>(</span>
<span id="cb10-113"><a href="#cb10-113" aria-hidden="true" tabindex="-1"></a>              <span class="fu">tryCatch</span>(<span class="fu">eval</span>(<span class="fu">parse</span>(<span class="at">text =</span> <span class="fu">as.character</span>(input<span class="sc">$</span>Rcode_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span>) <span class="sc">%&gt;%</span> stringr<span class="sc">::</span><span class="fu">str_replace_all</span>(<span class="st">"</span><span class="sc">\r</span><span class="st">"</span>, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>))), <span class="at">error =</span> <span class="cf">function</span>(e) <span class="fu">print</span>(e), <span class="at">warning =</span> <span class="cf">function</span>(w) <span class="fu">print</span>(w)))</span>
<span id="cb10-114"><a href="#cb10-114" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb10-115"><a href="#cb10-115" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Display result</span></span>
<span id="cb10-116"><a href="#cb10-116" aria-hidden="true" tabindex="-1"></a>            output<span class="sc">$</span>Rcode_result <span class="ot">&lt;-</span> <span class="fu">renderText</span>(<span class="fu">paste</span>(captured_output, <span class="at">collapse =</span> <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>))</span>
<span id="cb10-117"><a href="#cb10-117" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb10-118"><a href="#cb10-118" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Restore normal value</span></span>
<span id="cb10-119"><a href="#cb10-119" aria-hidden="true" tabindex="-1"></a>            <span class="fu">options</span>(<span class="st">'cli.num_colors'</span> <span class="ot">=</span> <span class="cn">NULL</span>)</span>
<span id="cb10-120"><a href="#cb10-120" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-121"><a href="#cb10-121" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="cb10-122"><a href="#cb10-122" aria-hidden="true" tabindex="-1"></a>        <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cf">if</span> (<span class="fu">nchar</span>(e[<span class="dv">1</span>]) <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="fu">report_bug</span>(<span class="at">r =</span> r, <span class="at">output =</span> output, <span class="at">error_message =</span> <span class="st">"error_run_plugin_server_code"</span>, <span class="at">error_name =</span> <span class="st">"%group_id% - run server code"</span>, <span class="at">category =</span> <span class="st">"Error"</span>, <span class="at">error_report =</span> <span class="fu">toString</span>(e), <span class="at">language =</span> language))</span>
<span id="cb10-123"><a href="#cb10-123" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb10-124"><a href="#cb10-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-125"><a href="#cb10-125" aria-hidden="true" tabindex="-1"></a><span class="do">##########################################</span></span>
<span id="cb10-126"><a href="#cb10-126" aria-hidden="true" tabindex="-1"></a><span class="co"># Delete a script                        #</span></span>
<span id="cb10-127"><a href="#cb10-127" aria-hidden="true" tabindex="-1"></a><span class="do">##########################################</span></span>
<span id="cb10-128"><a href="#cb10-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-129"><a href="#cb10-129" aria-hidden="true" tabindex="-1"></a><span class="co"># Delete button is pressed</span></span>
<span id="cb10-130"><a href="#cb10-130" aria-hidden="true" tabindex="-1"></a><span class="fu">observeEvent</span>(input<span class="sc">$</span>delete_script_validate_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span>, r<span class="sc">$</span>delete_dialog_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span> <span class="er">&lt;</span><span class="sc">-</span> <span class="cn">TRUE</span>)</span>
<span id="cb10-131"><a href="#cb10-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-132"><a href="#cb10-132" aria-hidden="true" tabindex="-1"></a><span class="co"># Rendering react output</span></span>
<span id="cb10-133"><a href="#cb10-133" aria-hidden="true" tabindex="-1"></a><span class="fu">observeEvent</span>(r<span class="sc">$</span>delete_dialog_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span> , {</span>
<span id="cb10-134"><a href="#cb10-134" aria-hidden="true" tabindex="-1"></a>    output<span class="sc">$</span>delete_confirm <span class="ot">&lt;-</span> shiny.fluent<span class="sc">::</span><span class="fu">renderReact</span>({</span>
<span id="cb10-135"><a href="#cb10-135" aria-hidden="true" tabindex="-1"></a>        dialogContentProps <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb10-136"><a href="#cb10-136" aria-hidden="true" tabindex="-1"></a>            <span class="at">type =</span> <span class="dv">0</span>,</span>
<span id="cb10-137"><a href="#cb10-137" aria-hidden="true" tabindex="-1"></a>            <span class="at">title =</span> <span class="fu">translate</span>(language, <span class="st">"delete_script"</span>, new_words),</span>
<span id="cb10-138"><a href="#cb10-138" aria-hidden="true" tabindex="-1"></a>            <span class="at">closeButtonAriaLabel =</span> <span class="st">"Close"</span>,</span>
<span id="cb10-139"><a href="#cb10-139" aria-hidden="true" tabindex="-1"></a>            <span class="at">subText =</span> <span class="fu">translate</span>(language, <span class="st">"delete_script_subtext"</span>, new_words)</span>
<span id="cb10-140"><a href="#cb10-140" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb10-141"><a href="#cb10-141" aria-hidden="true" tabindex="-1"></a>        shiny.fluent<span class="sc">::</span><span class="fu">Dialog</span>(</span>
<span id="cb10-142"><a href="#cb10-142" aria-hidden="true" tabindex="-1"></a>            <span class="at">hidden =</span> <span class="sc">!</span>r<span class="sc">$</span>delete_dialog_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span>,</span>
<span id="cb10-143"><a href="#cb10-143" aria-hidden="true" tabindex="-1"></a>            <span class="at">onDismiss =</span> htmlwidgets<span class="sc">::</span><span class="fu">JS</span>(<span class="fu">paste0</span>(<span class="st">"function() { Shiny.setInputValue('hide_dialog_%group_id%_%study_id%', Math.random()); }"</span>)),</span>
<span id="cb10-144"><a href="#cb10-144" aria-hidden="true" tabindex="-1"></a>            <span class="at">dialogContentProps =</span> dialogContentProps,</span>
<span id="cb10-145"><a href="#cb10-145" aria-hidden="true" tabindex="-1"></a>            <span class="at">modalProps =</span> <span class="fu">list</span>(),</span>
<span id="cb10-146"><a href="#cb10-146" aria-hidden="true" tabindex="-1"></a>            shiny.fluent<span class="sc">::</span><span class="fu">DialogFooter</span>(</span>
<span id="cb10-147"><a href="#cb10-147" aria-hidden="true" tabindex="-1"></a>                shiny.fluent<span class="sc">::</span><span class="fu">PrimaryButton.shinyInput</span>(<span class="fu">ns</span>(<span class="st">"delete_confirmed_%group_id%_%study_id%"</span>), <span class="at">text =</span> <span class="fu">translate</span>(language, <span class="st">"delete"</span>, r<span class="sc">$</span>words)),</span>
<span id="cb10-148"><a href="#cb10-148" aria-hidden="true" tabindex="-1"></a>                shiny.fluent<span class="sc">::</span><span class="fu">DefaultButton.shinyInput</span>(<span class="fu">ns</span>(<span class="st">"delete_canceled_%group_id%_%study_id%"</span>), <span class="at">text =</span> <span class="fu">translate</span>(language, <span class="st">"dont_delete"</span>, r<span class="sc">$</span>words))</span>
<span id="cb10-149"><a href="#cb10-149" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb10-150"><a href="#cb10-150" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb10-151"><a href="#cb10-151" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb10-152"><a href="#cb10-152" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb10-153"><a href="#cb10-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-154"><a href="#cb10-154" aria-hidden="true" tabindex="-1"></a><span class="co"># Whether to close or not delete dialog box</span></span>
<span id="cb10-155"><a href="#cb10-155" aria-hidden="true" tabindex="-1"></a><span class="fu">observeEvent</span>(input<span class="sc">$</span>hide_dialog_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span>, r<span class="sc">$</span>delete_dialog_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span> <span class="er">&lt;</span><span class="sc">-</span> <span class="cn">FALSE</span>)</span>
<span id="cb10-156"><a href="#cb10-156" aria-hidden="true" tabindex="-1"></a><span class="fu">observeEvent</span>(input<span class="sc">$</span>delete_canceled_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span>, r<span class="sc">$</span>delete_dialog_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span> <span class="er">&lt;</span><span class="sc">-</span> <span class="cn">FALSE</span>)</span>
<span id="cb10-157"><a href="#cb10-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-158"><a href="#cb10-158" aria-hidden="true" tabindex="-1"></a><span class="co"># When the delete is confirmed</span></span>
<span id="cb10-159"><a href="#cb10-159" aria-hidden="true" tabindex="-1"></a><span class="fu">observeEvent</span>(input<span class="sc">$</span>delete_confirmed_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span>, {</span>
<span id="cb10-160"><a href="#cb10-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-161"><a href="#cb10-161" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tryCatch</span>({</span>
<span id="cb10-162"><a href="#cb10-162" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-163"><a href="#cb10-163" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get value of deleted row</span></span>
<span id="cb10-164"><a href="#cb10-164" aria-hidden="true" tabindex="-1"></a>        row_deleted <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(input<span class="sc">$</span>delete_script_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span>)</span>
<span id="cb10-165"><a href="#cb10-165" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-166"><a href="#cb10-166" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Delete row in database</span></span>
<span id="cb10-167"><a href="#cb10-167" aria-hidden="true" tabindex="-1"></a>        sql <span class="ot">&lt;-</span> glue<span class="sc">::</span><span class="fu">glue_sql</span>(<span class="st">"UPDATE modules_elements_options SET deleted = TRUE WHERE id = {row_deleted} OR link_id = {row_deleted}"</span>, <span class="at">.con =</span> r<span class="sc">$</span>db)</span>
<span id="cb10-168"><a href="#cb10-168" aria-hidden="true" tabindex="-1"></a>        query <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbSendStatement</span>(r<span class="sc">$</span>db, sql)</span>
<span id="cb10-169"><a href="#cb10-169" aria-hidden="true" tabindex="-1"></a>        DBI<span class="sc">::</span><span class="fu">dbClearResult</span>(query)</span>
<span id="cb10-170"><a href="#cb10-170" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-171"><a href="#cb10-171" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Close dialog box</span></span>
<span id="cb10-172"><a href="#cb10-172" aria-hidden="true" tabindex="-1"></a>        r<span class="sc">$</span>delete_dialog_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span> <span class="er">&lt;</span><span class="sc">-</span> <span class="cn">FALSE</span></span>
<span id="cb10-173"><a href="#cb10-173" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-174"><a href="#cb10-174" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Notification to user</span></span>
<span id="cb10-175"><a href="#cb10-175" aria-hidden="true" tabindex="-1"></a>        <span class="fu">show_message_bar</span>(<span class="at">output =</span> output, <span class="at">id =</span> <span class="dv">3</span>, <span class="fu">translate</span>(language, <span class="st">"script_deleted"</span>, new_words), <span class="at">type =</span> <span class="st">"severeWarning"</span>, <span class="at">language =</span> language)</span>
<span id="cb10-176"><a href="#cb10-176" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-177"><a href="#cb10-177" aria-hidden="true" tabindex="-1"></a>        r<span class="sc">$</span>reload_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span> <span class="er">&lt;</span><span class="sc">-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb10-178"><a href="#cb10-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-179"><a href="#cb10-179" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb10-180"><a href="#cb10-180" aria-hidden="true" tabindex="-1"></a>    <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cf">if</span> (<span class="fu">nchar</span>(e[<span class="dv">1</span>]) <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="fu">report_bug</span>(<span class="at">r =</span> r, <span class="at">output =</span> output, <span class="at">error_message =</span> <span class="st">"error_run_plugin_server_code"</span>, <span class="at">error_name =</span> <span class="st">"%group_id% - run server code"</span>, <span class="at">category =</span> <span class="st">"Error"</span>, <span class="at">error_report =</span> <span class="fu">toString</span>(e), <span class="at">language =</span> language))</span>
<span id="cb10-181"><a href="#cb10-181" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb10-182"><a href="#cb10-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-183"><a href="#cb10-183" aria-hidden="true" tabindex="-1"></a><span class="do">##########################################</span></span>
<span id="cb10-184"><a href="#cb10-184" aria-hidden="true" tabindex="-1"></a><span class="co"># Reload data                            #</span></span>
<span id="cb10-185"><a href="#cb10-185" aria-hidden="true" tabindex="-1"></a><span class="do">##########################################</span></span>
<span id="cb10-186"><a href="#cb10-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-187"><a href="#cb10-187" aria-hidden="true" tabindex="-1"></a><span class="fu">observeEvent</span>(r<span class="sc">$</span>reload_<span class="sc">%group_id%</span>_<span class="sc">%study_id%</span>, {</span>
<span id="cb10-188"><a href="#cb10-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-189"><a href="#cb10-189" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Update dropdowns</span></span>
<span id="cb10-190"><a href="#cb10-190" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-191"><a href="#cb10-191" aria-hidden="true" tabindex="-1"></a>    options <span class="ot">&lt;-</span> <span class="fu">convert_tibble_to_list</span>(DBI<span class="sc">::</span><span class="fu">dbGetQuery</span>(r<span class="sc">$</span>db, <span class="st">"SELECT * FROM modules_elements_options WHERE deleted IS FALSE AND group_id = %group_id% AND study_id = %study_id% AND name = 'r_script_name'"</span>), <span class="at">key_col =</span> <span class="st">"id"</span>, <span class="at">text_col =</span> <span class="st">"value"</span>)</span>
<span id="cb10-192"><a href="#cb10-192" aria-hidden="true" tabindex="-1"></a>    shiny.fluent<span class="sc">::</span><span class="fu">updateDropdown.shinyInput</span>(session, <span class="st">"Rcode_select_%group_id%_%study_id%"</span>, <span class="at">options =</span> options)</span>
<span id="cb10-193"><a href="#cb10-193" aria-hidden="true" tabindex="-1"></a>    shiny.fluent<span class="sc">::</span><span class="fu">updateDropdown.shinyInput</span>(session, <span class="st">"delete_script_%group_id%_%study_id%"</span>, <span class="at">options =</span> options)</span>
<span id="cb10-194"><a href="#cb10-194" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-195"><a href="#cb10-195" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Boris Delange.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.1.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
