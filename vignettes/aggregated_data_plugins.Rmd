---
title: "Aggregated data plugins"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Aggregated data plugins}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Exclusion criteria manager

### Description

- **Version** : 0.0.1
- **Libraries** : none

### UI code

```{r, eval = FALSE}
temp <- function(){

    # Create our dictionnary
    new_words <- tibble::tribble(~language, ~reference_word, ~translated_word,
        "EN", "add_exclusion_criterion", "Add an exclusion criterion",
        "FR", "add_exclusion_criterion", "Ajouter un critère d'exclusion",
        "EN", "exclusion_criteria_management", "Exclusion criteria management",
        "FR", "exclusion_criteria_management", "Gestion des critères d'exclusion"
    )
    
    # Render UI
    div(
        shiny.fluent::Text(variant = "large", translate(language, "add_exclusion_criterion", new_words), block = TRUE), br(),
        shiny.fluent::Stack(horizontal = TRUE, tokens = list(childrenGap = 20),
            make_textfield(language = language, ns = ns, label = "name", id = "name_%group_id%_%study_id%", width = "300px"),
            div(shiny.fluent::PrimaryButton.shinyInput(ns("add_%group_id%_%study_id%"), translate(language, "add", r$words)), style = "margin-top:38px;")
        ),
        br(), hr(),
        shiny.fluent::Text(variant = "large", translate(language, "exclusion_criteria_management", new_words), block = TRUE),
        div(
            DT::DTOutput(ns("datatable_%group_id%_%study_id%")),
            shiny.fluent::PrimaryButton.shinyInput(ns("save_%group_id%_%study_id%"), translate(language, "save", r$words))
        )
    ) -> result
    
    result
}

temp()
```

### Server code

```{r, eval = FALSE}
##########################################
# Translations                           #
##########################################

# Create our dictionnary
new_words <- tibble::tribble(~language, ~reference_word, ~translated_word,
    "EN", "exclusion_criterion_added", "New exclusion criterion added",
    "FR", "exclusion_criterion_added", "Nouveau critère d'exclusion ajouté",
    "EN", "delete_exclusion_criterion", "Delete an exclusion criterion",
    "FR", "delete_exclusion_criterion", "Supprimer un critère d'exclusion",
    "EN", "delete_exclusion_criterion_subtext", "Are you sure you want to delete this exclusion criterion ?",
    "FR", "delete_exclusion_criterion_subtext", "Etes-vous sûr de vouloir supprimer ce critère d'exclusion ?",
    "EN", "exclusion_criterion_deleted", "Exclusion criterion deleted",
    "FR", "exclusion_criterion_deleted", "Critère d'exclusion supprimé"
)

##########################################
# Load current exclusion criteria        #
##########################################

plugins_load_%group_id%_%study_id% <- function(r){

    # Load exclusion criteria
    sql <- "SELECT id, value, creator_id, datetime FROM modules_elements_options WHERE deleted IS FALSE AND group_id = %group_id% AND study_id = %study_id% AND category = 'aggregated' AND name = 'exclusion_reason_name'"
    exclusion_criteria <- DBI::dbGetQuery(r$db, sql)
    
    # Load display orders
    sql <- "SELECT link_id, value_num FROM modules_elements_options WHERE deleted IS FALSE AND group_id = %group_id% AND study_id = %study_id% AND category = 'aggregated' AND name = 'display_order'"
    display_orders <- DBI::dbGetQuery(r$db, sql) %>% dplyr::select(id = link_id, display_order = value_num)
    
    # Merge the two tables
    # Reset display_order column (if we have display orders 1, 2 & 4 in database - if on criterion has been deleted - we will have 1, 2 & 3)
    exclusion_criteria <- exclusion_criteria %>% dplyr::left_join(display_orders, by = "id") %>% dplyr::relocate(display_order, .after = "value") %>% dplyr::arrange(display_order)
    
    # Get creator name
    exclusion_criteria <- 
        exclusion_criteria %>% 
        dplyr::left_join(
            isolate(r$users) %>% dplyr::transmute(creator_id = id, creator_name = paste0(firstname, " ", lastname)),
            by = "creator_id") %>%
        dplyr::relocate(creator_name, .after = "display_order") %>% dplyr::select(-creator_id)
        
    r$plugins_data_%group_id%_%study_id% <- exclusion_criteria
}

plugins_load_%group_id%_%study_id%(r)

# Dropdowns observers already created
r$plugins_dropdowns_observers_%group_id%_%study_id% <- integer()

##########################################
# Add a new exclusion criterion          #
##########################################

observeEvent(input$add_%group_id%_%study_id%, {

    tryCatch({
    
        new_name <- input$name_%group_id%_%study_id%
        
        if (length(new_name) == 0) shiny.fluent::updateTextField.shinyInput(session, "name_%group_id%_%study_id%", errorMessage = translate(language, paste0("provide_valid_name"), r$words))
        else shiny.fluent::updateTextField.shinyInput(session, "name_%group_id%_%study_id%", errorMessage = NULL)
        
        req(length(new_name) > 0)
        
        sql <- "SELECT DISTINCT(value) FROM modules_elements_options WHERE deleted IS FALSE AND group_id = %group_id% AND study_id = %study_id% AND name = 'exclusion_reason_name'" 
        distinct_values <- DBI::dbGetQuery(r$db, sql) %>% dplyr::pull() %>% tolower()
          
        if (tolower(new_name) %in% distinct_values) show_message_bar(output, 2, "name_already_used", "severeWarning", language)
        req(tolower(new_name) %not_in% distinct_values)
        
        last_row <- get_last_row(r$db, "modules_elements_options")
        datetime <- as.character(Sys.time())
        
        # Insert new exclusion criterion in database
        
        sql <- glue::glue_sql("INSERT INTO modules_elements_options(id, group_id, study_id, category, name, value, creator_id, datetime, deleted)
            SELECT {last_row + 1}, %group_id%, %study_id%, 'aggregated', 'exclusion_reason_name', {new_name}, {r$user_id}, {datetime}, FALSE", .con = r$db)
        query <- DBI::dbSendStatement(r$db, sql)
        DBI::dbClearResult(query)
        
        # Insert also its display order
        sql <- glue::glue_sql(paste0("SELECT COALESCE(MAX(value_num), 0) FROM modules_elements_options WHERE deleted IS FALSE AND group_id = %group_id% AND study_id = %study_id%",
            " AND category = 'aggregated' AND name = 'display_order'"), .con = r$db)
        last_display_order <- DBI::dbGetQuery(r$db, sql) %>% dplyr::pull()
        
        sql <- glue::glue_sql("INSERT INTO modules_elements_options(id, group_id, study_id, link_id, category, name, value_num, creator_id, datetime, deleted)
            SELECT {last_row + 2}, %group_id%, %study_id%, {last_row + 1}, 'aggregated', 'display_order', {last_display_order + 1}, {r$user_id}, {datetime}, FALSE", .con = r$db)
        query <- DBI::dbSendStatement(r$db, sql)
        DBI::dbClearResult(query)
        
        # Reload data
        plugins_load_%group_id%_%study_id%(r)
        
        # Reset textfield
        shiny.fluent::updateTextField.shinyInput(session, "name_%group_id%_%study_id%", value = NULL)
        
        show_message_bar(output, 1, translate(language, "exclusion_criterion_added", new_words), "success", language)
        
        # Send a message to flowchart's plugin, to reload data
        r$reload_flowchart_%study_id% <- TRUE
    
    },
    error = function(e) if (nchar(e[1]) > 0) report_bug(r = r, output = output, error_message = "error_run_plugin_server_code", 
      error_name = "%group_id% - run server code", category = "Error", error_report = toString(e), language = language),
    warning = function(w) if (nchar(w[1]) > 0) report_bug(r = r, output = output, error_message = "error_run_plugin_server_code", 
      error_name = "%group_id% - run server code", category = "Warning", error_report = toString(w), language = language))
})

##########################################
# Management datatable                   #
##########################################

col_names <- c("Name", "Display order", "Creator", "Datetime", "Action")
sortable_cols <- c("value", "display_order", "creator_name", "datetime")
centered_cols <- c("datetime", "display_order", "action", "creator_name")
column_widths <- c("datetime" = "180px", "action" = "80px", "display_order" = "100px", "creator_name" = "100px", "name" = "400px")
searchable_cols <- c("value", "datetime", "creator_name")


observeEvent(r$plugins_data_%group_id%_%study_id%, {

    tryCatch({
    
        # Get page_id for dropdowns & delete button
        page_id <- id
        
        # Add dropdown for display order & delete buttons
        
        options <- list()
        if (nrow(r$plugins_data_%group_id%_%study_id%) > 0){
            
            options <- convert_tibble_to_list(data = r$plugins_data_%group_id%_%study_id% %>% dplyr::mutate(n = 1:dplyr::n()), key_col = "n", text_col = "n")
            
            # If this is not an update of the dropdowns
            
            if (length(unique(r$plugins_data_%group_id%_%study_id%$display_order)) == nrow(r$plugins_data_%group_id%_%study_id%)){
                r$plugins_data_%group_id%_%study_id% <- r$plugins_data_%group_id%_%study_id% %>% dplyr::arrange(display_order) %>% dplyr::mutate(n = 1:dplyr::n())} 
            else r$plugins_data_%group_id%_%study_id% <- r$plugins_data_%group_id%_%study_id% %>% dplyr::mutate(n = display_order)
            
            data_temp <- r$plugins_data_%group_id%_%study_id% %>%
                dplyr::rowwise() %>%
                dplyr::mutate(
                    display_order = as.character(
                        div(
                            shiny.fluent::Dropdown.shinyInput(ns(paste0("dropdown_%group_id%_%study_id%_", id)),
                                options = options, value = as.integer(n),
                                onclick = paste0("Shiny.setInputValue('", page_id, "-dropdown_updated', '", paste0("dropdown_%group_id%_%study_id%_value_", id), "', {priority: 'event'})"),
                                style = "width:120px;"
                            )
                        )
                    ),
                    action = as.character(
                        div(
                            shiny::actionButton(ns(paste0("delete_%group_id%_%study_id%_", id)), "", icon = icon("trash-alt"),
                            onclick = paste0("Shiny.setInputValue('", page_id, "-deleted_pressed_%group_id%_%study_id%', this.id, {priority: 'event'})"))
                        )
                    )
                ) %>%
                dplyr::select(-id, -n)
        }
        else data_temp <- tibble::tibble()
    
        # Render datatable
        render_datatable(
            data = data_temp,
            output = output,
            r = r,
            ns = ns,
            language = language,
            output_name = "datatable_%group_id%_%study_id%",
            col_names = col_names,
            page_length = 20,
            sortable_cols = sortable_cols,
            centered_cols = centered_cols,
            column_widths = column_widths,
            filter = TRUE,
            searchable_cols = searchable_cols
        )
        
        # Make an observer by dropdown
        sapply(r$plugins_data_%group_id%_%study_id% %>% dplyr::pull(id), function(id){
        
            if (id %not_in% r$plugins_dropdowns_observers_%group_id%_%study_id%){
        
                observeEvent(input[[paste0("dropdown_%group_id%_%study_id%_", id)]], {
                
                    new_value <- input[[paste0("dropdown_%group_id%_%study_id%_", id)]]
                    old_value <- r$plugins_data_%group_id%_%study_id%[[which(r$plugins_data_%group_id%_%study_id%["id"] == id), "display_order"]]
                    
                    # If value is changed
                    if (old_value != new_value){
                    
                        r$plugins_data_%group_id%_%study_id%[[which(r$plugins_data_%group_id%_%study_id%["id"] == id), "display_order"]] <- new_value
                        
                        if (new_value > old_value){
                            ids <- r$plugins_data_%group_id%_%study_id% %>% dplyr::filter(display_order >= old_value & display_order <= new_value & id != !!id) %>% dplyr::pull(id)
                            adding <- -1L
                        }
                        if (new_value < old_value){
                            ids <- r$plugins_data_%group_id%_%study_id% %>% dplyr::filter(display_order >= new_value & display_order <= old_value & id != !!id) %>% dplyr::pull(id)
                            adding <- 1L
                        } 
                        
                        # For each row to update, change value in r variable & update dropdown
                        sapply(ids, function(id_bis){
                        
                            display_order <- r$plugins_data_%group_id%_%study_id%[[which(r$plugins_data_%group_id%_%study_id%["id"] == id_bis), "display_order"]]
                            r$plugins_data_%group_id%_%study_id%[[which(r$plugins_data_%group_id%_%study_id%["id"] == id_bis), "display_order"]] <- display_order + adding
                            shiny.fluent::updateDropdown.shinyInput(session, paste0("dropdown_%group_id%_%study_id%_", id_bis), value = display_order + adding)
                        })
                    }
                    
                }, ignoreInit = TRUE)
                
                r$plugins_dropdowns_observers_%group_id%_%study_id% <- c(r$plugins_dropdowns_observers_%group_id%_%study_id%, id)
            }
        })
    },
    error = function(e) if (nchar(e[1]) > 0) report_bug(r = r, output = output, error_message = "error_run_plugin_server_code", 
      error_name = "%group_id% - run server code", category = "Error", error_report = toString(e), language = language),
    warning = function(w) if (nchar(w[1]) > 0) report_bug(r = r, output = output, error_message = "error_run_plugin_server_code", 
      error_name = "%group_id% - run server code", category = "Warning", error_report = toString(w), language = language))
})

##########################################
# Change display order                   #
##########################################

observeEvent(input$save_%group_id%_%study_id%, {

    tryCatch({
        duplicates_display_order <- r$plugins_data_%group_id%_%study_id% %>% 
            dplyr::group_by(display_order) %>% dplyr::summarize(n = dplyr::n()) %>% dplyr::filter(n > 1) %>% nrow()
            
        if (duplicates_display_order > 0) show_message_bar(output, 1, "modif_display_order_duplicates", "severeWarning", language)
        
        req(duplicates_display_order == 0)
        
        # Delete data from table
        ids_to_del <- r$plugins_data_%group_id%_%study_id% %>% dplyr::pull(id)
        DBI::dbSendStatement(r$db, paste0("DELETE FROM modules_elements_options WHERE link_id IN (", paste(ids_to_del, collapse = ","), ")")) -> query
        DBI::dbClearResult(query)
        
        # Append data to table
        last_row <- get_last_row(r$db, "modules_elements_options")
        
        new_data <- r$plugins_data_%group_id%_%study_id% %>%
            dplyr::transmute(group_id = %group_id%, study_id = %study_id%, patient_id = NA_integer_, link_id = id, category = "aggregated", name = "display_order", 
                value = NA_character_, value_num = display_order, creator_id = r$user_id, datetime, deleted = FALSE) %>%
            dplyr::mutate(id) %>% dplyr::relocate(id)
        new_data$id <- seq.int(nrow(new_data)) + last_row
        
        DBI::dbAppendTable(r$db, "modules_elements_options", new_data)
        
        # Notification to the user
        show_message_bar(output, 2, "modif_saved", "success", language)
        
        # Send a message to flowchart's plugin, to reload data
        r$reload_flowchart_%study_id% <- TRUE
    }, 
    error = function(e) if (nchar(e[1]) > 0) report_bug(r = r, output = output, error_message = "error_run_plugin_server_code", 
      error_name = "%group_id% - run server code", category = "Error", error_report = toString(e), language = language),
    warning = function(w) if (nchar(w[1]) > 0) report_bug(r = r, output = output, error_message = "error_run_plugin_server_code", 
      error_name = "%group_id% - run server code", category = "Warning", error_report = toString(w), language = language))
})

##########################################
# Delete a row                           #
##########################################
    
# Delete button is pressed
observeEvent(input$deleted_pressed_%group_id%_%study_id%, r$delete_dialog_%group_id%_%study_id% <- TRUE)

# Rendering react output
observeEvent(r$delete_dialog_%group_id%_%study_id% , {
    output$delete_confirm <- shiny.fluent::renderReact({
        dialogContentProps <- list(
            type = 0,
            title = translate(language, "delete_exclusion_criterion", new_words),
            closeButtonAriaLabel = "Close",
            subText = translate(language, "delete_exclusion_criterion_subtext", new_words)
        )
        shiny.fluent::Dialog(
            hidden = !r$delete_dialog_%group_id%_%study_id%,
            onDismiss = htmlwidgets::JS(paste0("function() { Shiny.setInputValue('hide_dialog_%group_id%_%study_id%', Math.random()); }")),
            dialogContentProps = dialogContentProps,
            modalProps = list(),
            shiny.fluent::DialogFooter(
                shiny.fluent::PrimaryButton.shinyInput(ns("delete_confirmed_%group_id%_%study_id%"), text = translate(language, "delete", r$words)),
                shiny.fluent::DefaultButton.shinyInput(ns("delete_canceled_%group_id%_%study_id%"), text = translate(language, "dont_delete", r$words))
            )
        )
    })
})

# Whether to close or not delete dialog box
observeEvent(input$hide_dialog_%group_id%_%study_id%, r$delete_dialog_%group_id%_%study_id% <- FALSE)
observeEvent(input$delete_canceled_%group_id%_%study_id%, r$delete_dialog_%group_id%_%study_id% <- FALSE)

# When the delete is confirmed
observeEvent(input$delete_confirmed_%group_id%_%study_id%, {

    tryCatch({
        
        # Get value of deleted row
        row_deleted <- as.integer(substr(input$deleted_pressed_%group_id%_%study_id%, nchar(paste0(id, "-delete_%group_id%_%study_id%_")) + 1, nchar(input$deleted_pressed_%group_id%_%study_id%)))
        
        # Delete row in database
        sql <- glue::glue_sql("UPDATE modules_elements_options SET deleted = TRUE WHERE id = {row_deleted} OR link_id = {row_deleted}", .con = r$db)
        query <- DBI::dbSendStatement(r$db, sql)
        DBI::dbClearResult(query)
        
        # Change display orders, depending on the display order of deleted row
        sql <- glue::glue_sql("SELECT value_num FROM modules_elements_options WHERE link_id = {row_deleted}", .con = r$db)
        display_order_deleted <- DBI::dbGetQuery(r$db, sql) %>% dplyr::pull()
        sql <- glue::glue_sql(paste0("UPDATE modules_elements_options SET value_num = value_num - 1",
            " WHERE deleted IS FALSE AND group_id = %group_id% AND study_id = %study_id% AND category = 'aggregated' AND name = 'display_order' AND value_num > {display_order_deleted}"), .con = r$db)
        query <- DBI::dbSendStatement(r$db, sql)
        DBI::dbClearResult(query)
        
        # Close dialog box
        r$delete_dialog_%group_id%_%study_id% <- FALSE
        
        # Reload r variable
        plugins_load_%group_id%_%study_id%(r)
        
        # Notification to user
        show_message_bar(output = output, id = 3, translate(language, "exclusion_criterion_deleted", new_words), type ="severeWarning", language = language)
        
        # Send a message to flowchart's plugin, to reload data
        r$reload_flowchart_%study_id% <- TRUE
    },
    error = function(e) if (nchar(e[1]) > 0) report_bug(r = r, output = output, error_message = "error_run_plugin_server_code", 
      error_name = "%group_id% - run server code", category = "Error", error_report = toString(e), language = language),
    warning = function(w) if (nchar(w[1]) > 0) report_bug(r = r, output = output, error_message = "error_run_plugin_server_code", 
      error_name = "%group_id% - run server code", category = "Warning", error_report = toString(w), language = language))
})
```

## Exclusion criteria applier

### Description

- **Version** : 0.0.1
- **Libraries** : none


### UI code

```{r, eval = FALSE}

```

### Server code

```{r, eval = FALSE}

```

## Flowchart

### Description

- **Version** : 0.0.1
- **Libraries** : RDiagrammeR, clipr

### UI code

```{r, eval = FALSE}
temp <- function(){

    # Translations
    new_words <- tibble::tribble(~language, ~reference_word, ~translated_word,
        "EN", "copy_figure", "Copy figure",
        "FR", "copy_figure", "Copier la figure",
        "EN", "display_figure", "Display figure",
        "FR", "display_figure", "Afficher la figure"
    )
    
    # Get width & height

    flowchart_attr <- list()
    
    sapply(c("width", "height"), function(attr){
    
        flowchart_attr[[attr]] <- DBI::dbGetQuery(r$db, paste0("SELECT value_num FROM modules_elements_options WHERE category = 'aggregated' AND name = 'flowchart_", attr, "' 
            AND group_id = %group_id% AND study_id = %study_id% AND deleted IS FALSE"))
            
        # If no entry in database yet, create one
        if (nrow(flowchart_attr[[attr]]) == 0){
        
            last_row <- get_last_row(r$db, "modules_elements_options")
            sql <- glue::glue_sql("INSERT INTO modules_elements_options(id, group_id, study_id, category, name, value_num, creator_id, datetime, deleted)
                SELECT {last_row + 1}, %group_id%, %study_id%, 'aggregated', {paste0('flowchart_', attr)}, 300, {r$user_id}, {as.character(Sys.time())}, FALSE", .con = r$db)
            query <- DBI::dbSendStatement(r$db, sql)
            DBI::dbClearResult(query)
            
            flowchart_attr[[attr]] <<- 400
        }
        
        # If already an entry, get this entry and update sliders
        if (nrow(flowchart_attr[[attr]]) > 0){
        
            value <- as.integer(flowchart_attr[[attr]] %>% dplyr::pull(value_num))
            flowchart_attr[[attr]] <<- value
            r[[paste0("flowchart_", attr, "_%group_id%_%study_id%")]] <- value
        }  
    })

    div(
        uiOutput(ns("message_bar_1_%group_id%_%study_id%")),
        uiOutput(ns("message_bar_2_%group_id%_%study_id%")), br(),
        uiOutput(ns("flowchart_%group_id%_%study_id%")),
        div(
            span("Width", style = "font-weight:bold; margin-left: 5px;"), br(),
            shiny.fluent::Slider.shinyInput(ns("flowchart_width_%group_id%_%study_id%"), value = flowchart_attr$width, min = 10, max = 2000), br(),
            span("Height", style = "font-weight:bold; margin-left: 5px;"), br(),
            shiny.fluent::Slider.shinyInput(ns("flowchart_height_%group_id%_%study_id%"), value = flowchart_attr$height, min = 10, max = 2000), br(),
            shiny.fluent::Stack(horizontal = TRUE, tokens = list(childrenGap = 10),
                shiny.fluent::DefaultButton.shinyInput(ns("flowchart_render_%group_id%_%study_id%"), translate(language, "display_figure", new_words)),
                shiny.fluent::DefaultButton.shinyInput(ns("flowchart_copy_%group_id%_%study_id%"), translate(language, "copy_figure", new_words)),
                shiny.fluent::PrimaryButton.shinyInput(ns("flowchart_save_%group_id%_%study_id%"), translate(language, "save", r$words))
            ),
        style = "float:center;")
    )
    
}

temp()
```

### Server code

```{r, eval = FALSE}
##########################################
# Translations                           #
##########################################

new_words <- tibble::tribble(~language, ~reference_word, ~translated_word,
    "EN", "screened_patients", "Screened patients",
    "FR", "screened_patients", "Patients screenés",
    "EN", "patients_not_excluded", "Patients not excluded",
    "FR", "patients_not_excluded", "Patients non exclus",
    "EN", "clipr_required", "Library clipr required to copy a figure, please install it with install.packages('clipr')",
    "FR", "clipr_required", "Le package clipr est nécessaire pour copier une figure, merci de l'installer avec install.packages('clipr')",
    "EN", "diagrammeR_required", "Library diagrammeR required to display a flowchart, please install it with install.packages('DiagrammeR')",
    "FR", "diagrammeR_required", "Le package diagrammeR est nécessaire pour afficher le flowchart, merci de l'installer avec install.packages('DiagrammeR')",
    "EN", "no_exclusion_criteria", "No exclusion criteria available for this study",
    "FR", "no_exclusion_criteria", "Pas de critère d'exclusion disponible pour cette étude"
)

##########################################
# The flowchart is a reactive            #
##########################################
 
flowchart_%group_id%_%study_id% <- reactive({ 

    tryCatch({
    
        ##########################################
        # Get exclusion reasons                  #
        ##########################################
    
        # Existing exclusion reasons
        
        # A message sent by other plugins to reload flowchart
        # No need to send a message from Patient-level data, cause it changes d$patients_options variable, with makes this reactives reload
        if (length(r$reload_flowchart_%study_id%) > 0) r$reload_flowchart_%study_id% <- FALSE
        
        sql <- glue::glue_sql(paste0("SELECT meo1.id, meo1.value AS exclusion_reason, meo2.value_num AS display_order
            FROM modules_elements_options meo1
            LEFT JOIN modules_elements_options meo2 ON meo1.id = meo2.link_id
            WHERE meo1.deleted IS FALSE AND meo2.deleted IS FALSE AND meo1.category = 'aggregated' AND meo1.name = 'exclusion_reason_name'
            AND meo1.study_id = %study_id%"), .con = r$db)
        
        exclusion_reasons <<- DBI::dbGetQuery(r$db, sql) %>% dplyr::arrange(display_order) %>% dplyr::mutate_at("display_order", as.integer)
        
        # Excluded patients with exclusions reasons
        
        excluded_patients <- d$patients_options %>% dplyr::filter(category == "exclusion_reason" & study_id == %study_id%) %>% dplyr::select(patient_id, value_num)
        
        # Merge the two tables
        
        excluded_patients <- 
            excluded_patients %>%
            dplyr::left_join(exclusion_reasons %>% dplyr::select(value_num = id, exclusion_reason, display_order), by = "value_num") %>%
            dplyr::select(-value_num)
            
        # Get list of all patients
        subsets <- DBI::dbGetQuery(r$db, "SELECT id FROM subsets WHERE deleted IS FALSE AND study_id = %study_id%") %>% dplyr::pull()
        sql <- glue::glue_sql("SELECT patient_id FROM subset_patients WHERE deleted IS FALSE AND subset_id IN ({subsets*}) GROUP BY patient_id", .con = r$db)
        all_patients <<- DBI::dbGetQuery(r$db, sql)
        
        # Merge all_patients table with excluded_patients table
        # To have all exclusion reasons (if an exclusion reason is not used), merge with exclusion_reasons
        all_patients <<-
            all_patients %>%
            dplyr::left_join(excluded_patients, by = "patient_id") %>%
            dplyr::count(exclusion_reason)
            
        exclusion_reasons <<-
            exclusion_reasons %>%
            dplyr::left_join(all_patients, by = "exclusion_reason") %>%
            dplyr::mutate(n = ifelse(!is.na(n), n, 0L))
            
        if (nrow(exclusion_reasons) == 0) show_message_bar(output = output, id = 4, message = "no_exclusion_criteria", language = language, words = new_words)
            
        ##########################################
        # Create flowchart                       #
        ##########################################
        
        patients_count <<- sum(all_patients$n)
        
        flowchart_text <<- paste0("[1]: '", translate(language, "screened_patients", new_words), " | n = ", patients_count, "'")
        
        nodes_text <<- ""
        vertical_arrows_1 <<- ""
        vertical_arrows_2 <<- ""
        horizontal_arrows <<- ""
        
        i <- 2
        j <- 1
        
        if (nrow(exclusion_reasons) > 0){
            sapply(1:nrow(exclusion_reasons), function(k) {
            
                row <- exclusion_reasons[k, ]
                
                patients_count <<- patients_count - row$n
                
                flowchart_text <<- paste0(flowchart_text, 
                    "\n[", i, "]: '", row$exclusion_reason, " | n = ", row$n, "'",
                    "\n[", i + 1, "]: '", translate(language, "patients_not_excluded", new_words), " | n = ", patients_count, "'")
                    
                nodes_text <<- paste0(nodes_text, 
                "i", j, " [label = '@@", i - 1, "']\n",
                "e", j, " [label = '@@", i, "']\n")
                
                vertical_arrows_1 <<- paste0(vertical_arrows_1, "i", j, " -> d", j, "; ")
                vertical_arrows_2 <<- paste0(vertical_arrows_2, "d", j, " -> i", j + 1, "; ")
                horizontal_arrows <<- paste0(horizontal_arrows, "{rank = same; d", j, " -> e", j, "}\n")
                
                i <<- i + 2
                j <<- j + 1
            })
        }
        
        nodes_text <<- paste0(nodes_text,
            "i", j, " [label = '@@", i - 1, "']\n")
            
        graph <- paste0(
            "digraph flowchart {\n",
            "node [fontname = Helvetica, shape = rectangle, width = 3]\n\n",
            nodes_text, "\n",
            "node [shape = none, width = 0, height = 0, label = '']\n\n",
            "edge [dir = none]\n",
            vertical_arrows_1, "\n\n",
            "edge [len = 0.5, style = solid]\n", 
            vertical_arrows_2, "\n",
            horizontal_arrows, "\n\n",
            "}\n",
            flowchart_text)
            
        graph
    },
    error = function(e) if (nchar(e[1]) > 0) report_bug(r = r, output = output, error_message = "error_run_plugin_server_code", 
      error_name = "%group_id% - run server code", category = "Error", error_report = toString(e), language = language),
    warning = function(w) if (nchar(w[1]) > 0) report_bug(r = r, output = output, error_message = "error_run_plugin_server_code", 
      error_name = "%group_id% - run server code", category = "Warning", error_report = toString(w), language = language))
})

# Render flowchart
if (requireNamespace("DiagrammeR", quietly = TRUE)){

    if (length(r$flowchart_width_%group_id%_%study_id%) == 0) r$flowchart_width_%group_id%_%study_id% <- 400
    if (length(r$flowchart_height_%group_id%_%study_id%) == 0) r$flowchart_height_%group_id%_%study_id% <- 400
    
    output$flowchart_%group_id%_%study_id% <- renderUI(div(DiagrammeR::grVizOutput(ns("flowchart_grviz_%group_id%_%study_id%"), 
        width = r$flowchart_width_%group_id%_%study_id%, height = r$flowchart_height_%group_id%_%study_id%), style = "float:left; margin-right: 100px;"))
    output$flowchart_grviz_%group_id%_%study_id% <- DiagrammeR::renderGrViz(DiagrammeR::grViz(flowchart_%group_id%_%study_id%()))
}
if (!requireNamespace("DiagrammeR", quietly = TRUE)) output$message_bar_1_%group_id%_%study_id% <- renderUI(
    div(shiny.fluent::MessageBar(translate(language, "diagrammeR_required", new_words), messageBarType = 3), style = "margin-top:10px;"))


##########################################
# Change width or height                 #
##########################################

observeEvent(input$flowchart_render_%group_id%_%study_id%, {
    r$flowchart_width_%group_id%_%study_id% <- input$flowchart_width_%group_id%_%study_id%
    r$flowchart_height_%group_id%_%study_id% <- input$flowchart_height_%group_id%_%study_id%
})

##########################################
# Copy figure                            #
##########################################

observeEvent(input$flowchart_copy_%group_id%_%study_id%, {
    if (requireNamespace("clipr", quietly = TRUE) & requireNamespace("DiagrammeR", quietly = TRUE)){
    
        # Save figure in data/figures dir
        
        dir <-  paste0(find.package("cdwtools"), "/data/figures")
        if (!dir.exists(dir)) dir.create(dir)
        file <- paste0(dir, "/flowchart_%group_id%_%study_id%.png")

        DiagrammeR::grViz(flowchart_%group_id%_%study_id%()) %>% DiagrammeRsvg::export_svg() %>% charToRaw() %>% 
            rsvg::rsvg_png(file, height = r$flowchart_height_%group_id%_%study_id%)
    
        # Copy the code to user clipboard
        clipr::write_clip(paste0("`r knitr::include_graphics('", file, "')`"))
        
    }
    else output$message_bar_2_%group_id%_%study_id% <- renderUI(
        div(shiny.fluent::MessageBar(translate(language, "clipr_required", new_words), messageBarType = 3), style = "margin-top:10px;"))
})

##########################################
# Save settings                          #
##########################################

observeEvent(input$flowchart_save_%group_id%_%study_id%, {

    tryCatch({
    
        sapply(c("width", "height"), function(attr){
        
            sql <- glue::glue_sql("UPDATE modules_elements_options SET value_num = {input[[paste0('flowchart_', attr, '_%group_id%_%study_id%')]]}
                WHERE category = 'aggregated' AND name = {paste0('flowchart_', attr)} AND group_id = %group_id% AND study_id = %study_id% AND deleted IS FALSE", .con = r$db)
            query <- DBI::dbSendStatement(r$db, sql)
            DBI::dbClearResult(query)
        })
        
        show_message_bar(output, 1, "modif_saved", "success", language, r$words)
    },
    
    error = function(e) if (nchar(e[1]) > 0) report_bug(r = r, output = output, error_message = "error_run_plugin_server_code", 
      error_name = "%group_id% - run server code", category = "Error", error_report = toString(e), language = language),
    warning = function(w) if (nchar(w[1]) > 0) report_bug(r = r, output = output, error_message = "error_run_plugin_server_code", 
      error_name = "%group_id% - run server code", category = "Warning", error_report = toString(w), language = language))
})
```

## Report

### Description

- **Version** : 0.0.1
- **Libraries** : none

### UI code

```{r, eval = FALSE}
temp <- function(){
    
    ##########################################
    # Translations                           #
    ##########################################
    
    new_words <- tibble::tribble(~language, ~reference_word, ~translated_word,
        "EN", "abstract", "Abstract",
        "FR", "abstract", "Abstract",
        "EN", "intro", "Intro",
        "FR", "intro", "Intro",
        "EN", "methods", "Methods",
        "FR", "methods", "Matériels & méthodes",
        "EN", "results", "Results",
        "FR", "results", "Résultats",
        "EN", "discussion", "Discussion",
        "FR", "discussion", "Discussion",
        "EN", "conclusion", "Conclusion",
        "FR", "conclusion", "Conclusion",
        "EN", "preview", "Preview",
        "FR", "preview", "Aperçu",
        "EN", "format", "Format",
        "FR", "format", "Format",
        "EN", "export", "Export",
        "FR", "export", "Exporter"
    )
    
    ##########################################
    # Get current values                     #
    ##########################################
    
    pages <- c("abstract", "intro", "methods", "results", "discussion", "conclusion")
    
    report_data <- list()
    
    tryCatch({
        sapply(pages, function(page){
        
            sql <- glue::glue_sql("SELECT id, value, creator_id, datetime FROM modules_elements_options WHERE deleted IS FALSE
                AND group_id = %group_id% AND study_id = %study_id% AND category = 'aggregated' AND name = {paste0('report_', page)}", .con = r$db)
            report_data[[page]] <<- DBI::dbGetQuery(r$db, sql)
            
            # If there's noy any value yet
            if (nrow(report_data[[page]]) == 0){
            
                sql <- glue::glue_sql("INSERT INTO modules_elements_options(id, group_id, study_id, category, name, value, creator_id, datetime, deleted)
                    SELECT {get_last_row(r$db, 'modules_elements_options') + 1}, %group_id%, %study_id%, 'aggregated', {paste0('report_', page)}, '', {r$user_id}, 
                    {as.character(Sys.time())}, FALSE", .con = r$db)
                    
                query <- DBI::dbSendStatement(r$db, sql)
                DBI::dbClearResult(query)
            }
        })
    },
    error = function(e) if (nchar(e[1]) > 0) report_bug(r = r, output = output, error_message = "error_run_plugin_ui_code", 
        error_name = "%group_id% - run ui code", category = "Error", error_report = toString(e), language = language),
    warning = function(w) if (nchar(w[1]) > 0) report_bug(r = r, output = output, error_message = "error_run_plugin_ui_code", 
        error_name = "%group_id% - run ui code", category = "Warning", error_report = toString(w), language = language))
    
    ##########################################
    # Render UI                              #
    ##########################################
    
    pages <- c("abstract", "intro", "methods", "results", "discussion", "conclusion")
    
    ace_editor <- function(page){
        conditionalPanel(condition = paste0("input.report_page_%group_id%_%study_id% == '", page, "'"), ns = ns,
            div(shinyAce::aceEditor(ns(paste0("ace_editor_", page, "_%group_id%_%study_id%")), value = report_data[[page]]$value,
                mode = "markdown", autoScrollEditorIntoView = TRUE, minLines = 30, maxLines = 2000), style = "width: 100%;"))
    }
    
    ace_editors <- tagList()
    options <- list()
    
    sapply(pages, function(page){
        ace_editors <<- tagList(ace_editors, ace_editor(page))
        options <<- rlist::list.append(options, list(key = page, text = translate(language, page, new_words)))    
    })
    
    tagList(
        shiny.fluent::ChoiceGroup.shinyInput(ns("report_page_%group_id%_%study_id%"), value = "abstract", options = options, className = "inline_choicegroup"),
        ace_editors,
        shiny.fluent::Stack(horizontal = TRUE, tokens = list(childrenGap = 3),
            shiny.fluent::PrimaryButton.shinyInput(ns("report_save_%group_id%_%study_id%"), translate(language, "save", r$words)),
            shiny.fluent::DefaultButton.shinyInput(ns("report_preview_%group_id%_%study_id%"), translate(language, "preview", new_words)),
            div(shiny.fluent::Dropdown.shinyInput(ns("report_export_format_%group_id%_%study_id%"), translate(language, "format", new_words),
                options = list(list(key = "pdf", text = "PDF"), list(key = "html", text = "HTML")), value = "pdf"), style = "width:80px"),
            shiny.fluent::DefaultButton.shinyInput(ns("report_export_button_%group_id%_%study_id%"), translate(language, "export", new_words))),
        br(),
        div(downloadButton(ns("report_export_%group_id%_%study_id%")), style = "display:none;"),
        div(uiOutput(ns("report_preview_ui_%group_id%_%study_id%")), style = "border:dashed 1px; min-height:40px; padding-left:10px; padding-right:10px;")
    )
}

temp()
```

### Server code

```{r, eval = FALSE}
# Careful : hidden dependency : "webshot" and phantomJS with install.packages("phantomJS")

##########################################
# Translations                           #
##########################################

new_words <- tibble::tribble(~language, ~reference_word, ~translated_word,
    "EN", "report", "report",
    "FR", "report", "article"
)

##########################################
# Save editors                           #
##########################################

observeEvent(input$report_save_%group_id%_%study_id%, {

    pages <- c("abstract", "intro", "methods", "results", "discussion", "conclusion")

    tryCatch({
        sapply(pages, function(page){
        
            sql <- glue::glue_sql("UPDATE modules_elements_options SET value = {input[[paste0('ace_editor_', page, '_%group_id%_%study_id%')]]}, creator_id = {r$user_id}, datetime = {as.character(Sys.time())}
                WHERE deleted IS FALSE AND group_id = %group_id% AND study_id = %study_id% AND category = 'aggregated' AND name = {paste0('report_', page)}" ,.con = r$db)
                
            query <- DBI::dbSendStatement(r$db, sql)
            DBI::dbClearResult(query)
        })
        
        show_message_bar(output, 1, translate(language, "modif_saved", r$words), "success", language)
    },
    error = function(e) if (nchar(e[1]) > 0) report_bug(r = r, output = output, error_message = "error_run_plugin_server_code", 
        error_name = "%group_id% - run server code", category = "Error", error_report = toString(e), language = language),
    warning = function(w) if (nchar(w[1]) > 0) report_bug(r = r, output = output, error_message = "error_run_plugin_server_code", 
        error_name = "%group_id% - run server code", category = "Warning", error_report = toString(w), language = language))

})

##########################################
# Preview                                #
##########################################

observeEvent(input$report_preview_%group_id%_%study_id%, {
    
    output$report_preview_ui_%group_id%_%study_id% <- renderUI({
    
        tryCatch({
            # Clear temp dir
            unlink(paste0(find.package("cdwtools"), "/data/temp"), recursive = TRUE, force = TRUE)
        
            markdown_file <- isolate(input[[paste0("ace_editor_", input$report_page_%group_id%_%study_id%, "_%group_id%_%study_id%")]]) %>%
                stringr::str_replace_all("\r", "")
            
            # Create temp dir
            dir <- paste0(find.package("cdwtools"), "/data/temp")
            file <- paste0(dir, "/", as.character(Sys.time()) %>% stringr::str_replace_all(":", "_"), ".Md")
            if (!dir.exists(dir)) dir.create(dir)
            
            # Create the markdown file
            knitr::knit(text = markdown_file, output = file, quiet = TRUE)
            
            withMathJax(includeMarkdown(file))
        },
        error = function(e) if (nchar(e[1]) > 0) report_bug(r = r, output = output, error_message = "error_run_plugin_server_code", 
            error_name = "%group_id% - run server code", category = "Error", error_report = toString(e), language = language),
        warning = function(w) if (nchar(w[1]) > 0) report_bug(r = r, output = output, error_message = "error_run_plugin_server_code", 
            error_name = "%group_id% - run server code", category = "Warning", error_report = toString(w), language = language))
    })
})

##########################################
# Export                                 #
##########################################

observeEvent(input$report_export_button_%group_id%_%study_id%, {

    tryCatch({
        pages <- c("abstract", "intro", "methods", "results", "discussion", "conclusion")
            
        report_pages <- ""
        sapply(pages, function(page){
            report_pages <<- paste0(report_pages, paste0(input[[paste0("ace_editor_", page, "_%group_id%_%study_id%")]], "\n\n"))
        })
        
        report <- paste0(
            "---\n",
            "title: 'Test'\n",
            "output: ", input$report_export_format_%group_id%_%study_id%, "_document\n" ,
            "---\n\n",
            report_pages
        )
        
        params <- list()
        
        study_name <- r$studies %>% dplyr::filter(id == input$study) %>% dplyr::pull(name)
          
        filename <- paste0(find.package("cdwtools"), "/data/temp/", as.character(Sys.Date()), " - " , study_name, " - ", translate(language, "report", new_words))
        
        writeLines(report, paste0(filename, ".Rmd"))
        
        rmarkdown::render(
            input = paste0(filename, ".Rmd"),
            output_format = paste0(input$report_export_format_%group_id%_%study_id%, "_document"),
            output_file = paste0(filename, ".", input$report_export_format_%group_id%_%study_id%), envir = new.env(parent = globalenv()))
    },
    error = function(e) if (nchar(e[1]) > 0) report_bug(r = r, output = output, error_message = "error_run_plugin_server_code", 
        error_name = "%group_id% - run server code", category = "Error", error_report = toString(e), language = language),
    warning = function(w) if (nchar(w[1]) > 0) report_bug(r = r, output = output, error_message = "error_run_plugin_server_code", 
        error_name = "%group_id% - run server code", category = "Warning", error_report = toString(w), language = language))

    #output$report_export_%group_id%_%study_id% <- renderUI(shiny.fluent::Link("test",
    #    href = paste0(filename, ".", input$report_export_format_%group_id%_%study_id%)))

    shinyjs::click("report_export_%group_id%_%study_id%")
    
})

output$report_export_%group_id%_%study_id% <- downloadHandler(
    filename = function() {
        paste("data-", Sys.Date(), ".csv", sep="")
    },
    content = function(file) {
        write.csv(tibble::tribble(~id, 1, 2), file)
    }
)


```

## Bibliography

### Description

- **Version** : 0.0.1
- **Libraries** : none

### UI code

```{r, eval = FALSE}
temp <- function(){

    # Translations
    new_words <- tibble::tribble(~language, ~reference_word, ~translated_word,
        "EN", "open_bib", "Open a bibliography",
        "FR", "open_bib", "Ouvrir une bibliographie",
        "EN", "manage_bib", "Manage bibliographies",
        "FR"," manage_bib", "Gérer les bibliographies",
        "EN", "bibliography", "Bibliography",
        "FR", "bibliography", "Bibliographie",
        "EN", "new_bib", "New bibliography",
        "FR", "new_bib", "Nouvelle bibliographie",
        "EN", "browse_bib", "Choose BibTeX file",
        "FR", "browse_bib", "Choisir un fichier BibTeX",
        "EN", "upload_bib", "Upload BibTeX file",
        "FR", "upload_bib", "Charger un fichier BibTeX",
        "EN", "import_bib_file", "Import a bibliography file",
        "FR", "import_bib_file", "Importer un fichier de bibliographie",
        "EN", "delete_bib", "Delete a bibliography",
        "FR", "delete_bib", "Supprimer une bibliographie",
        "EN", "file", "File",
        "FR", "file", "Fichier"
    )
    
    action_choice_options <- list(
        list(key = "open_bib", text = translate(language, "open_bib", new_words)),
        list(key = "manage_bib", text = translate(language, "manage_bib", new_words)))
        
    bib_options <- convert_tibble_to_list(DBI::dbGetQuery(r$db, "SELECT * FROM modules_elements_options WHERE DELETED IS FALSE AND group_id = %group_id% AND study_id = %study_id% AND name = 'bib_name'"), key_col = "id", text_col = "value")
    
    div(
        shiny.fluent::ChoiceGroup.shinyInput(ns("action_choice_%group_id%_%study_id%"), value = "open_bib", options = action_choice_options, className = "inline_choicegroup"),
        
        conditionalPanel(condition = "input.action_choice_%group_id%_%study_id% == 'open_bib'", ns = ns,
            make_dropdown(label = "bibliography", id = "bib_select_%group_id%_%study_id%", words = new_words, ns = ns, options = bib_options, width = "300px"),
            DT::DTOutput(ns("bib_datatable_%group_id%_%study_id%"))
        ),
        
        conditionalPanel(condition = "input.action_choice_%group_id%_%study_id% == 'manage_bib'", ns = ns,
            br(), shiny.fluent::Text(variant = "large", translate(language, "new_bib", new_words), block = TRUE),
            shiny.fluent::Stack(horizontal = TRUE, tokens = list(childrenGap = 20),
                make_textfield(label = "name", id = "new_bib_name_%group_id%_%study_id%", ns = ns, width = "300px"),
                div(shiny.fluent::PrimaryButton.shinyInput(ns("new_bib_add_%group_id%_%study_id%"), translate(language, "add", r$words)), style = "padding-top:38px;")
            ),
            br(), hr(), shiny.fluent::Text(variant = "large", translate(language, "import_bib_file", new_words), block = TRUE),
            div(style = "display:none;", fileInput(ns("import_bib_file_%group_id%_%study_id%"), label = "", multiple = FALSE, accept = ".bib")),
            shiny.fluent::Stack(horizontal = TRUE, tokens = list(childrenGap = 20),
                make_dropdown(label = "bibliography", id = "import_bib_name_%group_id%_%study_id%", ns = ns, options = bib_options, width = "300px", words = new_words),
                div(shiny.fluent::DefaultButton.shinyInput(ns("import_bib_browse_%group_id%_%study_id%"), translate(language, "browse_bib", new_words), iconProps = list(iconName = "Upload")), style = "padding-top:38px;"),
                div(uiOutput(ns("import_bib_status_%group_id%_%study_id%")), style = "padding-top:38px;")
            ), br(),
            shiny.fluent::PrimaryButton.shinyInput(ns("import_bib_validate_%group_id%_%study_id%"), translate(language, "upload_bib", new_words)), br(),
            br(), hr(), shiny.fluent::Text(variant = "large", translate(language, "delete_bib", new_words), block = TRUE),
            shiny.fluent::Stack(horizontal = TRUE, tokens = list(childrenGap = 20),
                make_dropdown(label = "bibliography", id = "delete_bib_%group_id%_%study_id%", ns = ns, options = bib_options, width = "300px", words = new_words),
                div(shiny.fluent::DefaultButton.shinyInput(ns("delete_bib_validate_%group_id%_%study_id%"), translate(language, "delete", r$words)), style = "padding-top:38px;")
            )
        ),
        
        textOutput(ns("test"))
    )
}

temp()
```

### Server code

```{r, eval = FALSE}
##########################################
# Translations                           #
##########################################

new_words <- tibble::tribble(~language, ~reference_word, ~translated_word,
    "EN", "new_bib_added", "New bibliography added",
    "FR", "new_bib_added", "Nouvelle bibliographie ajoutée",
    "EN", "delete_bib", "Delete a bibliography",
    "FR", "delete_bib", "Supprimer une bibliographie",
    "EN", "delete_bib_subtext", "Are you sure you want to delete this bibliography ?",
    "FR", "delete_bib_subtext", "Etes-vous sûr de vouloir supprimer cette bibliographie ?",
    "EN", "bib_deleted", "Bibliography deleted",
    "FR", "bib_deleted", "Bibliographie supprimée",
    "EN", "bib_imported", "Bibliography imported",
    "FR", "bib_imported", "Bibliographie importée",
    "EN", "bib_import_choose_bib", "Choose a bibliography to import BibTeX file",
    "FR", "bib_import_choose_bib", "Choisir une bibliographie pour importer le fichier BibTeX",
    "EN", "title", "Title",
    "FR", "title", "Titre",
    "EN", "authors", "Authors",
    "FR", "authors", "Auteurs",
    "EN", "journal", "Journal",
    "FR", "journal", "Revue",
    "EN", "doi", "DOI",
    "FR", "doi", "DOI"
)

##########################################
# Display a BibTeX file  with DT         #
##########################################

if (requireNamespace("bib2df", quietly = TRUE) & requireNamespace("clipr", quietly = TRUE)){

    observeEvent(input$bib_select_%group_id%_%study_id%, {
    
        tryCatch({
        
            # Get page_id for delete button
            page_id <- id
    
            # Use same dir as datamarts
            
            if (length(r$datamarts_folder) > 0) folder <- paste0(r$datamarts_folder, "/bib/")
            else folder <- paste0(path.expand('~'), "/data/bib/")
            path <- paste0(folder, "bib_%group_id%_%study_id%_", input$import_bib_name_%group_id%_%study_id%, ".bib")
            
            # If file exists, transform bib file to dataframe & render as a datatable
            
            if (file.exists(path)){
            
                # Select & rename cols
                # Make a copy button in action column
                
                bib <- bib2df::bib2df(path) %>% 
                    dplyr::select(title = TITLE, authors = AUTHOR, journal = JOURNAL, doi = DOI, key = BIBTEXKEY) %>%
                    dplyr::mutate(id = 1:dplyr::n()) %>%
                    dplyr::mutate(authors = sapply(authors, toString)) %>% 
                    dplyr::mutate(title = stringr::str_replace_all(title, c("\\{" = "", "\\}" = "")))
                        
                r$bib_%group_id%_%study_id% <- bib
                
                bib <- bib %>% dplyr::rowwise() %>%
                    dplyr::mutate(key = as.character(
                        div(
                            shiny::actionButton(ns(paste0("bib_copy_%group_id%_%study_id%_", id)), "", icon = icon("copy"),
                            onclick = paste0("Shiny.setInputValue('", page_id, "-bib_copy_%group_id%_%study_id%', ", id, ", {priority: 'event'})"))
                        )
                    ))
                
                col_names <- c(translate(language, "title", new_words), translate(language, "authors", new_words), translate(language, "journal", new_words), 
                    translate(language, "doi", new_words), translate(language, "action", r$words))
                
                sortable_cols <- c("title", "journal")
                centered_cols <- c("doi", "key")
                column_widths = c("action" = "80")
                searchable_cols <- c("title", "authors", "journal")
                factorize_cols <- c("journal")
                
                render_datatable(
                    data = bib %>% dplyr::select(-id),
                    output = output,
                    r = r,
                    ns = ns,
                    language = language,
                    output_name = "bib_datatable_%group_id%_%study_id%",
                    col_names = col_names,
                    page_length = 10,
                    sortable_cols = sortable_cols,
                    centered_cols = centered_cols,
                    column_widths = column_widths,
                    filter = TRUE,
                    searchable_cols = searchable_cols,
                    factorize_cols = factorize_cols
                )
            }
        },
        error = function(e) if (nchar(e[1]) > 0) report_bug(r = r, output = output, error_message = "error_run_plugin_server_code", error_name = "%group_id% - run server code", category = "Error", error_report = toString(e), language = language))
    })
    
    observeEvent(input$bib_copy_%group_id%_%study_id%,{
        clipr::write_clip(paste0("[@", r$bib_%group_id%_%study_id% %>% dplyr::filter(id == input$bib_copy_%group_id%_%study_id%) %>% dplyr::pull(key), "]"))
    })
    
    output$test <- renderText(input$bib_copy_%group_id%_%study_id%)
}

if (!requireNamespace("bib2df", quietly = TRUE) | !requireNamespace("clipr", quietly = TRUE)){
    
}

##########################################
# Add a new bibliography                 #
##########################################

observeEvent(input$new_bib_add_%group_id%_%study_id%, {

    tryCatch({
    
        new_name <- input$new_bib_name_%group_id%_%study_id%
        
        if (length(new_name) == 0) shiny.fluent::updateTextField.shinyInput(session, "new_bib_name_%group_id%_%study_id%", errorMessage = translate(language, paste0("provide_valid_name"), r$words))
        else shiny.fluent::updateTextField.shinyInput(session, "new_bib_name_%group_id%_%study_id%", errorMessage = NULL)
        
        req(length(new_name) > 0)
        
        sql <- "SELECT DISTINCT(value) FROM modules_elements_options WHERE deleted IS FALSE AND group_id = %group_id% AND study_id = %study_id% AND name = 'bib_name'" 
        distinct_values <- DBI::dbGetQuery(r$db, sql) %>% dplyr::pull() %>% tolower()
          
        if (tolower(new_name) %in% distinct_values) show_message_bar(output, 2, "name_already_used", "severeWarning", language)
        req(tolower(new_name) %not_in% distinct_values)
        
        last_row <- get_last_row(r$db, "modules_elements_options")
        
        # Insert new bib in database
        # One row for name, one row for bib file path
        
        sql <- glue::glue_sql("INSERT INTO modules_elements_options(id, group_id, study_id, link_id, category, name, value, creator_id, datetime, deleted)
            SELECT {last_row + 1}, %group_id%, %study_id%, {NA_integer_}, 'aggregated', 'bib_name', {new_name}, {r$user_id}, {as.character(Sys.time())}, FALSE
      UNION SELECT {last_row + 2}, %group_id%, %study_id%, {last_row + 1}, 'aggregated', 'bib_file_path', '', {r$user_id}, {as.character(Sys.time())}, FALSE", .con = r$db)
        query <- DBI::dbSendStatement(r$db, sql)
        DBI::dbClearResult(query)
        
        # Reset textfield
        shiny.fluent::updateTextField.shinyInput(session, "new_bib_name_%group_id%_%study_id%", value = NULL)
        
        # Update dropdowns
        r$reload_%group_id%_%study_id% <- Sys.time()
        
        show_message_bar(output, 1, translate(language, "new_bib_added", new_words), "success", language)
    
    },
    error = function(e) if (nchar(e[1]) > 0) report_bug(r = r, output = output, error_message = "error_run_plugin_server_code", error_name = "%group_id% - run server code", category = "Error", error_report = toString(e), language = language))
})

##########################################
# Import a BibTeX file                   #
##########################################

observeEvent(input$import_bib_browse_%group_id%_%study_id%, shinyjs::click("import_bib_file_%group_id%_%study_id%"))

output$import_bib_status_%group_id%_%study_id% <- renderUI(tagList(div(
    span(translate(language, "loaded_file", r$words), " : ", style = "padding-top:5px;"), 
    span(input$import_bib_file_%group_id%_%study_id%$name, style = "font-weight:bold; color:#0078D4;"), style = "padding-top:10px;")))

observeEvent(input$import_bib_validate_%group_id%_%study_id%, {

    tryCatch({
    
        if (length(input$import_bib_name_%group_id%_%study_id%) == 0) show_message_bar(output, 3, "bib_import_choose_bib", "severeWarning", language, words = new_words)
    
        req(input$import_bib_file_%group_id%_%study_id%, input$import_bib_name_%group_id%_%study_id%)
            
        # Use same dir as datamarts
        
        if (length(r$datamarts_folder) > 0) folder <- paste0(r$datamarts_folder, "/bib/")
        else folder <- paste0(path.expand('~'), "/data/bib/")
        dir.create(folder, showWarnings = FALSE)
        path <- paste0(folder, "bib_%group_id%_%study_id%_", input$import_bib_name_%group_id%_%study_id%, ".bib")
        
        file.copy(input$import_bib_file_%group_id%_%study_id%$datapath, path)
        
        show_message_bar(output, 3, "bib_imported", "success", language, words = new_words)
        
    },
    error = function(e) if (nchar(e[1]) > 0) report_bug(r = r, output = output, error_message = "error_run_plugin_server_code", error_name = "%group_id% - run server code", category = "Error", error_report = toString(e), language = language))

})

##########################################
# Delete a bibliography                  #
##########################################

# Delete button is pressed
observeEvent(input$delete_bib_validate_%group_id%_%study_id%, r$delete_dialog_%group_id%_%study_id% <- TRUE)

# Rendering react output
observeEvent(r$delete_dialog_%group_id%_%study_id% , {
    output$delete_confirm <- shiny.fluent::renderReact({
        dialogContentProps <- list(
            type = 0,
            title = translate(language, "delete_bib", new_words),
            closeButtonAriaLabel = "Close",
            subText = translate(language, "delete_bib_subtext", new_words)
        )
        shiny.fluent::Dialog(
            hidden = !r$delete_dialog_%group_id%_%study_id%,
            onDismiss = htmlwidgets::JS(paste0("function() { Shiny.setInputValue('hide_dialog_%group_id%_%study_id%', Math.random()); }")),
            dialogContentProps = dialogContentProps,
            modalProps = list(),
            shiny.fluent::DialogFooter(
                shiny.fluent::PrimaryButton.shinyInput(ns("delete_confirmed_%group_id%_%study_id%"), text = translate(language, "delete", r$words)),
                shiny.fluent::DefaultButton.shinyInput(ns("delete_canceled_%group_id%_%study_id%"), text = translate(language, "dont_delete", r$words))
            )
        )
    })
})

# Whether to close or not delete dialog box
observeEvent(input$hide_dialog_%group_id%_%study_id%, r$delete_dialog_%group_id%_%study_id% <- FALSE)
observeEvent(input$delete_canceled_%group_id%_%study_id%, r$delete_dialog_%group_id%_%study_id% <- FALSE)

# When the delete is confirmed
observeEvent(input$delete_confirmed_%group_id%_%study_id%, {

    tryCatch({
        
        # Get value of deleted row
        row_deleted <- as.integer(input$delete_bib_%group_id%_%study_id%)
        
        # Delete row in database
        sql <- glue::glue_sql("UPDATE modules_elements_options SET deleted = TRUE WHERE id = {row_deleted} OR link_id = {row_deleted}", .con = r$db)
        query <- DBI::dbSendStatement(r$db, sql)
        DBI::dbClearResult(query)
        
        # Close dialog box
        r$delete_dialog_%group_id%_%study_id% <- FALSE
        
        # Notification to user
        show_message_bar(output = output, id = 3, translate(language, "bib_deleted", new_words), type = "severeWarning", language = language)
        
        r$reload_%group_id%_%study_id% <- Sys.time()

    },
    error = function(e) if (nchar(e[1]) > 0) report_bug(r = r, output = output, error_message = "error_run_plugin_server_code", error_name = "%group_id% - run server code", category = "Error", error_report = toString(e), language = language))
})

##########################################
# Reload data                            #
##########################################

observeEvent(r$reload_%group_id%_%study_id%, {

    # Update dropdowns
    
    options <- convert_tibble_to_list(DBI::dbGetQuery(r$db, "SELECT * FROM modules_elements_options WHERE deleted IS FALSE AND group_id = %group_id% AND study_id = %study_id% AND name = 'bib_name'"), key_col = "id", text_col = "value")
    shiny.fluent::updateDropdown.shinyInput(session, "bib_select_%group_id%_%study_id%", options = options)
    shiny.fluent::updateDropdown.shinyInput(session, "import_bib_name_%group_id%_%study_id%", options = options)
    shiny.fluent::updateDropdown.shinyInput(session, "delete_bib_%group_id%_%study_id%", options = options)
})
```

## R code

### Description

- **Version** : 0.0.1
- **Libraries** : none

### UI code

```{r, eval = FALSE}
temp <- function(){
    
     # Translations
    new_words <- tibble::tribble(~language, ~reference_word, ~translated_word,
        "EN", "edit_script", "Edit a script",
        "FR", "edit_script", "Modifier un script",
        "EN", "manage_scripts", "Manage scripts",
        "FR", "manage_scripts", "Gérer les scripts",
        "EN", "r_script", "Script",
        "FR", "r_script", "Script",
        "EN", "new_script", "New script",
        "FR", "new_script", "Nouveau script",
        "EN", "delete_script", "Delete a script",
        "FR", "delete_script", "Supprimer un script"
    )
    
    action_choice_options <- list(
        list(key = "edit_code", text = translate(language, "edit_script", new_words)),
        list(key = "manage_code", text = translate(language, "manage_scripts", new_words)))
    
    scripts_options <- convert_tibble_to_list(DBI::dbGetQuery(r$db, "SELECT * FROM modules_elements_options WHERE DELETED IS FALSE AND group_id = %group_id% AND study_id = %study_id% AND name = 'r_script_name'"), key_col = "id", text_col = "value")
    
    div(
        shiny.fluent::ChoiceGroup.shinyInput(ns("action_choice_%group_id%_%study_id%"), value = "edit_code", options = action_choice_options, className = "inline_choicegroup"),
        
        conditionalPanel(condition = "input.action_choice_%group_id%_%study_id% == 'edit_code'", ns = ns,
            make_dropdown(label = "r_script", id = "Rcode_select_%group_id%_%study_id%", words = new_words, ns = ns, options = scripts_options, width = "300px"),
            div(shinyAce::aceEditor(ns("Rcode_%group_id%_%study_id%"), "", mode = "r", autoScrollEditorIntoView = TRUE, minLines = 30, maxLines = 1000), style = "width: 100%;"),
            shiny.fluent::PrimaryButton.shinyInput(ns("Rcode_save_%group_id%_%study_id%"), translate(language, "save", r$words)), " ",
            shiny.fluent::DefaultButton.shinyInput(ns("Rcode_execute_%group_id%_%study_id%"), translate(language, "execute_code", r$words)), br(), br(),
            div(verbatimTextOutput(ns("Rcode_result")), style = "width: 99%; border-style: dashed; border-width: 1px; padding: 0px 8px 0px 8px; margin-right: 5px;")
        ),
        
        conditionalPanel(condition = "input.action_choice_%group_id%_%study_id% == 'manage_code'", ns = ns,
            br(), shiny.fluent::Text(variant = "large", translate(language, "new_script", new_words), block = TRUE),
            shiny.fluent::Stack(horizontal = TRUE, tokens = list(childrenGap = 20),
                make_textfield(label = "name", id = "new_script_name_%group_id%_%study_id%", ns = ns, width = "300px"),
                div(shiny.fluent::PrimaryButton.shinyInput(ns("new_script_add_%group_id%_%study_id%"), translate(language, "add", r$words)), style = "padding-top:38px;")
            ),
            br(), hr(), shiny.fluent::Text(variant = "large", translate(language, "delete_script", new_words), block = TRUE),
            shiny.fluent::Stack(horizontal = TRUE, tokens = list(childrenGap = 20),
                make_dropdown(label = "r_script", id = "delete_script_%group_id%_%study_id%", ns = ns, options = scripts_options, width = "300px", words = new_words),
                div(shiny.fluent::DefaultButton.shinyInput(ns("delete_script_validate_%group_id%_%study_id%"), translate(language, "delete", r$words)), style = "padding-top:38px;")
            )
        )
    )
}

temp()
```

### Server code

```{r, eval = FALSE}
##########################################
# Translations                           #
##########################################

new_words <- tibble::tribble(~language, ~reference_word, ~translated_word,
    "EN", "new_script_added", "New script added",
    "FR", "new_script_added", "Nouveau script ajouté",
    "EN", "delete_script", "Delete a script",
    "FR", "delete_script", "Supprimer un script",
    "EN", "delete_script_subtext", "Are you sure you want to delete this script ?",
    "FR", "delete_script_subtext", "Etes-vous sûr de vouloir supprimer ce script ?",
    "EN", "script_deleted", "Script deleted",
    "FR", "script_deleted", "Script supprimé"
)

##########################################
# Add a new script                       #
##########################################

observeEvent(input$new_script_add_%group_id%_%study_id%, {

    tryCatch({
    
        new_name <- input$new_script_name_%group_id%_%study_id%
        
        if (length(new_name) == 0) shiny.fluent::updateTextField.shinyInput(session, "new_script_name_%group_id%_%study_id%", errorMessage = translate(language, paste0("provide_valid_name"), r$words))
        else shiny.fluent::updateTextField.shinyInput(session, "new_script_name_%group_id%_%study_id%", errorMessage = NULL)
        
        req(length(new_name) > 0)
        
        sql <- "SELECT DISTINCT(value) FROM modules_elements_options WHERE deleted IS FALSE AND group_id = %group_id% AND study_id = %study_id% AND name = 'r_script_name'" 
        distinct_values <- DBI::dbGetQuery(r$db, sql) %>% dplyr::pull() %>% tolower()
          
        if (tolower(new_name) %in% distinct_values) show_message_bar(output, 2, "name_already_used", "severeWarning", language)
        req(tolower(new_name) %not_in% distinct_values)
        
        last_row <- get_last_row(r$db, "modules_elements_options")
        
        # Insert new script in database
        # One row for name, one row for code
        
        sql <- glue::glue_sql("INSERT INTO modules_elements_options(id, group_id, study_id, link_id, category, name, value, creator_id, datetime, deleted)
            SELECT {last_row + 1}, %group_id%, %study_id%, {NA_integer_}, 'aggregated', 'r_script_name', {new_name}, {r$user_id}, {as.character(Sys.time())}, FALSE
      UNION SELECT {last_row + 2}, %group_id%, %study_id%, {last_row + 1}, 'aggregated', 'r_script_code', '', {r$user_id}, { as.character(Sys.time())}, FALSE", .con = r$db)
        query <- DBI::dbSendStatement(r$db, sql)
        DBI::dbClearResult(query)
        
        # Reset textfield
        shiny.fluent::updateTextField.shinyInput(session, "new_script_name_%group_id%_%study_id%", value = NULL)
        
        # Update dropdowns
        r$reload_%group_id%_%study_id% <- Sys.time()
        
        show_message_bar(output, 1, translate(language, "new_script_added", new_words), "success", language)
    
    },
    error = function(e) if (nchar(e[1]) > 0) report_bug(r = r, output = output, error_message = "error_run_plugin_server_code", error_name = "%group_id% - run server code", category = "Error", error_report = toString(e), language = language))
})

##########################################
# Edit a script                          #
##########################################


    ##########################################
    # Load script code                       #
    ##########################################
    
    observeEvent(input$Rcode_select_%group_id%_%study_id%, {
    
        tryCatch({
            sql <- glue::glue_sql("SELECT value FROM modules_elements_options WHERE deleted IS FALSE AND group_id = %group_id% AND study_id = %study_id% AND name = 'r_script_code' AND link_id = {as.integer(input$Rcode_select_%group_id%_%study_id%)}", .con = r$db)
            code <- DBI::dbGetQuery(r$db, sql) %>% dplyr::pull(value)
            
            shinyAce::updateAceEditor(session, "Rcode_%group_id%_%study_id%", value = code)
        },
        error = function(e) if (nchar(e[1]) > 0) report_bug(r = r, output = output, error_message = "error_run_plugin_server_code", error_name = "%group_id% - run server code", category = "Error", error_report = toString(e), language = language))
    })
    
    ##########################################
    # Save updates                           #
    ##########################################
    
    observeEvent(input$Rcode_save_%group_id%_%study_id%, {
    
        tryCatch({
            req(!is.na(input$Rcode_select_%group_id%_%study_id%))
        
            code <- input$Rcode_%group_id%_%study_id% %>% stringr::str_replace_all("\r", "\n")
            
            sql <- glue::glue_sql("UPDATE modules_elements_options SET value = {code} WHERE name = 'r_script_code' AND link_id = {as.integer(input$Rcode_select_%group_id%_%study_id%)}", .con = r$db)
            query <- DBI::dbSendStatement(r$db, sql)
            DBI::dbClearResult(query)
            
            show_message_bar(output = output, id = 3, message = "modif_saved", type = "success", language = language)
            
        },
        error = function(e) if (nchar(e[1]) > 0) report_bug(r = r, output = output, error_message = "error_run_plugin_server_code", error_name = "%group_id% - run server code", category = "Error", error_report = toString(e), language = language))
    })
    
    ##########################################
    # Execute script code                    #
    ##########################################
    
    observeEvent(input$Rcode_execute_%group_id%_%study_id%, {
        
        tryCatch({
        
            # Change this option to display correctly tibble in textbox
            options('cli.num_colors' = 1)
            
            # Capture console output of our code
            captured_output <- capture.output(
              tryCatch(eval(parse(text = as.character(input$Rcode_%group_id%_%study_id%) %>% stringr::str_replace_all("\r", "\n"))), error = function(e) print(e), warning = function(w) print(w)))
            
            # Display result
            output$Rcode_result <- renderText(paste(captured_output, collapse = "\n"))
            
            # Restore normal value
            options('cli.num_colors' = NULL)
        
        },
        error = function(e) if (nchar(e[1]) > 0) report_bug(r = r, output = output, error_message = "error_run_plugin_server_code", error_name = "%group_id% - run server code", category = "Error", error_report = toString(e), language = language))
    })

##########################################
# Delete a script                        #
##########################################

# Delete button is pressed
observeEvent(input$delete_script_validate_%group_id%_%study_id%, r$delete_dialog_%group_id%_%study_id% <- TRUE)

# Rendering react output
observeEvent(r$delete_dialog_%group_id%_%study_id% , {
    output$delete_confirm <- shiny.fluent::renderReact({
        dialogContentProps <- list(
            type = 0,
            title = translate(language, "delete_script", new_words),
            closeButtonAriaLabel = "Close",
            subText = translate(language, "delete_script_subtext", new_words)
        )
        shiny.fluent::Dialog(
            hidden = !r$delete_dialog_%group_id%_%study_id%,
            onDismiss = htmlwidgets::JS(paste0("function() { Shiny.setInputValue('hide_dialog_%group_id%_%study_id%', Math.random()); }")),
            dialogContentProps = dialogContentProps,
            modalProps = list(),
            shiny.fluent::DialogFooter(
                shiny.fluent::PrimaryButton.shinyInput(ns("delete_confirmed_%group_id%_%study_id%"), text = translate(language, "delete", r$words)),
                shiny.fluent::DefaultButton.shinyInput(ns("delete_canceled_%group_id%_%study_id%"), text = translate(language, "dont_delete", r$words))
            )
        )
    })
})

# Whether to close or not delete dialog box
observeEvent(input$hide_dialog_%group_id%_%study_id%, r$delete_dialog_%group_id%_%study_id% <- FALSE)
observeEvent(input$delete_canceled_%group_id%_%study_id%, r$delete_dialog_%group_id%_%study_id% <- FALSE)

# When the delete is confirmed
observeEvent(input$delete_confirmed_%group_id%_%study_id%, {

    tryCatch({
        
        # Get value of deleted row
        row_deleted <- as.integer(input$delete_script_%group_id%_%study_id%)
        
        # Delete row in database
        sql <- glue::glue_sql("UPDATE modules_elements_options SET deleted = TRUE WHERE id = {row_deleted} OR link_id = {row_deleted}", .con = r$db)
        query <- DBI::dbSendStatement(r$db, sql)
        DBI::dbClearResult(query)
        
        # Close dialog box
        r$delete_dialog_%group_id%_%study_id% <- FALSE
        
        # Notification to user
        show_message_bar(output = output, id = 3, translate(language, "script_deleted", new_words), type = "severeWarning", language = language)
        
        r$reload_%group_id%_%study_id% <- Sys.time()

    },
    error = function(e) if (nchar(e[1]) > 0) report_bug(r = r, output = output, error_message = "error_run_plugin_server_code", error_name = "%group_id% - run server code", category = "Error", error_report = toString(e), language = language))
})

##########################################
# Reload data                            #
##########################################

observeEvent(r$reload_%group_id%_%study_id%, {

    # Update dropdowns
    
    options <- convert_tibble_to_list(DBI::dbGetQuery(r$db, "SELECT * FROM modules_elements_options WHERE deleted IS FALSE AND group_id = %group_id% AND study_id = %study_id% AND name = 'r_script_name'"), key_col = "id", text_col = "value")
    shiny.fluent::updateDropdown.shinyInput(session, "Rcode_select_%group_id%_%study_id%", options = options)
    shiny.fluent::updateDropdown.shinyInput(session, "delete_script_%group_id%_%study_id%", options = options)
    
})
```
