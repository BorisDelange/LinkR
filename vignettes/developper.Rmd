---
title: "Developper help"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{dev_data_management}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{css, include = FALSE}
text-align: justify;
```

# App database

# Users

# Data management

## Data sources

A data source can be a data warehouse, a CSV file etc.

### Create a data source

To create a data source, the name must be unique. You can add a short description, which is optional.
The thesaurus are atteched to the data source later, in the thesaurus section.

### Data sources management

You can edit name & description by double-clicking on the field, delete a data source.

## Datamarts

A datamart is a data access to a part of a data warehouse. It is often the screening criteria of a study (eg : all patients who received Meropenem in the ICU unit of my hospital, between 2021-01 & 2021-06).

### Create a datamart

To create a datamart, the name must be unique. You can add a short description, which is optional.
Choose a data source : it links the thesaurus (one thesaurus is attached to one or multiple data source(s)) and the datamart.

### Datamarts management

You can edit name & description by double-clicking on the field, edit data source by changing the value of the dropdown. The other fields cannot be updated. In the action column, you can delete a datamart, edit options or edit code.

### Edit datamart code

Edit a datamart code with the ShinyAce editor.

The code has to be as follows :

```{r eval = FALSE, class.source = "bg-success"}
con <- DBI::dbConnect(RPostgres::Postgres(), dbname = "mimic-iv", host = "localhost",
                      port = 5432, user = "admin", password = "admin")

patients <- function(){
    DBI::dbGetQuery(con, paste0("SELECT * FROM mimic_core.patients LIMIT 10")) %>%
    dplyr::select(patient_id = subject_id, gender, age = anchor_age, dod)
}
create_datamart(r = r, datamart_id = 3, data = patients(), type = "patients", 
                save_as_csv = TRUE, rewrite = FALSE, language = "FR")

DBI::dbDisconnect(con)
```

There's five data variables to create : `patients`, `stays`, `labs_vitals`, `text` and `orders`.

For each data variable, you have to :

- create a function, containing code that allows to get data
- run `create_datamart` function, with the function as `data` argument

The advantage to store the code that allows to get data in a function is that this code is not run each time a user uses the datamart.
If you set the argument `save_as_csv` to TRUE (and `rewrite` to FALSE), then the code is run only the first time the script is excecuted.

See `create_datamart` documentation for more informations (`?create_datamart`).

### Datamart options

You can choose if the users are allowed to see individual patients data, or just aggregated data. It can be useful to have frequent statistics about a group of patients without having to see individual data : eg a weekly updated datamart with bed occupancy of a hospital unit.

You have to choose which users will have access to this datamart.

## Studies

A study is a project using a datamart. One datamart can contains several studies. Each study contains all patients of the datamart.

### Create a study

To create a study, the name must be unique. You can add a short description, which is optional.
You have to choose the datamart, from which the data comes.
You have to choose a patient-level data module family & an aggregated data module family.

The page Patient-level data allows a user to have access to individual patient data. This page works with modules, which are subpages created by a user.
In a module, a user chooses which items of the thesaurus will be displayed (eg Heart rate & Respiratory rate), in which form (eg in a timeline).
These modules are grouped under module families, so that a module created by one user can be re-used by others (eg MIMIC-IV default module family).

The page Aggregated data allows a user to have access to patients grouped data. This pages also works with modules, with the same principle as Patient-level data.

### Studies management

You can edit name & description by double-clicking on the field, edit datamart, patient-level data module family & aggregated data module-family by modifying the value of the dropdown.
You can delete a study, edit its options.

### Study options

You can choose who has access to a study. 

## Subsets

A subset is a set of patients picked in a study. All patients, included & excluded patients subsets are created by default and are not deletable.

### Create a subset

To create a study, the name must be unique. You can add a short description, which is optional.
You have to choose a study, from which the patients comes.

### Subsets management

You can edit name & description by double-clicking on the field, edit study by modifying the value of the dropdown.
You can delete a subset (except All / Included / Excluded patients subsets), edit options : add or delete patients from the subset.

## Thesaurus

A thesaurus contains concepts used in the data warehouse (eg heart rate, respiratory rate, medication etc).

### Create a thesaurus

To create a thesaurus, the name must be unique. You can add a short description, which is optional.
You need to choose one or several data sources, to which the thesaurus will be linked.

### Thesaurus management

You can edit name & description by double-clicking on the field, edit data source by modifying the value of the dropdown.
You can delete a thesaurus, edit options or edit code.

### Edit thesaurus code

### Thesaurus options

# Modules & plugins

## Plugins

## Modules

# Log